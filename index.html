<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>AniCode Pro</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  /* LIGHT THEME */
  --bg:#f4f4f8; --bg2:#ffffff; --surface:#ffffff; --surface2:#f0f0f5;
  --border:#e0dff0; --text:#1a1a2e; --muted:#6b6890;
  --rose1:#bb7a7a; --rose2:#d45c5c; --rose3:#f2a2a2;
  --purple1:#351c75; --purple2:#6a329f; --purple3:#7c5cbf; --purple4:#d3bce8;
  --grad-rose:linear-gradient(135deg,#bb7a7a,#f2a2a2);
  --grad-purple:linear-gradient(135deg,#351c75,#6a329f,#b4a7d6);
  --grad-mix:linear-gradient(135deg,#6a329f,#e39191);
  --grad-soft:linear-gradient(135deg,#6a329f,#bb7a7a);
  --success:#2a7a4a; --success-bg:#e6f7ed; --warning:#9a6800; --warning-bg:#fff8e6; --danger:#d45c5c;
  --fs-xs:11px; --fs-sm:13px; --fs-md:15px; --fs-lg:17px;
  --shadow:0 2px 12px rgba(53,28,117,.08); --shadow-lg:0 8px 32px rgba(53,28,117,.12);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html{height:100%;}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;font-size:var(--fs-sm);}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 80% 50% at 20% 0%,rgba(106,50,159,.06),transparent 60%),radial-gradient(ellipse 60% 40% at 80% 100%,rgba(187,122,122,.04),transparent 50%);pointer-events:none;z-index:0;}
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:var(--bg);}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}

/* Reportes: oculto por defecto, visible solo para admin y leader */
#tab-rep { display: none; }
body[data-role="admin"] #tab-rep,
body[data-role="leader"] #tab-rep { display: block; }
/* L√≠der: sin acceso a entrada/salida */
body[data-role="leader"] #mode-row { display: none !important; }
body[data-role="leader"] #step-bar { display: none !important; }

/* NOTIF BELL ‚Äî visible para admin y leader */
#notif-bell-wrap { display: none; }
body[data-role="admin"] #notif-bell-wrap { display: flex; }
body[data-role="leader"] #notif-bell-wrap { display: flex; }

.login-screen{position:fixed;inset:0;z-index:200;display:flex;align-items:center;justify-content:center;background:var(--bg);padding:16px;}
.login-screen.hidden{display:none;}
.login-box{background:var(--surface);border:1px solid var(--border);border-radius:24px;padding:36px 28px;width:100%;max-width:400px;box-shadow:var(--shadow-lg);}
.login-logo{display:flex;align-items:center;gap:14px;margin-bottom:30px;}
.login-icon{width:56px;height:56px;background:var(--grad-purple);border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:28px;flex-shrink:0;box-shadow:0 8px 24px rgba(106,50,159,.3);}
.login-logo h1{font-size:22px;font-weight:700;background:var(--grad-soft);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.login-logo span{font-size:12px;color:var(--muted);display:block;margin-top:2px;}
.lf{margin-bottom:16px;}
.ll{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.7px;font-weight:600;display:block;margin-bottom:6px;}
.li{width:100%;background:var(--bg);border:1.5px solid var(--border);border-radius:10px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:14px;padding:13px 14px;outline:none;transition:all .2s;}
.li:focus{border-color:var(--purple2);box-shadow:0 0 0 3px rgba(106,50,159,.1);}
.login-btn{width:100%;padding:15px;background:var(--grad-purple);border:none;border-radius:10px;color:#fff;font-family:'DM Sans',sans-serif;font-size:15px;font-weight:700;cursor:pointer;margin-top:8px;transition:all .2s;}
.login-btn:hover{transform:translateY(-1px);box-shadow:0 8px 24px rgba(106,50,159,.35);}
.login-err{background:rgba(212,92,92,.08);border:1px solid rgba(212,92,92,.25);color:var(--rose2);border-radius:8px;padding:11px 14px;font-size:13px;margin-top:12px;display:none;}
.login-err.vis{display:block;}
.url-sec{margin-top:20px;padding-top:16px;border-top:1px solid var(--border);}
.url-lbl{font-size:12px;color:var(--muted);margin-bottom:7px;display:block;}
.url-row{display:flex;gap:7px;}
.url-inp{flex:1;background:var(--bg);border:1.5px solid var(--border);border-radius:8px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:11px;padding:9px 11px;outline:none;transition:border-color .2s;}
.url-inp:focus{border-color:var(--purple2);}
.url-inp.ok{border-color:var(--success);}
.url-btn{background:var(--surface2);border:1.5px solid var(--border);border-radius:8px;color:var(--text);font-size:12px;font-weight:600;padding:9px 14px;cursor:pointer;white-space:nowrap;transition:all .2s;}
.url-btn:hover{border-color:var(--purple3);color:var(--purple3);}

/* ‚îÄ‚îÄ‚îÄ APP ‚îÄ‚îÄ‚îÄ */
.app{position:relative;z-index:1;max-width:1100px;margin:0 auto;padding:14px;}
.app.hidden{display:none;}

/* TOPBAR */
.topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:12px 16px;gap:10px;flex-wrap:wrap;box-shadow:var(--shadow);}
.tb-left{display:flex;align-items:center;gap:11px;}
.tb-icon{width:40px;height:40px;background:var(--grad-purple);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;}
.tb-title{font-size:15px;font-weight:700;background:var(--grad-soft);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.tb-sub{font-size:12px;color:var(--muted);}
.tb-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
.stats-row{display:flex;gap:14px;}
.stat-i{text-align:center;}
.stat-n{font-family:'JetBrains Mono',monospace;font-size:18px;font-weight:700;}
.stat-n.gn{color:var(--success);}
.stat-n.rd{color:var(--rose2);}
.stat-n.pu{color:var(--purple3);}
.stat-l{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;}
.user-chip{display:flex;align-items:center;gap:6px;padding:6px 12px;border-radius:20px;font-size:12px;font-weight:600;border:1.5px solid var(--border);background:var(--surface2);}
.user-chip.admin{border-color:rgba(124,92,191,.4);color:var(--purple3);}
.user-chip.store{border-color:rgba(212,92,92,.3);color:var(--rose2);}
.btn-logout{background:none;border:1.5px solid var(--border);border-radius:8px;color:var(--muted);font-size:12px;font-weight:600;padding:6px 12px;cursor:pointer;transition:all .2s;}
.btn-logout:hover{border-color:var(--rose2);color:var(--rose2);}

/* ‚îÄ‚îÄ‚îÄ NOTIF BELL ‚îÄ‚îÄ‚îÄ */
#notif-bell-wrap{position:relative;align-items:center;justify-content:center;}
.notif-bell-btn{position:relative;width:38px;height:38px;border-radius:10px;border:1.5px solid var(--border);background:var(--surface2);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px;transition:all .2s;flex-shrink:0;}
.notif-bell-btn:hover{border-color:var(--purple3);background:rgba(124,92,191,.08);}
.notif-bell-btn.has-notif{border-color:rgba(124,92,191,.5);background:rgba(124,92,191,.08);}
.notif-bell-btn.has-notif .bell-icon{animation:bellRing .5s ease-in-out;}
@keyframes bellRing{0%,100%{transform:rotate(0)}20%{transform:rotate(-12deg)}40%{transform:rotate(12deg)}60%{transform:rotate(-8deg)}80%{transform:rotate(8deg)}}
.notif-badge{position:absolute;top:-4px;right:-4px;min-width:18px;height:18px;background:linear-gradient(135deg,#d45c5c,#f2a2a2);border-radius:9px;font-size:10px;font-weight:700;color:#fff;display:flex;align-items:center;justify-content:center;padding:0 4px;border:2px solid var(--surface);animation:badgePop .3s cubic-bezier(.34,1.56,.64,1);}
@keyframes badgePop{from{transform:scale(0)}to{transform:scale(1)}}
.notif-badge.hidden{display:none;}
/* NOTIF DROPDOWN */
.notif-dropdown{position:absolute;top:calc(100% + 8px);right:0;width:340px;background:var(--surface);border:1.5px solid var(--border);border-radius:16px;box-shadow:var(--shadow-lg);z-index:500;overflow:hidden;display:none;animation:dropIn .2s ease;}
@keyframes dropIn{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}
.notif-dropdown.open{display:block;}
.nd-header{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:var(--surface2);}
.nd-title{font-size:13px;font-weight:700;color:var(--text);}
.nd-clear{font-size:11px;color:var(--muted);cursor:pointer;background:none;border:none;padding:4px 8px;border-radius:6px;transition:all .2s;}
.nd-clear:hover{background:rgba(212,92,92,.1);color:var(--rose2);}
.nd-list{max-height:320px;overflow-y:auto;}
.nd-empty{padding:28px;text-align:center;color:var(--muted);font-size:13px;}
.nd-empty .big{font-size:28px;margin-bottom:8px;opacity:.3;}
.nd-item{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:flex-start;gap:10px;transition:background .15s;cursor:default;}
.nd-item:last-child{border-bottom:none;}
.nd-item:hover{background:var(--surface2);}
.nd-item.unread{background:rgba(124,92,191,.04);}
.nd-item.unread::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--purple3);border-radius:0 2px 2px 0;}
.nd-item{position:relative;}
.nd-ico{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0;}
.nd-ico.entrada{background:rgba(42,122,74,.1);}
.nd-ico.salida{background:rgba(212,92,92,.1);}
.nd-body{flex:1;min-width:0;}
.nd-store{font-size:12px;font-weight:700;color:var(--purple3);margin-bottom:2px;}
.nd-desc{font-size:12px;color:var(--text);line-height:1.4;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.nd-time{font-size:10px;color:var(--muted);margin-top:3px;}

/* MODE TOGGLE */
.mode-toggle{display:grid;grid-template-columns:1fr 1fr;margin-bottom:12px;border-radius:14px;overflow:hidden;border:1.5px solid var(--border);background:var(--surface);box-shadow:var(--shadow);}
.mode-btn{padding:15px;text-align:center;cursor:pointer;font-size:15px;font-weight:700;transition:all .3s;border:none;background:transparent;color:var(--muted);display:flex;align-items:center;justify-content:center;gap:8px;}
.mode-btn.ae{background:linear-gradient(135deg,rgba(42,122,74,.1),rgba(42,122,74,.04));color:var(--success);border-bottom:3px solid var(--success);}
.mode-btn.ax{background:linear-gradient(135deg,rgba(212,92,92,.12),rgba(187,122,122,.06));color:var(--rose2);border-bottom:3px solid var(--rose2);}

/* STEP BAR */
.step-bar{display:flex;align-items:center;margin-bottom:12px;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:12px 14px;gap:4px;box-shadow:var(--shadow);}
.step-bar.hidden{display:none;}
.stp{display:flex;align-items:center;gap:8px;flex:1;min-width:0;}
.stp-num{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;border:2px solid var(--border);color:var(--muted);transition:all .3s;flex-shrink:0;}
.stp.active .stp-num{border-color:var(--purple3);color:var(--purple3);background:rgba(124,92,191,.08);}
.stp.done .stp-num{border-color:var(--success);color:#fff;background:var(--success);}
.stp-lbl{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;}
.stp-val{font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:600;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.stp.done .stp-val{color:var(--success);}
.stp.active .stp-val{color:var(--purple3);}
.stp-div{width:12px;height:2px;background:var(--border);flex-shrink:0;border-radius:1px;}
.stp-div.done{background:var(--success);}

/* MAIN GRID */
.main-grid{display:grid;grid-template-columns:320px 1fr;gap:12px;align-items:start;}
@media(max-width:760px){.main-grid{grid-template-columns:1fr;}}

/* PANEL */
.panel{background:var(--surface);border:1px solid var(--border);border-radius:16px;overflow:hidden;margin-bottom:12px;box-shadow:var(--shadow);}
.panel:last-child{margin-bottom:0;}
.ph{background:var(--surface);}
.ph-title{font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.7px;color:var(--muted);display:flex;align-items:center;gap:8px;}
.led{width:8px;height:8px;border-radius:50%;background:var(--border);}
.led.on{background:var(--success);box-shadow:0 0 8px var(--success);animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

/* SCANNER */
/* ‚îÄ‚îÄ ESC√ÅNER REDISE√ëADO ‚îÄ‚îÄ */
.sc-body{padding:12px 14px 14px;}
#scanner-container{
  position:relative;
  width:100%;
  height:200px;         /* altura fija ‚Äî compacto */
  border-radius:14px;
  overflow:hidden;
  background:#0a0a0a;
  border:1.5px solid var(--border);
  transition:border-color .3s, box-shadow .3s;
}
#scanner-container.fe{border-color:var(--success);box-shadow:0 0 20px rgba(42,122,74,.25);}
#scanner-container.fx{border-color:var(--rose2);box-shadow:0 0 20px rgba(212,92,92,.25);}
#scanner-container video,#scanner-container canvas.drawingBuffer{
  position:absolute;inset:0;width:100%;height:100%;object-fit:cover;
}
#scanner-container canvas.drawingBuffer{opacity:0;}

/* Overlay oscuro con ventana central */
.sc-overlay{position:absolute;inset:0;pointer-events:none;}
.sc-dark-top,.sc-dark-bot,.sc-dark-l,.sc-dark-r{
  position:absolute;background:rgba(0,0,0,.58);
}
/* Ventana de escaneo: 76% ancho, 52% alto, centrada */
.sc-dark-top{top:0;left:0;right:0;height:24%;}
.sc-dark-bot{bottom:0;left:0;right:0;height:24%;}
.sc-dark-l{top:24%;bottom:24%;left:0;width:12%;}
.sc-dark-r{top:24%;bottom:24%;right:0;width:12%;}

/* Marco de escaneo */
.sc-window{
  position:absolute;
  top:24%;left:12%;right:12%;bottom:24%;
  border-radius:4px;
}
/* L√≠nea animada de barrido */
.sc-line{
  position:absolute;left:0;right:0;height:2px;
  animation:sl 1.6s ease-in-out infinite;
  border-radius:1px;
}
.sc-line.fe{background:linear-gradient(90deg,transparent 0%,var(--success) 50%,transparent 100%);}
.sc-line.fx{background:linear-gradient(90deg,transparent 0%,var(--rose2) 50%,transparent 100%);}
@keyframes sl{0%{top:2px;opacity:.9}100%{top:calc(100% - 4px);opacity:.2}}

/* Esquinas del marco */
.corner{position:absolute;width:16px;height:16px;}
.tl{top:0;left:0;}.tr{top:0;right:0;}.bl{bottom:0;left:0;}.br{bottom:0;right:0;}
.ce.tl,.ce.tr,.ce.bl,.ce.br{border-color:var(--success);}
.cx.tl,.cx.tr,.cx.bl,.cx.br{border-color:var(--rose2);}
.ce.tl,.cx.tl{border-top:2.5px solid;border-left:2.5px solid;border-radius:4px 0 0 0;}
.ce.tr,.cx.tr{border-top:2.5px solid;border-right:2.5px solid;border-radius:0 4px 0 0;}
.ce.bl,.cx.bl{border-bottom:2.5px solid;border-left:2.5px solid;border-radius:0 0 0 4px;}
.ce.br,.cx.br{border-bottom:2.5px solid;border-right:2.5px solid;border-radius:0 0 4px 0;}

/* Hint dentro del marco */
.sc-hint{
  position:absolute;bottom:-20px;left:0;right:0;
  text-align:center;font-size:10px;font-weight:600;
  letter-spacing:.3px;opacity:.85;
}
.sc-hint.fe{color:var(--success);}
.sc-hint.fx{color:var(--rose2);}

/* Badge de modo */
.sc-badge{
  position:absolute;top:8px;left:8px;z-index:10;
  padding:4px 10px;border-radius:20px;
  font-size:10px;font-weight:700;
  font-family:'JetBrains Mono',monospace;
  backdrop-filter:blur(10px);
}
.bi1{background:rgba(124,92,191,.3);color:#c4b0ff;border:1px solid rgba(124,92,191,.5);}
.bi2{background:rgba(180,167,214,.25);color:#b0a0e8;border:1px solid rgba(180,167,214,.4);}
.bi3{background:rgba(42,122,74,.3);color:#80e0a0;border:1px solid rgba(42,122,74,.5);}
.bix{background:rgba(212,92,92,.3);color:#ffb0b0;border:1px solid rgba(212,92,92,.5);}

/* Placeholder cuando c√°mara inactiva */
.ph-placeholder{
  position:absolute;inset:0;display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  color:rgba(255,255,255,.35);gap:8px;
}
.ph-placeholder .big{font-size:30px;opacity:.5;}
.ph-placeholder p{font-size:12px;text-align:center;line-height:1.5;max-width:160px;}

/* Barra de confianza */
.conf-wrap{margin-top:8px;}
.conf-lbl{display:flex;justify-content:space-between;font-size:10px;color:var(--muted);margin-bottom:3px;}
.conf-bar{height:3px;background:var(--border);border-radius:2px;overflow:hidden;}
.conf-fill{height:100%;border-radius:2px;transition:width .15s,background .2s;}

/* Lectura actual */
.cur-read{
  margin-top:8px;padding:8px 12px;border-radius:9px;
  background:var(--surface2);border:1px solid var(--border);
  display:none;align-items:center;justify-content:space-between;gap:8px;
}
.cr-l{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.4px;flex-shrink:0;}
.cr-v{font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:700;text-align:right;overflow:hidden;text-overflow:ellipsis;}
.cr-v.vld{color:var(--warning);animation:blink .6s infinite;}
.cr-v.oke{color:var(--success);}
.cr-v.okx{color:var(--rose2);}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.25}}

/* EXIT RESULT CARD */
.exit-result{margin-top:12px;padding:14px;border-radius:12px;background:var(--surface2);border:1px solid var(--border);display:none;}
.exit-result.vis{display:block;animation:fu .3s ease;}
@keyframes fu{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}
.exit-result img{width:100%;height:90px;object-fit:cover;border-radius:8px;margin-bottom:9px;}
.er-name{font-size:15px;font-weight:700;margin-bottom:4px;}
.er-imei{font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--purple3);margin-bottom:5px;}
.er-detail{font-size:12px;color:var(--muted);}
.exit-result.nf{border-color:rgba(212,92,92,.3);background:rgba(212,92,92,.04);}
.exit-result.nf .er-name{color:var(--rose2);}
.exit-result.ao{border-color:rgba(232,200,130,.3);background:rgba(232,200,130,.04);}
.exit-result.ao .er-name{color:var(--warning);}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;gap:7px;padding:11px 16px;border-radius:10px;border:none;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:700;transition:all .2s;white-space:nowrap;}
.btn-entry{background:linear-gradient(135deg,#2a7a4a,#4caf7d);color:#fff;}
.btn-entry:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(42,122,74,.3);}
.btn-exit-c{background:var(--grad-rose);color:#fff;}
.btn-exit-c:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(212,92,92,.3);}
.btn-primary{background:var(--grad-purple);color:#fff;}
.btn-primary:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(106,50,159,.3);}
.btn-outline{background:transparent;border:1.5px solid var(--border);color:var(--text);}
.btn-outline:hover{border-color:var(--purple3);color:var(--purple3);}
.btn-danger{background:rgba(212,92,92,.08);border:1.5px solid rgba(212,92,92,.25);color:var(--rose2);}
.btn-success{background:rgba(42,122,74,.08);border:1.5px solid rgba(42,122,74,.25);color:var(--success);}
.btn-warn{background:rgba(154,104,0,.08);border:1.5px solid rgba(154,104,0,.25);color:var(--warning);}
.btn:disabled{opacity:.35;cursor:not-allowed;transform:none!important;}
.sc-ctrls{display:flex;gap:8px;margin-top:10px;}
.sc-ctrls .btn{flex:1;justify-content:center;padding:10px 12px;}

/* PLATFORM */


/* FORM */
.fsec{padding:14px 16px;border-top:1px solid var(--border);}
.fg{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px;}
.fg .full{grid-column:1/-1;}
.fl{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;font-weight:600;display:block;margin-bottom:5px;}
.fc-ok{border-color:rgba(42,122,74,.5)!important;background:rgba(42,122,74,.03)!important;}
input[type=text],input[type=number],select,textarea{
  background:var(--bg);border:1.5px solid var(--border);border-radius:9px;
  color:var(--text);font-family:'JetBrains Mono',monospace;font-size:13px;
  padding:10px 12px;width:100%;outline:none;transition:all .2s;
}
textarea{resize:none;height:52px;font-family:'DM Sans',sans-serif;font-size:13px;}
input:focus,select:focus,textarea:focus{border-color:var(--purple2);box-shadow:0 0 0 3px rgba(106,50,159,.08);}
select option{background:var(--surface);color:var(--text);}
select:disabled{opacity:.4;}
.color-row{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px;}
.csw{width:22px;height:22px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:all .2s;flex-shrink:0;}
.csw:hover{transform:scale(1.15);}
.csw.sel{border-color:var(--purple3);box-shadow:0 0 0 2px var(--bg),0 0 0 4px var(--purple3);}
.photo-prev{width:100%;height:100px;border-radius:10px;background:var(--bg);border:2px dashed var(--border);display:flex;align-items:center;justify-content:center;overflow:hidden;position:relative;cursor:pointer;transition:border-color .2s;}
.photo-prev:hover{border-color:var(--purple3);}
.photo-prev img{width:100%;height:100%;object-fit:cover;}
.no-photo{text-align:center;color:var(--muted);font-size:12px;pointer-events:none;}
.no-photo .ic{font-size:26px;margin-bottom:4px;opacity:.4;}
.photo-rm{position:absolute;top:6px;right:6px;background:rgba(212,92,92,.9);border:none;border-radius:50%;width:22px;height:22px;color:#fff;cursor:pointer;font-size:12px;align-items:center;justify-content:center;z-index:5;display:none;}
.photo-prev:hover .photo-rm.hp{display:flex;}
.photo-ctrls{display:flex;gap:8px;margin-top:8px;}
input[type=file]{display:none;}
.feedback{margin-top:10px;padding:10px 12px;border-radius:9px;font-size:12px;display:none;align-items:center;gap:8px;font-weight:500;}
.feedback.success{background:var(--success-bg);border:1px solid rgba(42,122,74,.25);color:var(--success);display:flex;}
.feedback.error{background:rgba(212,92,92,.08);border:1px solid rgba(212,92,92,.25);color:var(--rose2);display:flex;}
.feedback.pending{background:var(--warning-bg);border:1px solid rgba(154,104,0,.25);color:var(--warning);display:flex;}

/* ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ */
#toast-container{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:9999;display:flex;flex-direction:column;align-items:center;gap:10px;pointer-events:none;width:90%;max-width:420px;}
.toast{width:100%;padding:18px 24px;border-radius:18px;font-size:15px;font-weight:700;text-align:center;display:flex;align-items:center;justify-content:center;gap:10px;letter-spacing:.2px;pointer-events:auto;backdrop-filter:blur(16px);box-shadow:0 16px 50px rgba(0,0,0,.18);animation:toastIn .3s cubic-bezier(.34,1.56,.64,1) forwards;}
@keyframes toastIn{from{opacity:0;transform:scale(.82)}to{opacity:1;transform:scale(1)}}
.toast.t-success{background:linear-gradient(135deg,rgba(230,247,237,.98),rgba(240,253,244,.98));border:1.5px solid rgba(42,122,74,.35);color:#1a5c35;}
.toast.t-error{background:linear-gradient(135deg,rgba(253,240,240,.98),rgba(255,245,245,.98));border:1.5px solid rgba(212,92,92,.35);color:#9a2a2a;}
.toast.t-pending{background:linear-gradient(135deg,rgba(255,248,230,.98),rgba(255,252,240,.98));border:1.5px solid rgba(154,104,0,.35);color:#7a5200;}
.toast.t-info{background:linear-gradient(135deg,rgba(240,236,252,.98),rgba(248,244,255,.98));border:1.5px solid rgba(124,92,191,.35);color:#4a2a8a;}
.toast.t-notif{background:linear-gradient(135deg,rgba(240,236,252,.98),rgba(248,244,255,.98));border:2px solid rgba(124,92,191,.5);color:#4a2a8a;font-size:14px;}

.sync-pill{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:20px;font-size:11px;font-weight:600;}
.sp-idle{background:var(--surface2);color:var(--muted);border:1px solid var(--border);}
.sp-send{background:var(--warning-bg);color:var(--warning);border:1px solid rgba(154,104,0,.25);}
.sp-ok{background:var(--success-bg);color:var(--success);border:1px solid rgba(42,122,74,.25);}
.sp-err{background:rgba(212,92,92,.08);color:var(--rose2);border:1px solid rgba(212,92,92,.25);}
.spin{display:inline-block;animation:spin 1s linear infinite;}
@keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}

/* TABLE */
/* ‚îÄ‚îÄ BARRA 1: tabs ‚îÄ‚îÄ */
.table-tabs{display:flex;gap:0;width:100%;}
.tab-btn{
  flex:1;
  padding:12px 4px 10px;
  font-size:12px;
  font-weight:700;
  cursor:pointer;
  border:none;
  background:transparent;
  color:var(--muted);
  transition:all .2s;
  border-bottom:2.5px solid transparent;
  white-space:nowrap;
  text-align:center;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:3px;
}
.tab-btn .tab-ico{font-size:18px;line-height:1;}
.tab-btn .tab-lbl{font-size:10px;letter-spacing:.3px;text-transform:uppercase;}
.tab-btn.active{color:var(--purple3);border-bottom-color:var(--purple3);background:rgba(124,92,191,.05);}
/* ‚îÄ‚îÄ BARRA 2: acciones icon-buttons ‚îÄ‚îÄ */
.actions-bar{
  display:flex;
  align-items:center;
  gap:6px;
  padding:7px 12px;
  background:var(--surface2);
  border-bottom:1px solid var(--border);
}
.act-btn{
  display:flex;align-items:center;gap:5px;
  padding:7px 11px;border-radius:9px;
  font-size:12px;font-weight:600;cursor:pointer;
  border:1px solid var(--border);
  background:var(--surface);
  color:var(--text);
  transition:all .2s;white-space:nowrap;
  flex-shrink:0;
}
.act-btn:hover{border-color:var(--purple3);color:var(--purple3);background:rgba(124,92,191,.04);}
.act-btn.primary{background:var(--purple2);border-color:var(--purple2);color:#fff;}
.act-btn.primary:hover{background:var(--purple1);border-color:var(--purple1);}
.act-btn.success{background:var(--success);border-color:var(--success);color:#fff;}
.act-btn.success:hover{opacity:.85;}
.act-btn.danger{background:rgba(212,92,92,.08);border-color:rgba(212,92,92,.25);color:var(--rose2);}
.act-btn.danger:hover{background:rgba(212,92,92,.15);}
.act-spacer{flex:1;}
/* En m√≥vil: ocultar labels de acciones, solo iconos */
@media(max-width:480px){
  .act-lbl{display:none;}
  .act-btn{padding:8px 10px;}
}
.tbl-wrap{overflow-x:auto;max-height:460px;overflow-y:auto;}
table{width:100%;border-collapse:collapse;}
thead{background:var(--surface2);position:sticky;top:0;z-index:2;}
th{padding:9px 10px;text-align:left;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.7px;color:var(--muted);white-space:nowrap;border-bottom:1px solid var(--border);}
td{padding:9px 10px;border-bottom:1px solid var(--border);font-size:12px;vertical-align:middle;}
tr:hover td{background:rgba(124,92,191,.02);}
tr.nr td{animation:rowIn .5s ease;}
@keyframes rowIn{from{background:rgba(124,92,191,.08)}to{background:transparent}}
.imei-c{font-family:'JetBrains Mono',monospace;color:var(--purple3);font-size:11px;}
.badge-in{background:rgba(42,122,74,.1);color:var(--success);border:1px solid rgba(42,122,74,.25);padding:3px 8px;border-radius:5px;font-size:10px;font-weight:700;white-space:nowrap;}
.badge-out{background:rgba(212,92,92,.1);color:var(--rose2);border:1px solid rgba(212,92,92,.25);padding:3px 8px;border-radius:5px;font-size:10px;font-weight:700;white-space:nowrap;}
.st-nuevo{background:rgba(42,122,74,.1);color:var(--success);border:1px solid rgba(42,122,74,.2);padding:3px 8px;border-radius:5px;font-size:10px;font-weight:700;white-space:nowrap;}
.st-semi{background:rgba(53,130,220,.1);color:#3585dc;border:1px solid rgba(53,130,220,.2);padding:3px 8px;border-radius:5px;font-size:10px;font-weight:700;white-space:nowrap;}
.st-reac{background:rgba(154,104,0,.1);color:var(--warning);border:1px solid rgba(154,104,0,.2);padding:3px 8px;border-radius:5px;font-size:10px;font-weight:700;white-space:nowrap;}
.st-rep{background:rgba(212,92,92,.1);color:var(--rose2);border:1px solid rgba(212,92,92,.2);padding:3px 8px;border-radius:5px;font-size:10px;font-weight:700;white-space:nowrap;}
.st-otro{background:rgba(124,92,191,.1);color:var(--purple3);border:1px solid rgba(124,92,191,.2);padding:3px 8px;border-radius:5px;font-size:10px;font-weight:700;white-space:nowrap;}
.s1{color:var(--success);font-weight:700;font-size:12px;}
.s0{color:var(--rose2);font-weight:700;font-size:12px;}
.pt{width:32px;height:32px;border-radius:6px;object-fit:cover;border:1px solid var(--border);}
.store-tag{display:inline-block;padding:3px 8px;border-radius:5px;font-size:10px;font-weight:700;background:rgba(124,92,191,.08);color:var(--purple3);border:1px solid rgba(124,92,191,.2);}
.del-btn{background:rgba(212,92,92,.07);border:1px solid rgba(212,92,92,.2);border-radius:6px;color:var(--rose2);cursor:pointer;padding:4px 8px;font-size:11px;font-weight:600;transition:all .2s;}
.del-btn:hover{background:rgba(212,92,92,.15);}
.empty-state{padding:36px;text-align:center;color:var(--muted);}
.empty-state .big{font-size:32px;margin-bottom:8px;opacity:.25;}
.empty-state p{font-size:13px;}
/* .tbl-actions replaced by .actions-bar */
.queue-bar{background:var(--warning-bg);border-top:1px solid rgba(154,104,0,.2);padding:9px 16px;display:flex;align-items:center;justify-content:space-between;font-size:12px;color:var(--warning);}
.queue-bar.hidden{display:none;}
.filter-row{padding:10px 14px;border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:center;flex-wrap:wrap;background:var(--surface2);}
.filter-row select{width:auto;flex:1;min-width:110px;padding:7px 10px;font-size:12px;}
.search-bar{display:flex;align-items:center;gap:0;background:var(--surface);border:1.5px solid var(--border);border-radius:10px;overflow:hidden;transition:border-color .2s;margin:10px 14px 0;}
.search-bar:focus-within{border-color:var(--purple3);}
.search-bar-ico{padding:0 10px;color:var(--muted);font-size:15px;flex-shrink:0;}
.search-bar input{flex:1;border:none;background:transparent;padding:9px 4px;font-size:13px;color:var(--text);outline:none;font-family:'DM Sans',sans-serif;}
.search-bar input::placeholder{color:var(--muted);}
.search-bar-clear{padding:0 10px;background:none;border:none;color:var(--muted);cursor:pointer;font-size:16px;flex-shrink:0;line-height:1;}
.search-bar-clear:hover{color:var(--rose2);}
.search-count{font-size:11px;color:var(--muted);padding:4px 14px 8px;font-style:italic;}

/* ‚îÄ‚îÄ GESTI√ìN DE USUARIOS ‚îÄ‚îÄ */
.users-table{width:100%;border-collapse:collapse;font-size:13px;}
.users-table th{padding:9px 12px;background:var(--surface2);color:var(--muted);font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;text-align:left;border-bottom:1px solid var(--border);}
.users-table td{padding:10px 12px;border-bottom:1px solid var(--border);vertical-align:middle;}
.users-table tr:hover td{background:rgba(124,92,191,.02);}
.role-badge{display:inline-block;padding:3px 9px;border-radius:5px;font-size:10px;font-weight:700;}
.role-badge.admin{background:rgba(53,28,117,.1);color:var(--purple1);}
.role-badge.store{background:rgba(42,122,74,.1);color:var(--success);}
.role-badge.leader{background:rgba(154,104,0,.1);color:var(--warning);}
.edit-field{width:100%;border:1.5px solid var(--border);border-radius:7px;padding:7px 10px;font-size:12px;font-family:'DM Sans',sans-serif;background:var(--surface);color:var(--text);transition:border-color .2s;}
.edit-field:focus{outline:none;border-color:var(--purple3);}
.save-user-btn{background:var(--grad-purple);border:none;border-radius:7px;color:#fff;padding:6px 14px;font-size:12px;font-weight:700;cursor:pointer;white-space:nowrap;}
.save-user-btn:disabled{opacity:.4;cursor:not-allowed;}
.log-row{font-size:11px;padding:7px 10px;border-bottom:1px solid var(--border);display:grid;grid-template-columns:auto 1fr auto;gap:8px;align-items:start;}
.log-row:last-child{border-bottom:none;}
.log-ts{color:var(--muted);white-space:nowrap;font-family:'JetBrains Mono',monospace;}
.log-msg{color:var(--text);}
.log-who{color:var(--purple3);font-weight:700;white-space:nowrap;}

/* REPORTS */
.rep-wrap{padding:16px;}
.rep-section-title{font-size:12px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.6px;margin-bottom:12px;display:flex;align-items:center;gap:8px;}
.rep-section-title::after{content:'';flex:1;height:1px;background:var(--border);}
.rep-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px;margin-bottom:20px;}
.stat-card{background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:16px;text-align:center;transition:border-color .2s,box-shadow .2s;}
.stat-card:hover{border-color:var(--purple3);box-shadow:var(--shadow);}
.sc-val{font-size:30px;font-weight:700;font-family:'JetBrains Mono',monospace;margin-bottom:5px;}
.sc-lbl{font-size:12px;color:var(--muted);}
.store-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px;}
.store-card{background:var(--surface2);border:1px solid var(--border);border-radius:14px;padding:16px;transition:border-color .2s,box-shadow .2s;}
.store-card:hover{border-color:var(--purple2);box-shadow:var(--shadow);}
.store-card-name{font-size:14px;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:7px;}
.store-stats{display:grid;grid-template-columns:1fr 1fr;gap:7px;}
.ss-item{text-align:center;padding:10px 6px;border-radius:9px;}
.ss-n{font-size:22px;font-weight:700;font-family:'JetBrains Mono',monospace;}
.ss-l{font-size:10px;color:var(--muted);margin-top:3px;text-transform:uppercase;letter-spacing:.4px;}
/* Money value in reports */
.store-money-row{margin-top:10px;padding:10px 12px;border-radius:9px;background:linear-gradient(135deg,rgba(124,92,191,.06),rgba(106,50,159,.03));border:1px solid rgba(124,92,191,.15);display:flex;align-items:center;justify-content:space-between;}
.store-money-lbl{font-size:11px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:.4px;}
.store-money-val{font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:700;color:var(--purple3);}
.global-money-card{background:linear-gradient(135deg,rgba(124,92,191,.08),rgba(106,50,159,.04));border:1.5px solid rgba(124,92,191,.2);border-radius:12px;padding:16px;text-align:center;margin-bottom:20px;}
.global-money-val{font-family:'JetBrains Mono',monospace;font-size:32px;font-weight:700;color:var(--purple3);margin-bottom:4px;}
.global-money-lbl{font-size:12px;color:var(--muted);}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:100;display:none;align-items:center;justify-content:center;backdrop-filter:blur(4px);padding:16px;}
.modal-overlay.open{display:flex;}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:18px;padding:24px;max-width:380px;width:100%;box-shadow:var(--shadow-lg);}
.modal h3{font-size:16px;font-weight:700;margin-bottom:8px;}
.modal p{font-size:13px;color:var(--muted);margin-bottom:18px;line-height:1.6;}
.modal-btns{display:flex;gap:9px;justify-content:flex-end;}

/* MOBILE */
@media(max-width:500px){
  .app{padding:10px;}
  .topbar{padding:10px 12px;}
  .stats-row{gap:10px;}
  .stat-n{font-size:16px;}
  .mode-btn{font-size:14px;padding:13px 8px;}
  .btn{font-size:13px;padding:11px 14px;}
  .fsec{padding:12px 14px;}
  .fg{gap:7px;}
  th{padding:8px 8px;font-size:10px;}
  td{padding:8px 8px;font-size:12px;}
  .rep-grid{grid-template-columns:repeat(2,1fr);}
  .store-grid{grid-template-columns:1fr;}
  .sc-val{font-size:26px;}
  .ss-n{font-size:20px;}
  .notif-dropdown{width:280px;right:-60px;}
}
</style>
</head>
<body>
<div id="toast-container"></div>

<!-- LOGIN -->
<div class="login-screen" id="login-screen">
  <div class="login-box">
    <div class="login-logo">
      <div class="login-icon">üì±</div>
      <div><h1>AniCode Pro</h1><span>Sistema multi-tienda</span></div>
    </div>
    <div class="lf"><label class="ll">Usuario</label><input type="text" class="li" id="login-user" placeholder="admin / tienda1..." autocomplete="username"></div>
    <div class="lf"><label class="ll">Contrase√±a</label><input type="password" class="li" id="login-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" onkeydown="if(event.key==='Enter')doLogin()"></div>
    <button class="login-btn" onclick="doLogin()">Ingresar ‚Üí</button>
    <div class="login-err" id="login-err"></div>
    <div class="url-sec">
      <span class="url-lbl">URL Apps Script (guardar una sola vez)</span>
      <div class="url-row">
        <input type="text" class="url-inp" id="url-inp" placeholder="https://script.google.com/macros/s/.../exec" oninput="onUrlInput()">
        <button class="url-btn" onclick="saveUrl()">Guardar</button>
      </div>
    </div>
  </div>
</div>

<!-- APP -->
<div class="app hidden" id="app">
  <div class="topbar">
    <div class="tb-left">
      <div class="tb-icon">üì±</div>
      <div><div class="tb-title">AniCode Pro</div><div class="tb-sub" id="tb-sub">‚Äî</div></div>
    </div>
    <div class="tb-right">
      <div class="stats-row">
        <div class="stat-i"><div class="stat-n gn" id="cnt-stock">0</div><div class="stat-l">Stock</div></div>
        <div class="stat-i"><div class="stat-n rd" id="cnt-out">0</div><div class="stat-l">Salidas</div></div>
        <div class="stat-i"><div class="stat-n pu" id="cnt-total">0</div><div class="stat-l">Total</div></div>
      </div>

      <!-- NOTIF BELL ‚Äî solo admin -->
      <div id="notif-bell-wrap">
        <button class="notif-bell-btn" id="notif-bell-btn" onclick="toggleNotifDropdown()" title="Notificaciones de movimientos">
          <span class="bell-icon">üîî</span>
          <span class="notif-badge hidden" id="notif-badge">0</span>
        </button>
        <div class="notif-dropdown" id="notif-dropdown">
          <div class="nd-header">
            <span class="nd-title">üîî Notificaciones</span>
            <button class="nd-clear" onclick="clearNotifs()">Limpiar todo</button>
          </div>
          <div class="nd-list" id="nd-list">
            <div class="nd-empty"><div class="big">üîï</div>Sin notificaciones nuevas</div>
          </div>
        </div>
      </div>

      <div class="user-chip" id="user-chip">‚Äî</div>
      <button class="btn-logout" id="btn-users-mgmt" onclick="openUsersModal()" style="display:none;margin-right:4px" title="Gesti√≥n de usuarios">üë•</button>
      <button class="btn-logout" onclick="logout()">Salir</button>
    </div>
  </div>

  <div class="mode-toggle" id="mode-row">
    <button class="mode-btn" id="btn-entry" onclick="setMode('entry')">‚úÖ Entrada</button>
    <button class="mode-btn" id="btn-exit" onclick="setMode('exit')">üî¥ Salida</button>
  </div>

  <div class="step-bar" id="step-bar">
    <div class="stp active" id="stp-1"><div class="stp-num">1</div><div><div class="stp-lbl">IMEI 1</div><div class="stp-val" id="sv1">Esperando...</div></div></div>
    <div class="stp-div" id="sd1"></div>
    <div class="stp" id="stp-2"><div class="stp-num">2</div><div><div class="stp-lbl">IMEI 2</div><div class="stp-val" id="sv2">Esperando...</div></div></div>
    <div class="stp-div" id="sd2"></div>
    <div class="stp" id="stp-3"><div class="stp-num">3</div><div><div class="stp-lbl">Serial</div><div class="stp-val" id="sv3">Esperando...</div></div></div>
  </div>

  <div class="main-grid">
    <div>
      <!-- SCANNER PANEL -->
      <div class="panel">
        <div class="ph">
          <span class="ph-title"><span class="led" id="led"></span>Esc√°ner</span>
          <span class="sync-pill sp-idle" id="sync-pill">‚óè Inactivo</span>
        </div>
        <div class="sc-body">
          <div id="scanner-container">
            <div class="ph-placeholder" id="sc-ph"><div class="big" id="ph-icon">üì∑</div><p id="ph-txt">Activa la c√°mara para escanear</p></div>
          </div>
          <div class="conf-wrap" id="conf-wrap" style="display:none">
            <div class="conf-lbl"><span id="conf-lbl">Confianza</span><span id="conf-pct">0%</span></div>
            <div class="conf-bar"><div class="conf-fill" id="conf-fill" style="width:0%"></div></div>
          </div>
          <div class="cur-read" id="cur-read"><span class="cr-l" id="cr-l">Leyendo</span><span class="cr-v" id="cr-v">‚Äî</span></div>
          <div class="exit-result" id="exit-result">
            <img id="er-photo" style="display:none">
            <div class="er-name" id="er-name">‚Äî</div>
            <div class="er-imei" id="er-imei">‚Äî</div>
            <div class="er-detail" id="er-detail">‚Äî</div>
          </div>
          <div class="sc-ctrls">
            <button class="btn btn-primary" id="start-btn" onclick="startScanner()">‚ñ∂ Activar</button>
            <button class="btn btn-warn" id="skip-btn" onclick="skipStep()" disabled style="display:none">‚Ü∑ Saltar</button>
            <button class="btn btn-outline" id="stop-btn" onclick="stopScanner()" disabled style="flex:0;padding:10px 13px">‚ñ†</button>
          </div>
          <div class="feedback" id="feedback"></div>
        </div>
      </div>

      <!-- ENTRY FORM -->
      <div class="panel" id="entry-panel">
        <div class="ph"><span class="ph-title">üì± Datos del equipo</span></div>
        <div class="fsec">

          <div class="fg">
            <div class="full"><label class="fl">IMEI 1 *</label><input type="text" id="f-imei1" placeholder="15 d√≠gitos" maxlength="16"></div>
            <div class="full"><label class="fl">IMEI 2</label><input type="text" id="f-imei2" placeholder="15 d√≠gitos"></div>
            <div class="full"><label class="fl">Serial</label><input type="text" id="f-serial" placeholder="N√∫mero de serie"></div>
            <div class="full"><label class="fl">Marca</label><select id="f-brand" onchange="onBrand()"><option value="">‚Äî Selecciona marca ‚Äî</option></select></div>
            <div class="full">
              <label class="fl">Modelo</label>
              <select id="f-model" disabled onchange="onModelSel()"><option value="">‚Äî Selecciona marca ‚Äî</option><option value="__m__">‚úèÔ∏è Escribir manualmente...</option></select>
              <input type="text" id="f-model-m" placeholder="Escribe el modelo..." style="margin-top:6px;display:none">
            </div>
            <div><label class="fl">GB</label><select id="f-storage"><option value="">‚Äî</option><option>64GB</option><option>128GB</option><option>256GB</option><option>512GB</option><option>1TB</option></select></div>
            <div><label class="fl">Precio</label><input type="number" id="f-price" placeholder="0.00" step="0.01"></div>
            <div class="full"><label class="fl">Estado</label><select id="f-status"><option>Nuevo</option><option>Seminuevo</option><option>Reacondicionado</option><option>Para reparar</option></select></div>
            <div class="full"><label class="fl">Color</label><select id="f-color"><option value="">‚Äî</option></select><div class="color-row" id="color-sw"></div></div>
            <div class="full"><label class="fl">Notas</label><textarea id="f-notes" placeholder="Observaciones..."></textarea></div>
          </div>
          <label class="fl">Foto del equipo</label>
          <div class="photo-prev" id="photo-prev" onclick="triggerPhoto()">
            <div class="no-photo" id="no-photo"><div class="ic">üì∏</div><div>Toca para agregar foto</div></div>
            <img id="photo-img" style="display:none">
            <button class="photo-rm" id="photo-rm" onclick="removePhoto(event)">‚úï</button>
          </div>
          <div class="photo-ctrls">
            <button class="btn btn-outline" onclick="triggerPhoto()" style="flex:1;justify-content:center">üì∑ C√°mara</button>
            <button class="btn btn-outline" onclick="triggerGallery()" style="flex:1;justify-content:center">üñº Galer√≠a</button>
          </div>
          <input type="file" id="photo-input" accept="image/*" onchange="onPhoto(event)">
          <input type="file" id="gallery-input" accept="image/*" onchange="onPhoto(event)">
          <div style="display:flex;gap:9px;margin-top:14px">
            <button class="btn btn-entry" onclick="saveEntry()" style="flex:1;justify-content:center;font-size:14px;padding:13px 16px">‚úÖ Registrar Entrada</button>
            <button class="btn btn-outline" onclick="resetAll()" style="padding:13px 16px">‚Ü∫</button>
          </div>
        </div>
      </div>

      <!-- EXIT FORM -->
      <div class="panel" id="exit-panel" style="display:none">
        <div class="ph"><span class="ph-title">üî¥ Registrar Salida</span></div>
        <div class="fsec">
          <div class="fg">
            <div class="full"><label class="fl">IMEI a dar de baja</label><input type="text" id="exit-imei" placeholder="Escanea o escribe IMEI..."></div>
            <div class="full"><label class="fl">üí∞ Precio de venta *</label><input type="number" id="exit-price" placeholder="0.00" step="0.01" style="border-color:rgba(154,104,0,.4)"></div>
            <div class="full"><label class="fl">Notas de salida</label><textarea id="exit-notes" placeholder="Motivo, cliente, etc..."></textarea></div>
          </div>
          <button class="btn btn-exit-c" onclick="confirmExit()" style="width:100%;justify-content:center;font-size:14px;padding:13px 16px">üî¥ Confirmar Salida</button>
        </div>
      </div>
    </div>

    <!-- TABLE PANEL -->
    <div class="panel" style="margin-bottom:0">
      <!-- BARRA 1: Tabs con icono + label -->
      <div style="border-bottom:1px solid var(--border);background:var(--surface)">
        <div class="table-tabs">
          <button class="tab-btn active" id="tab-inv" onclick="showTab('inv')">
            <span class="tab-ico">üì¶</span><span class="tab-lbl">Inventario</span>
          </button>
          <button class="tab-btn" id="tab-mov" onclick="showTab('mov')">
            <span class="tab-ico">üìã</span><span class="tab-lbl">Movimientos</span>
          </button>
          <button class="tab-btn" id="tab-rep" onclick="showTab('rep')">
            <span class="tab-ico">üìä</span><span class="tab-lbl">Reportes</span>
          </button>
        </div>
      </div>
      <!-- BARRA 2: Acciones compactas -->
      <div class="actions-bar">
        <button class="act-btn" onclick="forceSyncFromSheets()" title="Recargar desde Sheets">
          <span>‚Üª</span><span class="act-lbl">Sync</span>
        </button>
        <button class="act-btn primary" id="btn-bulk" onclick="openBulkModal()" style="display:none" title="Carga masiva Excel">
          <span>üìä</span><span class="act-lbl">Excel</span>
        </button>
        <button class="act-btn" onclick="forceSyncFromSheets()" title="Actualizar desde Sheets" id="btn-actualizar" style="display:none">
          <span>üîÑ</span><span class="act-lbl">Actualizar</span>
        </button>
        <div class="act-spacer"></div>
        <button class="act-btn success" onclick="exportCSV()" title="Exportar CSV">
          <span>‚¨á</span><span class="act-lbl">CSV</span>
        </button>
        <button class="act-btn danger" onclick="openClearModal()" title="Limpiar datos locales">
          <span>üóë</span>
        </button>
      </div>
      <div class="queue-bar hidden" id="queue-bar">
        <span>‚è≥ <span id="q-count">0</span> pendientes de sync</span>
        <button class="btn btn-outline" style="padding:4px 10px;font-size:11px" onclick="retrySyncAll()">‚Üª Reintentar</button>
      </div>

      <!-- INV -->
      <div id="tw-inv">
        <div class="search-bar">
          <span class="search-bar-ico">üîç</span>
          <input type="text" id="search-inv" placeholder="Buscar por IMEI, marca, modelo, color..." oninput="renderTables()" autocomplete="off" autocorrect="off" spellcheck="false">
          <button class="search-bar-clear" onclick="document.getElementById('search-inv').value='';renderTables()" title="Limpiar">√ó</button>
        </div>
        <div class="search-count" id="search-inv-count"></div>
        <div class="tbl-wrap">
          <table><thead><tr><th>#</th><th>Foto</th><th>Tienda</th><th>IMEI 1</th><th>Marca</th><th>Modelo</th><th>Color</th><th>GB</th><th>Precio</th><th>Estado</th><th>Stock</th><th>Sync</th><th id="th-del" style="display:none">Eliminar</th></tr></thead><tbody id="tb-inv"></tbody></table>
        </div>
      </div>

      <!-- MOV -->
      <div id="tw-mov" style="display:none">
        <div class="search-bar" style="margin:10px 14px 0">
          <span class="search-bar-ico">üîç</span>
          <input type="text" id="search-mov" placeholder="Buscar por IMEI, marca, modelo..." oninput="renderTables()" autocomplete="off" autocorrect="off" spellcheck="false">
          <button class="search-bar-clear" onclick="document.getElementById('search-mov').value='';renderTables()" title="Limpiar">√ó</button>
        </div>
        <div class="filter-row" style="margin-top:8px">
          <select id="f-store" onchange="renderTables()" style="font-size:12px"><option value="">Todas las tiendas</option></select>
          <select id="f-type" onchange="renderTables()" style="font-size:12px"><option value="">Entradas y Salidas</option><option value="ENTRADA">Solo Entradas ‚úÖ</option><option value="SALIDA">Solo Salidas üî¥</option></select>
        </div>
        <div class="search-count" id="search-mov-count"></div>
        <div class="tbl-wrap"><table><thead><tr><th>#</th><th>Tienda</th><th>Tipo</th><th>IMEI 1</th><th>Marca</th><th>Modelo</th><th>Estado</th><th>Costo</th><th style="color:var(--success)">Venta</th><th>Fecha</th><th>Hora</th><th>Notas</th><th id="th-del-mov" style="display:none">Eliminar</th></tr></thead><tbody id="tb-mov"></tbody></table></div>
      </div>

      <!-- REPORTS -->
      <div id="tw-rep" style="display:none">
        <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px 0">
          <span style="font-size:11px;color:var(--muted)" id="rep-sync-info">Toca üîÑ para sincronizar</span>
          <button class="btn btn-outline" onclick="loadFromSheets().then(()=>renderReports())" style="padding:6px 12px;font-size:12px">üîÑ Actualizar</button>
        </div>
        <div class="rep-wrap" id="rep-content"></div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL CLEAR -->
<div class="modal-overlay" id="modal-clear">
  <div class="modal">
    <h3>¬øLimpiar datos locales?</h3>
    <p>Los datos en Google Sheets se conservan. Solo limpia la vista local del navegador.</p>
    <div class="modal-btns">
      <button class="btn btn-outline" onclick="closeModal('modal-clear')">Cancelar</button>
      <button class="btn btn-danger" onclick="clearAll()">Limpiar</button>
    </div>
  </div>
</div>

<!-- MODAL GESTI√ìN DE USUARIOS -->
<div class="modal-overlay" id="modal-users">
  <div class="modal" style="max-width:680px;max-height:92vh;overflow-y:auto;padding:0">
    <div style="display:flex;align-items:center;justify-content:space-between;padding:18px 20px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--surface);z-index:2">
      <div>
        <div style="font-size:16px;font-weight:700">üë• Gesti√≥n de Usuarios</div>
        <div style="font-size:11px;color:var(--muted);margin-top:2px">Cambia contrase√±as y nombres de tienda ¬∑ Todo queda registrado</div>
      </div>
      <button onclick="closeModal('modal-users')" style="background:none;border:none;font-size:22px;cursor:pointer;color:var(--muted);line-height:1">√ó</button>
    </div>

    <!-- Tabla de usuarios -->
    <div style="padding:16px 20px 8px">
      <div style="font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.6px;margin-bottom:10px">Usuarios del sistema</div>
      <div style="overflow-x:auto;border-radius:10px;border:1px solid var(--border)">
        <table class="users-table">
          <thead><tr><th>Usuario</th><th>Rol</th><th>Nombre / Tienda</th><th>Nueva contrase√±a</th><th></th></tr></thead>
          <tbody id="users-tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- Log de cambios -->
    <div style="padding:8px 20px 20px">
      <div style="font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.6px;margin-bottom:8px;display:flex;align-items:center;justify-content:space-between">
        <span>üìã Historial de cambios</span>
        <button onclick="loadUserLog()" style="background:none;border:1px solid var(--border);border-radius:6px;padding:3px 9px;font-size:11px;cursor:pointer;color:var(--muted)">‚Üª Actualizar</button>
      </div>
      <div id="user-log-wrap" style="border:1px solid var(--border);border-radius:10px;max-height:180px;overflow-y:auto;background:var(--surface2)">
        <div style="padding:16px;text-align:center;color:var(--muted);font-size:12px">Cargando historial...</div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL INGRESO MASIVO EXCEL -->
<div class="modal-overlay" id="modal-bulk">
  <div class="modal" style="max-width:520px;max-height:90vh;overflow-y:auto">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
      <h3 style="font-size:17px">üìä Carga Masiva de Inventario</h3>
      <button onclick="closeModal('modal-bulk')" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--muted);line-height:1">√ó</button>
    </div>

    <!-- Paso 1: Plantilla -->
    <div style="background:var(--success-bg);border:1px solid rgba(42,122,74,.2);border-radius:10px;padding:12px 14px;margin-bottom:14px;display:flex;align-items:center;justify-content:space-between;gap:10px">
      <div>
        <div style="font-size:12px;font-weight:700;color:var(--success);margin-bottom:2px">üì• Paso 1 ‚Äî Descarga la plantilla</div>
        <div style="font-size:11px;color:var(--muted)">Columnas: IMEI1, IMEI2, Serial, Marca, Modelo, Color, GB, Precio, Estado, Tienda, Notas</div>
      </div>
      <button class="btn btn-success" onclick="downloadTemplate()" style="padding:7px 12px;font-size:12px;flex-shrink:0">‚¨á Plantilla</button>
    </div>

    <!-- Paso 2: Subir archivo -->
    <div style="font-size:12px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">üìÇ Paso 2 ‚Äî Sube tu archivo</div>
    <div id="bulk-drop" style="border:2px dashed var(--border);border-radius:12px;padding:24px;text-align:center;cursor:pointer;margin-bottom:12px;transition:all .2s" onclick="document.getElementById('bulk-file').click()" ondragover="event.preventDefault();this.style.borderColor='var(--purple2)';this.style.background='rgba(124,92,191,.04)'" ondragleave="this.style.borderColor='var(--border)';this.style.background=''" ondrop="onBulkDrop(event)">
      <div style="font-size:32px;margin-bottom:8px">üìÇ</div>
      <div style="font-size:13px;color:var(--text);font-weight:600">Arrastra tu Excel aqu√≠</div>
      <div style="font-size:12px;color:var(--muted);margin-top:4px">o toca para seleccionar ¬∑ .xlsx ¬∑ .xls ¬∑ .csv</div>
      <div id="bulk-file-name" style="font-size:12px;color:var(--purple3);margin-top:8px;font-weight:600"></div>
    </div>
    <input type="file" id="bulk-file" accept=".xlsx,.csv,.xls" onchange="onBulkFile(event)" style="display:none">

    <!-- Preview tabla -->
    <div id="bulk-preview" style="display:none;margin-bottom:12px">
      <div style="font-size:12px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">üëÅ Vista previa (primeras 8 filas)</div>
      <div style="overflow-x:auto;max-height:180px;overflow-y:auto;border-radius:8px;border:1px solid var(--border)">
        <table style="width:100%;font-size:11px;border-collapse:collapse"><thead id="bulk-thead"></thead><tbody id="bulk-tbody"></tbody></table>
      </div>
    </div>

    <!-- Status y progreso -->
    <div id="bulk-status" style="font-size:12px;color:var(--muted);min-height:18px;margin-bottom:10px"></div>
    <div id="bulk-progress-wrap" style="display:none;margin-bottom:12px">
      <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--muted);margin-bottom:5px">
        <span>Importando...</span>
        <span id="bulk-progress-txt">0%</span>
      </div>
      <div style="height:6px;background:var(--border);border-radius:3px;overflow:hidden">
        <div id="bulk-progress-bar" style="height:100%;background:var(--grad-purple);border-radius:3px;transition:width .3s;width:0%"></div>
      </div>
      <div id="bulk-progress-detail" style="font-size:11px;color:var(--muted);margin-top:5px;text-align:center"></div>
    </div>

    <!-- Resultado final -->
    <div id="bulk-result" style="display:none;padding:12px 14px;border-radius:10px;margin-bottom:12px;font-size:13px;font-weight:600"></div>

    <div class="modal-btns">
      <button class="btn btn-outline" id="bulk-cancel-btn" onclick="closeModal('modal-bulk')">Cancelar</button>
      <button class="btn btn-primary" id="bulk-import-btn" onclick="doBulkImport()" disabled>‚úÖ Importar registros</button>
    </div>
  </div>
</div>

<!-- MODAL CONFIRM DELETE IMEI -->
<div class="modal-overlay" id="modal-del">
  <div class="modal">
    <h3>¬øEliminar este IMEI?</h3>
    <p id="modal-del-txt">Se eliminar√° del inventario. Los movimientos hist√≥ricos se conservan.</p>
    <div class="modal-btns">
      <button class="btn btn-outline" onclick="closeModal('modal-del')">Cancelar</button>
      <button class="btn btn-danger" onclick="confirmDelete()">Eliminar</button>
    </div>
  </div>
</div>

<!-- MODAL CONFIRM DELETE MOVIMIENTO -->
<div class="modal-overlay" id="modal-del-mov">
  <div class="modal">
    <h3>¬øEliminar este movimiento?</h3>
    <p id="modal-del-mov-txt">Este movimiento se eliminar√° del historial local y de Google Sheets.</p>
    <div class="modal-btns">
      <button class="btn btn-outline" onclick="closeModal('modal-del-mov')">Cancelar</button>
      <button class="btn btn-danger" onclick="confirmDeleteMov()">Eliminar</button>
    </div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ CATALOG ‚îÄ‚îÄ‚îÄ
const CAT={
  iOS:{'Apple':{m:['iPhone 16e','iPhone 16','iPhone 16 Plus','iPhone 16 Pro','iPhone 16 Pro Max','iPhone 15','iPhone 15 Plus','iPhone 15 Pro','iPhone 15 Pro Max','iPhone 14','iPhone 14 Plus','iPhone 14 Pro','iPhone 14 Pro Max','iPhone 13','iPhone 13 Mini','iPhone 13 Pro','iPhone 13 Pro Max','iPhone 12','iPhone 12 Mini','iPhone 12 Pro','iPhone 12 Pro Max','iPhone 11','iPhone 11 Pro','iPhone 11 Pro Max','iPhone SE (3rd)','iPhone SE (2nd)','iPhone XS Max','iPhone XS','iPhone XR','iPhone X'],c:[{n:'Negro',h:'#1a1a1a'},{n:'Blanco',h:'#f5f5f0'},{n:'Azul',h:'#4a90d9'},{n:'Azul Titanio',h:'#6b7d8f'},{n:'Verde',h:'#4caf7d'},{n:'Amarillo',h:'#f5c842'},{n:'Rosa',h:'#f4a0b5'},{n:'Morado',h:'#9b7ec8'},{n:'Rojo PRODUCT',h:'#c0392b'},{n:'Starlight',h:'#e8e3d8'},{n:'Midnight',h:'#2c2c2e'},{n:'Titanio Natural',h:'#b8a898'},{n:'Titanio Blanco',h:'#e8e0d8'},{n:'Titanio Negro',h:'#3a3a3c'},{n:'Titanio Desierto',h:'#c8a882'}]}},
  Android:{
    'Samsung':{m:['Galaxy S25 Ultra','Galaxy S25+','Galaxy S25','Galaxy S24 Ultra','Galaxy S24+','Galaxy S24','Galaxy S24 FE','Galaxy S23 Ultra','Galaxy S23+','Galaxy S23','Galaxy A56','Galaxy A55','Galaxy A35','Galaxy A25','Galaxy A15','Galaxy A06','Galaxy Z Fold 6','Galaxy Z Fold 5','Galaxy Z Flip 6','Galaxy Z Flip 5','Galaxy Note 20 Ultra','Galaxy Note 20'],c:[{n:'Negro Fantasma',h:'#1a1a2e'},{n:'Gris Fantasma',h:'#5a5a6e'},{n:'Blanco Crema',h:'#f0ede4'},{n:'Violeta',h:'#7b5ea7'},{n:'Verde Jade',h:'#4a7c59'},{n:'Azul Marino',h:'#1e3a5f'},{n:'Amarillo',h:'#f5c842'},{n:'Rosa',h:'#e8a0b0'},{n:'Grafito',h:'#3d3d3d'},{n:'Plateado',h:'#c0c0c0'},{n:'Dorado',h:'#d4af37'}]},
    'Xiaomi':{m:['Xiaomi 15 Ultra','Xiaomi 15 Pro','Xiaomi 15','Xiaomi 14 Ultra','Xiaomi 14 Pro','Xiaomi 14','Redmi Note 14 Pro+','Redmi Note 14 Pro','Redmi Note 14','Redmi Note 13 Pro+','Redmi Note 13 Pro','Redmi Note 13','Redmi 14C','Redmi 13C','Redmi 12','POCO X7 Pro','POCO X6 Pro','POCO X6','POCO F6 Pro','POCO F6'],c:[{n:'Negro',h:'#1a1a1a'},{n:'Blanco',h:'#f5f5f5'},{n:'Azul',h:'#3a7bd5'},{n:'Verde',h:'#4caf7d'},{n:'Dorado',h:'#d4af37'},{n:'Plata',h:'#c0c0c0'},{n:'Rosa',h:'#f4a0b5'},{n:'Morado',h:'#9b7ec8'},{n:'Naranja',h:'#e87040'}]},
    'Motorola':{m:['Edge 50 Ultra','Edge 50 Pro','Edge 50','Edge 50 Fusion','Edge 40 Pro','Edge 40 Neo','Moto G85','Moto G75','Moto G55','Moto G45','Moto G35','Moto G15','Razr 50 Ultra','Razr 50','Razr 40 Ultra'],c:[{n:'Negro Medianoche',h:'#1a1a2e'},{n:'Blanco',h:'#f5f5f5'},{n:'Verde',h:'#4caf7d'},{n:'Gris',h:'#808080'},{n:'Azul Zafiro',h:'#1e3a5f'},{n:'Beige',h:'#d4b896'},{n:'Lila',h:'#c8a2c8'},{n:'Coral',h:'#e87060'}]},
    'Huawei':{m:['Pura 70 Ultra','Pura 70 Pro','Pura 70','Mate 60 Pro+','Mate 60 Pro','Mate 60','Nova 12 Pro','Nova 12','P60 Pro','P60','Y9s','Y7a','Y6p'],c:[{n:'Negro',h:'#1a1a1a'},{n:'Blanco',h:'#f5f5f5'},{n:'Dorado',h:'#d4af37'},{n:'Verde',h:'#4caf7d'},{n:'Azul',h:'#3a7bd5'},{n:'Rosa Perlado',h:'#f4c2c2'},{n:'Plata',h:'#c0c0c0'},{n:'Rojo',h:'#c0392b'}]},
    'Realme':{m:['Realme GT 7 Pro','Realme GT 6','Realme 13 Pro+','Realme 13 Pro','Realme 13','Realme C75','Realme C65','Realme C55'],c:[{n:'Negro',h:'#1a1a1a'},{n:'Blanco',h:'#f5f5f5'},{n:'Naranja',h:'#e87040'},{n:'Verde',h:'#4caf7d'},{n:'Azul',h:'#3a7bd5'},{n:'Dorado',h:'#d4af37'}]},
    'OnePlus':{m:['OnePlus 13','OnePlus 12','OnePlus Nord 4','OnePlus Nord CE4','OnePlus Nord CE 3 Lite'],c:[{n:'Negro',h:'#1a1a1a'},{n:'Verde Marino',h:'#2d6a4f'},{n:'Gris',h:'#808080'},{n:'Naranja',h:'#e87040'},{n:'Azul',h:'#3a7bd5'}]}
  }
};

// ‚îÄ‚îÄ‚îÄ STORAGE HELPER ‚îÄ‚îÄ‚îÄ
const _mem={};
const LS={
  getItem:k=>{try{return localStorage.getItem(k);}catch(e){return _mem[k]??null;}},
  setItem:(k,v)=>{try{localStorage.setItem(k,v);}catch(e){_mem[k]=v;}},
  removeItem:k=>{try{localStorage.removeItem(k);}catch(e){delete _mem[k];}}
};

// ‚îÄ‚îÄ‚îÄ USERS ‚îÄ‚îÄ‚îÄ (se sobreescriben desde Sheets al iniciar)
const USERS_DEFAULT={
  'admin':  {password:'Admin2024!', role:'admin',  store:null,      name:'Administrador'},
  'tienda1':{password:'Tienda1#',   role:'store',  store:'Tienda 1',name:'Tienda 1'},
  'tienda2':{password:'Tienda2#',   role:'store',  store:'Tienda 2',name:'Tienda 2'},
  'tienda3':{password:'Tienda3#',   role:'store',  store:'Tienda 3',name:'Tienda 3'},
  'tienda4':{password:'Tienda4#',   role:'store',  store:'Tienda 4',name:'Tienda 4'},
  'tienda5':{password:'Tienda5#',   role:'store',  store:'Tienda 5',name:'Tienda 5'},
  'tienda6':{password:'Tienda6#',   role:'store',  store:'Tienda 6',name:'Tienda 6'},
  'tienda7':{password:'Tienda7#',   role:'store',  store:'Tienda 7',name:'Tienda 7'},
  'lider1': {password:'Lider1#2024',role:'leader', store:null,      name:'L√≠der Zona 1'},
  'lider2': {password:'Lider2#2024',role:'leader', store:null,      name:'L√≠der Zona 2'},
};
// Cargar desde cach√© local si existe (persiste cambios entre recargas sin Sheets)
let USERS=(()=>{
  try{
    const cached=LS.getItem('users_cache_v1');
    if(cached){
      const parsed=JSON.parse(cached);
      // Mezclar: usar cached pero respetar estructura de defaults para usuarios nuevos
      const merged={...USERS_DEFAULT};
      Object.keys(parsed).forEach(k=>{
        if(merged[k]) merged[k]={...merged[k],...parsed[k]};
      });
      return merged;
    }
  }catch(e){}
  return {...USERS_DEFAULT};
})();

function saveUsersCache(){
  try{ LS.setItem('users_cache_v1',JSON.stringify(USERS)); }catch(e){}
}

// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ
let inv=(()=>{try{return JSON.parse(LS.getItem('inv_v6')||'[]');}catch(e){return [];}})();
let mov=(()=>{try{return JSON.parse(LS.getItem('mov_v6')||'[]');}catch(e){return [];}})();
let scriptUrl=(()=>{try{return LS.getItem('imei_url_v6')||'';}catch(e){return '';}})();

// Helper: valida que la URL exista y parezca un endpoint v√°lido
function isValidUrl(url){
  if(!url || typeof url!=='string' || url.trim()==='') return false;
  const u = url.trim();
  // Acepta cualquier URL que termine en /exec o contenga script.google.com
  return u.startsWith('http') && (u.includes('/exec') || u.includes('google'));
}
let currentUser=(()=>{try{return JSON.parse(LS.getItem('imei_user')||'null');}catch(e){return null;}})();
let mode='entry',scannerRunning=false,currentStep=1,scanLocked=false,detBuf=[];
let sv={imei1:'',imei2:'',serial:''};
let selColor='',photoData=null,curTab='inv';

// ‚îÄ‚îÄ‚îÄ NOTIFICATIONS STATE ‚îÄ‚îÄ‚îÄ
let notifications=[];
let unreadCount=0;
let notifDropOpen=false;

const isIMEI=c=>/^\d{14,15}$/.test(c.trim());
const isSerial=c=>/^[A-Z0-9]{8,20}$/i.test(c.trim())&&!/^\d{14,15}$/.test(c.trim());
const STEPS={1:{l:'IMEI 1',b:'bi1',v:isIMEI,f:'imei1'},2:{l:'IMEI 2',b:'bi2',v:isIMEI,f:'imei2'},3:{l:'Serial',b:'bi3',v:isSerial,f:'serial'}};
const EXIT_S={l:'IMEI',b:'bix',v:isIMEI};
const REQ=5,MIN_C=0.82;  // REQ lecturas consistentes, MIN_C umbral confianza

function luhnCheck(num){
  let s=0,alt=false;
  for(let i=num.length-1;i>=0;i--){
    let n=parseInt(num[i],10);
    if(alt){n*=2;if(n>9)n-=9;}
    s+=n;alt=!alt;
  }
  return s%10===0;
}

// ‚îÄ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ‚îÄ
function onUrlInput(){
  const v=document.getElementById('url-inp').value.trim();
  if(v.includes('script.google.com')&&v.includes('/exec')){
    scriptUrl=v;try{LS.setItem('imei_url_v6',v);}catch(e){}
    document.getElementById('url-inp').classList.add('ok');
  }
}
function saveUrl(){
  onUrlInput();
  const el=document.getElementById('url-inp');
  el.style.borderColor='var(--success)';
  setTimeout(()=>el.style.borderColor='',2000);
}
async function doLogin(){
  const user=document.getElementById('login-user').value.trim().toLowerCase();
  const pass=document.getElementById('login-pass').value;
  const err=document.getElementById('login-err');
  const btn=document.querySelector('.login-btn');
  err.classList.remove('vis');
  if(!user||!pass){err.textContent='Ingresa usuario y contrase√±a';err.classList.add('vis');return;}

  // Intentar cargar usuarios desde Sheets (fallo silencioso ‚Äî usa cach√© local si no hay red)
  if(isValidUrl(scriptUrl)){
    if(btn){btn.textContent='‚ü≥ Verificando...';btn.disabled=true;}
    try{
      await Promise.race([
        loadUsersFromSheets(),
        new Promise((_,r)=>setTimeout(()=>r(new Error('timeout')),5000))
      ]);
    }catch(e){
      // Sin red o timeout: continuar con USERS en cach√©/defaults
      console.warn('Login sin Sheets (modo offline):', e.message);
    }
    if(btn){btn.textContent='Ingresar ‚Üí';btn.disabled=false;}
  }

  const u=USERS[user];
  if(!u||String(u.password).trim()!==String(pass).trim()){err.textContent='Usuario o contrase√±a incorrectos';err.classList.add('vis');return;}
  currentUser={username:user,role:u.role,store:u.store,name:u.name};
  try{LS.setItem('imei_user',JSON.stringify(currentUser));}catch(e){}
  showApp();
  updateStoreSelects();
  loadFromSheets().then(()=>{
    renderTables();
    updateStats();
    if(curTab==='rep') renderReports();
    initSeenMovs();
    startNotifPolling();
  });
}
function showApp(){
  document.getElementById('login-screen').classList.add('hidden');
  document.getElementById('app').classList.remove('hidden');
  document.body.setAttribute('data-role', currentUser.role);
  const uc=document.getElementById('user-chip');
  const roleIco=currentUser.role==='admin'?'üëë ':currentUser.role==='leader'?'üëÅ ':'üè™ ';
  uc.textContent=roleIco+currentUser.name;
  uc.className='user-chip '+(currentUser.role==='admin'?'admin':currentUser.role==='leader'?'leader':'store');
  document.getElementById('tb-sub').textContent=currentUser.role==='admin'?'Vista global ‚Äî todas las tiendas':currentUser.role==='leader'?'Vista de l√≠der ‚Äî todas las tiendas (solo lectura)':currentUser.store;
  const isLeader=currentUser.role==='leader';
  const isAdmin=currentUser.role==='admin';
  const modeRow=document.getElementById('mode-row');
  if(modeRow) modeRow.style.display=(isLeader)?'none':'';
  document.getElementById('entry-panel').style.display='none';
  document.getElementById('exit-panel').style.display='none';
  if(isLeader) document.getElementById('step-bar').classList.add('hidden');
  const thDel=document.getElementById('th-del');
  if(thDel) thDel.style.display=currentUser.role==='admin'?'':'none';
  const thDelMov=document.getElementById('th-del-mov');
  if(thDelMov) thDelMov.style.display=currentUser.role==='admin'?'':'none';
  if(!isLeader) setMode('entry');
  const btnBulk=document.getElementById('btn-bulk');
  if(btnBulk) btnBulk.style.display=isAdmin?'inline-flex':'none';
  const btnAct=document.getElementById('btn-actualizar');
  if(btnAct) btnAct.style.display=isAdmin?'inline-flex':'none';
  const btnUsers=document.getElementById('btn-users-mgmt');
  if(btnUsers) btnUsers.style.display=isAdmin?'inline-flex':'none';
  updateStoreSelects();
}
function logout(){
  currentUser=null;try{LS.removeItem('imei_user');}catch(e){}stopNotifPolling();
  notifications=[];unreadCount=0;
  document.getElementById('login-screen').classList.remove('hidden');
  document.getElementById('app').classList.add('hidden');
  stopScanner();
}

// ‚îÄ‚îÄ‚îÄ NOTIF DROPDOWN ‚îÄ‚îÄ‚îÄ
function toggleNotifDropdown(){
  notifDropOpen=!notifDropOpen;
  document.getElementById('notif-dropdown').classList.toggle('open',notifDropOpen);
  if(notifDropOpen){
    // Mark all as read
    unreadCount=0;
    notifications.forEach(n=>n.read=true);
    updateNotifBadge();
    renderNotifList();
  }
}
function updateNotifBadge(){
  const badge=document.getElementById('notif-badge');
  const btn=document.getElementById('notif-bell-btn');
  if(unreadCount>0){
    badge.textContent=unreadCount>99?'99+':unreadCount;
    badge.classList.remove('hidden');
    btn.classList.add('has-notif');
  } else {
    badge.classList.add('hidden');
    btn.classList.remove('has-notif');
  }
}
function addNotification(store,type,brand,model){
  const now=new Date();
  const timeStr=now.toLocaleTimeString('es-MX',{hour:'2-digit',minute:'2-digit'});
  const notif={
    id:Date.now(),store,type,brand,model,
    time:timeStr,read:notifDropOpen
  };
  notifications.unshift(notif);
  if(notifications.length>50) notifications.pop();
  if(!notifDropOpen){
    unreadCount++;
    updateNotifBadge();
    // Animate bell
    const btn=document.getElementById('notif-bell-btn');
    btn.querySelector('.bell-icon').style.animation='none';
    requestAnimationFrame(()=>{
      requestAnimationFrame(()=>{
        btn.querySelector('.bell-icon').style.animation='bellRing .5s ease-in-out';
      });
    });
  }
  if(notifDropOpen) renderNotifList();
}
function renderNotifList(){
  const list=document.getElementById('nd-list');
  if(!notifications.length){
    list.innerHTML='<div class="nd-empty"><div class="big">üîï</div>Sin notificaciones nuevas</div>';
    return;
  }
  list.innerHTML=notifications.map(n=>{
    const isEntrada=n.type&&n.type.includes('ENTRADA');
    return `<div class="nd-item${n.read?'':' unread'}">
      <div class="nd-ico ${isEntrada?'entrada':'salida'}">${isEntrada?'üì¶':'üì§'}</div>
      <div class="nd-body">
        <div class="nd-store">${n.store}</div>
        <div class="nd-desc">${isEntrada?'Entrada':'Salida'}: ${n.brand} ${n.model}</div>
        <div class="nd-time">${n.time}</div>
      </div>
    </div>`;
  }).join('');
}
function clearNotifs(){
  notifications=[];unreadCount=0;
  updateNotifBadge();renderNotifList();
}
// Close dropdown when clicking outside
document.addEventListener('click',function(e){
  if(notifDropOpen&&!document.getElementById('notif-bell-wrap').contains(e.target)){
    notifDropOpen=false;
    document.getElementById('notif-dropdown').classList.remove('open');
  }
});

// ‚îÄ‚îÄ‚îÄ LOAD FROM SHEETS ‚îÄ‚îÄ‚îÄ
// Forzar recarga completa desde Sheets (limpia cach√© local y recarga)
async function forceSyncFromSheets(){
  if(!isValidUrl(scriptUrl)){
    showFb('‚ö† Configura primero la URL del Apps Script','error');
    return;
  }
  showFb('‚ü≥ Recargando desde Google Sheets...','pending');
  inv=[];mov=[];
  saveData();
  await loadFromSheets();
  initSeenMovs();
  showFb('‚úÖ Datos recargados desde Sheets','success',3000);
}

async function loadFromSheets(){
  if(!isValidUrl(scriptUrl)||!currentUser)return;
  setSP('send','‚ü≥ Cargando...');
  try{
    const roleParam=(currentUser.role==='admin'||currentUser.role==='leader')?'admin':'store';
    const storeParam=(currentUser.role==='store'&&currentUser.store)?currentUser.store:'';
    // NO usar cache: Apps Script GET puede devolver respuesta cacheada vac√≠a
    const url=scriptUrl+'?action=get_data&role='+encodeURIComponent(roleParam)+'&store='+encodeURIComponent(storeParam);
    const res=await fetch(url,{
      method:'GET',
      cache:'no-store',
      headers:{'Cache-Control':'no-cache'}
    });
    const text=await res.text();
    let data;
    try{ data=JSON.parse(text); }
    catch(parseErr){
      setSP('err','‚úó Respuesta inv√°lida del servidor');
      console.warn('Apps Script response (not JSON):', text.substring(0,200));
      return;
    }
    if(data.success){
      const rawInv=data.inventory||[];
      const rawMov=data.movements||[];
      // Filtro extra cliente: tienda solo ve SUS movimientos e inventario
      if(currentUser.role==='store'){
        // Tienda: solo ve su propio inventario y movimientos
        inv=rawInv
          .filter(r=>r.store===currentUser.store)
          .map(r=>({...r,syncStatus:'synced',fresh:false}));
        mov=rawMov
          .filter(r=>r.store===currentUser.store)
          .map((r,i)=>({...r,id:i}));
      } else {
        // Admin y lider: ven todo
        inv=rawInv.map(r=>({...r,syncStatus:'synced',fresh:false}));
        mov=rawMov.map((r,i)=>({...r,id:i}));
      }
      saveData();
      renderTables();
      updateStats();
      if(curTab==='rep') renderReports();
      setSP('ok','‚úì Sincronizado ¬∑ '+inv.length+' equipos ¬∑ '+mov.length+' mov');
    } else {
      setSP('err','‚úó '+(data.error||'Sin datos'));
      console.warn('getData error:', data.error);
    }
  }catch(e){
    setSP('err','‚úó Error de red');
  }
}

// ‚îÄ‚îÄ‚îÄ MODE ‚îÄ‚îÄ‚îÄ
function setMode(m){
  mode=m;stopScanner();
  document.getElementById('btn-entry').className='mode-btn'+(m==='entry'?' ae':'');
  document.getElementById('btn-exit').className='mode-btn'+(m==='exit'?' ax':'');
  document.getElementById('step-bar').classList.toggle('hidden',m==='exit');
  document.getElementById('entry-panel').style.display=m==='entry'?'block':'none';
  document.getElementById('exit-panel').style.display=m==='exit'?'block':'none';
  document.getElementById('skip-btn').style.display=m==='entry'?'inline-flex':'none';
  document.getElementById('exit-result').className='exit-result';
  document.getElementById('ph-icon').textContent=m==='entry'?'üì∑':'üîç';
  document.getElementById('ph-txt').textContent=m==='entry'?'Activa la c√°mara para escanear':'Activa para escanear IMEI de salida';
  if(m==='entry'){currentStep=1;sv={imei1:'',imei2:'',serial:''};updateStepUI();}
}

// ‚îÄ‚îÄ‚îÄ CATALOG ‚îÄ‚îÄ‚îÄ

function onModelSel(){
  const v=document.getElementById('f-model').value;
  document.getElementById('f-model-m').style.display=v==='__m__'?'block':'none';
  if(v!=='__m__')document.getElementById('f-model-m').value='';
}
function getModel(){
  const s=document.getElementById('f-model').value;
  return s==='__m__'?document.getElementById('f-model-m').value.trim():s;
}
function onBrand(){
  const br=document.getElementById('f-brand').value;
  if(!br)return;
  const d=(CAT['iOS'][br]||CAT['Android'][br]);if(!d)return;
  const ms=document.getElementById('f-model');
  ms.innerHTML='<option value="">‚Äî Selecciona modelo ‚Äî</option>';
  d.m.forEach(m=>ms.innerHTML+=`<option value="${m}">${m}</option>`);
  ms.innerHTML+='<option value="__m__">‚úèÔ∏è Escribir manualmente...</option>';
  ms.disabled=false;
  document.getElementById('f-model-m').style.display='none';
  const cs=document.getElementById('f-color');
  cs.innerHTML='<option value="">‚Äî Selecciona color ‚Äî</option>';
  d.c.forEach(c=>cs.innerHTML+=`<option value="${c.n}">${c.n}</option>`);
  const sw=document.getElementById('color-sw');sw.innerHTML='';
  d.c.forEach(c=>{const el=document.createElement('div');el.className='csw';el.style.background=c.h;el.title=c.n;el.onclick=()=>{selColor=c.n;document.getElementById('f-color').value=c.n;document.querySelectorAll('.csw').forEach(s=>s.classList.remove('sel'));el.classList.add('sel');};sw.appendChild(el);});
  selColor='';
}
document.getElementById('f-color').addEventListener('change',function(){selColor=this.value;document.querySelectorAll('.csw').forEach(s=>s.classList.toggle('sel',s.title===this.value));});

// ‚îÄ‚îÄ‚îÄ PHOTO ‚îÄ‚îÄ‚îÄ
function triggerPhoto(){const i=document.getElementById('photo-input');i.setAttribute('capture','environment');i.click();}
function triggerGallery(){document.getElementById('gallery-input').click();}
function onPhoto(e){
  const file=e.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=ev=>{
    const img=new Image();
    img.onload=()=>{
      const c=document.createElement('canvas');
      const MAX=600;
      let w=img.width,h=img.height;
      if(w>h){if(w>MAX){h=Math.round(h*MAX/w);w=MAX;}}
      else{if(h>MAX){w=Math.round(w*MAX/h);h=MAX;}}
      c.width=w;c.height=h;
      c.getContext('2d').drawImage(img,0,0,w,h);
      photoData=c.toDataURL('image/jpeg',0.65);
      document.getElementById('photo-img').src=photoData;
      document.getElementById('photo-img').style.display='block';
      document.getElementById('no-photo').style.display='none';
      document.getElementById('photo-rm').classList.add('hp');
    };img.src=ev.target.result;
  };reader.readAsDataURL(file);
}
function removePhoto(e){
  e.stopPropagation();photoData=null;
  document.getElementById('photo-img').style.display='none';
  document.getElementById('photo-img').src='';
  document.getElementById('no-photo').style.display='flex';
  document.getElementById('photo-rm').classList.remove('hp');
  document.getElementById('photo-input').value='';
  document.getElementById('gallery-input').value='';
}

// ‚îÄ‚îÄ‚îÄ STEPS ‚îÄ‚îÄ‚îÄ
function updateStepUI(){
  for(let i=1;i<=3;i++){
    const el=document.getElementById('stp-'+i);
    el.classList.remove('active','done');
    if(i<currentStep){el.classList.add('done');if(i<3)document.getElementById('sd'+i).classList.add('done');}
    else if(i===currentStep)el.classList.add('active');
  }
  document.getElementById('sv1').textContent=sv.imei1||'Esperando...';
  document.getElementById('sv2').textContent=sv.imei2||'Esperando...';
  document.getElementById('sv3').textContent=sv.serial||'Esperando...';
}
function skipStep(){
  if(currentStep>=3)return;
  sv[STEPS[currentStep].f]='';currentStep++;
  scanLocked=false;detBuf=[];updateStepUI();
  showFb('‚Ü∑ Saltado ‚Üí '+STEPS[currentStep].l,'pending');
}

// ‚îÄ‚îÄ‚îÄ SCANNER ‚îÄ‚îÄ‚îÄ
function startScanner(){
  if(scannerRunning)return;
  const con=document.getElementById('scanner-container');
  document.getElementById('sc-ph').style.display='none';
  const cfg=mode==='exit'?EXIT_S:STEPS[currentStep];
  const cc=mode==='exit'?'x':'e';
  con.insertAdjacentHTML('beforeend',`
    <div class="sc-badge ${cfg.b}" id="sc-badge">‚óè ${cfg.l}</div>
    <div class="sc-overlay" id="sc-overlay">
      <div class="sc-dark-top"></div>
      <div class="sc-dark-bot"></div>
      <div class="sc-dark-l"></div>
      <div class="sc-dark-r"></div>
      <div class="sc-window">
        <div class="sc-line f${cc}"></div>
        <div class="corner tl c${cc}"></div><div class="corner tr c${cc}"></div>
        <div class="corner bl c${cc}"></div><div class="corner br c${cc}"></div>
        <div class="sc-hint f${cc}">Centra el c√≥digo de barras aqu√≠</div>
      </div>
    </div>`);
  Quagga.init({
    inputStream:{
      name:"Live",type:"LiveStream",target:con,
      constraints:{
        facingMode:"environment",
        width:{min:1280,ideal:1920,max:1920},
        height:{min:720,ideal:1080,max:1080},
        focusMode:"continuous",         // autoenfoque continuo
        advanced:[{torch:false}]
      },
      // √Årea de an√°lisis = coincide exactamente con la ventana visual
      area:{top:"24%",right:"12%",bottom:"24%",left:"12%"}
    },
    locator:{
      patchSize:"medium",   // "medium" mejor balance velocidad/precisi√≥n para IMEI
      halfSample:false       // false = m√°s preciso (m√°s lento pero vale la pena)
    },
    numOfWorkers:navigator.hardwareConcurrency>2?2:1,
    frequency:15,            // 15fps suficiente, menos CPU que 25
    decoder:{
      readers:[
        {format:"code_128_reader",config:{}}  // Code128 = est√°ndar IMEI
      ],
      debug:{drawBoundingBox:false,showFrequency:false,drawScanline:false,showPattern:false},
      multiple:false
    },
    locate:true
  },err=>{
    if(err){showFb('‚úó Error c√°mara: '+(err.message||err),'error');document.getElementById('sc-ph').style.display='flex';con.querySelector('#sc-overlay')?.remove();con.querySelector('#sc-badge')?.remove();return;}
    Quagga.start();scannerRunning=true;scanLocked=false;detBuf=[];
    document.getElementById('start-btn').disabled=true;
    document.getElementById('stop-btn').disabled=false;
    if(mode==='entry')document.getElementById('skip-btn').disabled=false;
    document.getElementById('led').classList.add('on');
    document.getElementById('conf-wrap').style.display='block';
    document.getElementById('cur-read').style.display='flex';
    setSP('ok','‚úì Activo');
  });
  Quagga.onProcessed(r=>{
    if(!r?.codeResult?.code)return;
    const codes=r.codeResult.decodedCodes.filter(x=>x.error!==undefined);
    if(!codes.length)return;
    const conf=1-codes.reduce((a,x)=>a+x.error,0)/codes.length;
    updateConf(conf);
    const code=r.codeResult.code;
    document.getElementById('cr-l').textContent=mode==='exit'?'IMEI':(STEPS[currentStep]?.l||'Leyendo');
    document.getElementById('cr-v').className='cr-v vld';
    document.getElementById('cr-v').textContent=code.length>20?code.substring(0,20)+'‚Ä¶':code;
  });
  Quagga.onDetected(r=>{
    if(scanLocked)return;
    const code=r.codeResult.code.trim();
    const codes=r.codeResult.decodedCodes.filter(x=>x.error!==undefined);
    if(!codes.length)return;
    const conf=1-codes.reduce((a,x)=>a+x.error,0)/codes.length;
    if(conf<MIN_C)return;
    const cfg=mode==='exit'?EXIT_S:STEPS[currentStep];
    if(!cfg.v(code))return;
    if((mode==='exit'||currentStep<=2)&&/^\d{15}$/.test(code)){if(!luhnCheck(code))return;}
    detBuf.push(code);
    if(detBuf.length>REQ*4)detBuf.shift();
    const counts={};detBuf.forEach(c=>counts[c]=(counts[c]||0)+1);
    const[bc,bn]=Object.entries(counts).sort((a,b)=>b[1]-a[1])[0];
    updateConf(Math.min(bn/REQ,0.99));
    if(bn>=REQ){scanLocked=true;detBuf=[];updateConf(1);onConfirmed(bc);}
  });
}
function onConfirmed(code){mode==='exit'?onExitScan(code):onEntryStep(code);}
function flash(t){const c=document.getElementById('scanner-container');c.classList.add(t==='e'?'fe':'fx');setTimeout(()=>c.classList.remove('fe','fx'),800);}
function onEntryStep(code){
  const cfg=STEPS[currentStep];flash('e');
  sv[cfg.f]=code;
  const fm={imei1:'f-imei1',imei2:'f-imei2',serial:'f-serial'};
  const inp=document.getElementById(fm[cfg.f]);
  if(inp){inp.value=code;inp.classList.add('fc-ok');}
  document.getElementById('cr-v').className='cr-v oke';
  document.getElementById('cr-v').textContent=code;
  showFb('‚úì '+cfg.l+': '+code,'success');
  updateStepUI();
  if(currentStep<3){
    currentStep++;updateStepUI();
    setTimeout(()=>{
      scanLocked=false;detBuf=[];
      showFb('‚ñ∂ Ahora: '+STEPS[currentStep].l,'pending');
      const badge=document.getElementById('sc-badge');
      if(badge){badge.className='sc-badge '+STEPS[currentStep].b;badge.textContent='‚óè '+STEPS[currentStep].l;}
    },1200);
  } else {
    stopScanner();showFb('‚úÖ Datos capturados. Completa el formulario.','success');
    document.getElementById('skip-btn').disabled=true;
  }
}
async function onExitScan(code){
  flash('x');
  document.getElementById('exit-imei').value=code;
  document.getElementById('cr-v').className='cr-v okx';
  document.getElementById('cr-v').textContent=code;
  stopScanner();showFb('üîç Buscando IMEI...','pending');
  let found=inv.find(r=>String(r.imei1).trim()===code);
  if(!found){showFb('‚ü≥ No encontrado local, sincronizando...','pending');await loadFromSheets();found=inv.find(r=>String(r.imei1).trim()===code);}
  const er=document.getElementById('exit-result');
  er.className='exit-result vis';
  if(!found){
    er.classList.add('nf');
    document.getElementById('er-name').textContent='‚ùå IMEI no encontrado';
    document.getElementById('er-imei').textContent=code;
    document.getElementById('er-detail').textContent='No registrado en inventario.';
    document.getElementById('er-photo').style.display='none';
    showFb('‚úó IMEI no encontrado','error');return;
  }
  if(String(found.stock)==='0'||found.stock===0){
    er.classList.add('ao');
    document.getElementById('er-name').textContent='‚ö† Ya fue dado de baja';
    document.getElementById('er-imei').textContent=code;
    document.getElementById('er-detail').textContent=found.brand+' '+found.model+' ‚Äî ya tiene salida registrada.';
    document.getElementById('er-photo').style.display='none';
    showFb('‚ö† Este IMEI ya tiene salida registrada','error');return;
  }
  document.getElementById('er-name').textContent=found.brand+' '+found.model;
  document.getElementById('er-imei').textContent=code;
  document.getElementById('er-detail').textContent=(found.color||'‚Äî')+' ¬∑ '+(found.storage||'‚Äî')+' ¬∑ Entrada: '+found.date+(found.store?' ¬∑ '+found.store:'');
  if(found.photoUrl){document.getElementById('er-photo').src=found.photoUrl;document.getElementById('er-photo').style.display='block';}
  else document.getElementById('er-photo').style.display='none';
  showFb('‚úì Equipo encontrado ‚Äî confirma la salida abajo','success');
}
function stopScanner(){
  if(!scannerRunning)return;
  Quagga.stop();scannerRunning=false;scanLocked=false;detBuf=[];
  document.getElementById('start-btn').disabled=false;
  document.getElementById('stop-btn').disabled=true;
  document.getElementById('skip-btn').disabled=true;
  document.getElementById('led').classList.remove('on');
  document.getElementById('conf-wrap').style.display='none';
  document.getElementById('cur-read').style.display='none';
  const c=document.getElementById('scanner-container');
  c.querySelector('#sc-overlay')?.remove();c.querySelector('#sc-badge')?.remove();
  c.querySelectorAll('video,canvas').forEach(el=>el.remove());
  document.getElementById('sc-ph').style.display='flex';
}
function updateConf(conf){
  const p=Math.round(conf*100);
  document.getElementById('conf-fill').style.width=p+'%';
  document.getElementById('conf-fill').style.background=conf>.88?'var(--success)':conf>.70?'var(--warning)':'var(--rose2)';
  document.getElementById('conf-pct').textContent=p+'%';
}

// ‚îÄ‚îÄ‚îÄ SAVE ENTRY ‚îÄ‚îÄ‚îÄ
async function saveEntry(){
  if(currentUser&&currentUser.role==='leader'){showFb('‚ö† Los l√≠deres no pueden registrar entradas','error');return;}
  const imei1=document.getElementById('f-imei1').value.trim();
  if(!imei1){showFb('‚ö† IMEI 1 es obligatorio','error');return;}
  const existing=inv.find(r=>String(r.imei1).trim()===imei1);
  if(existing&&(String(existing.stock)==='1'||existing.stock===1)){showFb('‚ö† Este IMEI ya est√° en stock activo.','error');return;}
  const color=document.getElementById('f-color').value||selColor;
  const now=new Date();
  const date=now.toLocaleDateString('es-MX');
  const time=now.toLocaleTimeString('es-MX',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  const row={
    imei1,imei2:document.getElementById('f-imei2').value.trim(),
    serial:document.getElementById('f-serial').value.trim(),
    brand:document.getElementById('f-brand').value,
    model:getModel(),color,storage:document.getElementById('f-storage').value,
    price:document.getElementById('f-price').value.trim(),
    status:document.getElementById('f-status').value,
    notes:document.getElementById('f-notes').value.trim(),
    date,time,store:currentUser.store||'Admin',
    photoLocal:photoData||null,photoUrl:'',stock:'1',
    syncStatus:'pending',fresh:true
  };
  const m={type:'ENTRADA',store:row.store,imei1,brand:row.brand,model:row.model,color,storage:row.storage,price:row.price,status:row.status,date,time,notes:row.notes};
  const idx=inv.findIndex(r=>String(r.imei1).trim()===imei1);
  if(idx>-1)inv[idx]={...row,fresh:true};
  else inv.unshift(row);
  mov.unshift(m);
  saveData();renderTables();updateStats();
  showFb('üì§ Guardando en Sheets...','pending');
  const targetRow=inv.find(r=>String(r.imei1).trim()===imei1)||row;
  await syncEntry(targetRow);
  if(photoData&&scriptUrl){showFb('üñº Subiendo foto a Drive...','pending');await uploadPhoto(targetRow);}
  showFb('‚úÖ Entrada registrada correctamente','success');
  resetAll();
}

// ‚îÄ‚îÄ‚îÄ CONFIRM EXIT ‚îÄ‚îÄ‚îÄ
async function confirmExit(){
  if(currentUser&&currentUser.role==='leader'){showFb('‚ö† Los l√≠deres no pueden registrar salidas','error');return;}
  const imei1=document.getElementById('exit-imei').value.trim();
  if(!imei1){showFb('‚ö† Escanea o escribe el IMEI','error');return;}
  let item=inv.find(r=>String(r.imei1).trim()===imei1);
  if(!item){showFb('‚ü≥ Sincronizando con Sheets...','pending');await loadFromSheets();item=inv.find(r=>String(r.imei1).trim()===imei1);}
  if(!item){showFb('‚úó IMEI no encontrado en inventario','error');return;}
  if(String(item.stock)==='0'||item.stock===0){showFb('‚ö† Ya tiene salida registrada','error');return;}
  const salePrice=document.getElementById('exit-price').value.trim();
  if(!salePrice||parseFloat(salePrice)<=0){showFb('‚ö† Ingresa el precio de venta','error');return;}
  const notes=document.getElementById('exit-notes').value.trim();
  const now=new Date();
  const date=now.toLocaleDateString('es-MX');
  const time=now.toLocaleTimeString('es-MX',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  item.stock='0';
  const m={type:'SALIDA',store:currentUser.store||'Admin',imei1,brand:item.brand,model:item.model,color:item.color,storage:item.storage,price:item.price,salePrice,status:item.status,date,time,notes};
  mov.unshift(m);saveData();renderTables();updateStats();
  showFb('üì§ Registrando salida en Sheets...','pending');
  if(isValidUrl(scriptUrl)){
    try{
      const res=await fetch(scriptUrl,{method:'POST',body:JSON.stringify({action:'exit',imei1,store:currentUser.store||'Admin',role:currentUser.role,date,time,notes,salePrice}),headers:{'Content-Type':'text/plain'}});
      const text=await res.text();
      let d;try{d=JSON.parse(text);}catch(e){d={success:false,error:'Respuesta inv√°lida'};}
      showFb(d.success?'‚úÖ Salida registrada en Sheets':'‚ö† Local OK ‚Äî error Sheets: '+d.error,d.success?'success':'error');
    }catch(e){showFb('‚ö† Salida guardada localmente. Sin conexi√≥n.','error');}
  }else showFb('‚úÖ Salida guardada localmente','success');
  document.getElementById('exit-imei').value='';
  document.getElementById('exit-price').value='';
  document.getElementById('exit-notes').value='';
  document.getElementById('exit-result').className='exit-result';
  showTab('mov');
}

// ‚îÄ‚îÄ‚îÄ SYNC ‚îÄ‚îÄ‚îÄ
function saveData(){
  try{LS.setItem('inv_v6',JSON.stringify(inv.map(r=>({...r,photoLocal:null}))));LS.setItem('mov_v6',JSON.stringify(mov));}catch(e){}
}
async function syncEntry(row){
  if(!isValidUrl(scriptUrl)){row.syncStatus='pending';saveData();updateQueueBar();return;}
  row.syncStatus='sending';renderTables();
  try{
    const p={action:'entry',...row,photoLocal:undefined,photoUrl:row.photoUrl||''};
    const res=await fetch(scriptUrl,{method:'POST',body:JSON.stringify(p),headers:{'Content-Type':'text/plain'}});
    const text=await res.text();
    let d;try{d=JSON.parse(text);}catch(e){d={success:false,error:'No JSON'};}
    row.syncStatus=d.success?'synced':'error';
    setSP(d.success?'ok':'err',d.success?'‚úì Guardado':'‚úó Error');
  }catch(e){row.syncStatus='pending';setSP('err','‚úó Sin red');}
  saveData();renderTables();updateQueueBar();
}
async function uploadPhoto(row){
  if(!row.photoLocal||!isValidUrl(scriptUrl))return;
  const sizeKB=Math.round(row.photoLocal.length*0.75/1024);
  if(sizeKB>1500){showFb('‚ö† Foto muy grande ('+sizeKB+'KB).','error');return;}
  try{
    const payload={action:'save_photo',imei1:String(row.imei1),photoBase64:row.photoLocal,store:String(row.store||'Admin'),filename:String(row.imei1)+'_'+Date.now()+'.jpg'};
    const res=await fetch(scriptUrl,{method:'POST',body:JSON.stringify(payload),headers:{'Content-Type':'text/plain'}});
    const text=await res.text();
    let d;try{d=JSON.parse(text);}catch(e){showFb('‚ö† Error foto','error');return;}
    if(d.success){row.photoUrl=d.photoUrl;row.photoLocal=null;saveData();renderTables();showFb('üì∏ Foto guardada en Drive ‚úì','success');}
    else showFb('‚ö† Error Drive: '+d.error,'error');
  }catch(e){showFb('‚ö† Error de red al subir foto','error');}
}
async function retrySyncAll(){
  const p=inv.filter(r=>r.syncStatus==='pending'||r.syncStatus==='error');
  for(const r of p)await syncEntry(r);
  const np=inv.filter(r=>r.photoLocal&&!r.photoUrl);
  for(const r of np)await uploadPhoto(r);
}
function updateQueueBar(){
  const n=inv.filter(r=>r.syncStatus==='pending'||r.syncStatus==='error').length;
  document.getElementById('q-count').textContent=n;
  document.getElementById('queue-bar').classList.toggle('hidden',n===0);
}

// ‚îÄ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ
function updateStats(){
  const s=inv.filter(r=>String(r.stock)==='1'||r.stock===1).length;
  const o=mov.filter(r=>r.type&&r.type.includes('SALIDA')).length;
  const t=s+o;
  const cntStock=document.getElementById('cnt-stock');
  const cntOut=document.getElementById('cnt-out');
  const cntTotal=document.getElementById('cnt-total');
  if(cntStock) cntStock.textContent=s;
  if(cntOut)   cntOut.textContent=o;
  if(cntTotal) cntTotal.textContent=t;
}
function updateStoreSelects(){
  // Poblar selects de tienda con nombres reales de USERS
  const storeNames=Object.values(USERS)
    .filter(u=>u.role==='store'&&u.store)
    .map(u=>u.store)
    .sort();
  const opts='<option value="">Todas las tiendas</option>'+storeNames.map(s=>`<option value="${s}">${s}</option>`).join('');
  const sel=document.getElementById('f-store');
  if(sel){ const cur=sel.value; sel.innerHTML=opts; if(cur) sel.value=cur; }
}

function renderTables(){
  updateStoreSelects();
  updateStats();
  const si=s=>s==='synced'?'<span style="color:var(--success)">‚úì</span>':s==='sending'?'<span class="spin">‚ü≥</span>':s==='error'?'<span style="color:var(--rose2)">‚úó</span>':'<span style="color:var(--warning)">‚è≥</span>';
  const stBadge=s=>{const v=String(s||'').toLowerCase();if(v.includes('nuevo'))return`<span class="st-nuevo">${s}</span>`;if(v.includes('semi'))return`<span class="st-semi">${s}</span>`;if(v.includes('reac'))return`<span class="st-reac">${s}</span>`;if(v.includes('repar'))return`<span class="st-rep">${s}</span>`;return s?`<span class="st-otro">${s}</span>`:'‚Äî';};
  const isAdmin=currentUser&&currentUser.role==='admin';

  // ‚îÄ‚îÄ Tabla Inventario ‚îÄ‚îÄ con b√∫squeda
  const tbi=document.getElementById('tb-inv');
  const qInv=(document.getElementById('search-inv')?.value||'').toLowerCase().trim();
  const filteredInv=qInv
    ?inv.filter(r=>[r.imei1,r.imei2,r.brand,r.model,r.color,r.storage,r.serial,r.store]
        .some(v=>String(v||'').toLowerCase().includes(qInv)))
    :inv;
  const cntInvEl=document.getElementById('search-inv-count');
  if(cntInvEl) cntInvEl.textContent=qInv?`${filteredInv.length} resultado${filteredInv.length!==1?'s':''} de ${inv.length} equipos`:'';
  if(!filteredInv.length){
    tbi.innerHTML=qInv
      ?`<tr><td colspan="12"><div class="empty-state"><div class="big">üîç</div><p>Sin resultados para "<strong>${qInv}</strong>"</p></div></td></tr>`
      :`<tr><td colspan="12"><div class="empty-state"><div class="big">üì±</div><p>Sin equipos registrados</p></div></td></tr>`;
  } else {
    tbi.innerHTML=filteredInv.map((r,i)=>`<tr class="${r.fresh?'nr':''}">
      <td style="color:var(--muted);font-size:10px;font-family:'JetBrains Mono',monospace">${filteredInv.length-i}</td>
      <td>${r.photoUrl?`<img src="${r.photoUrl}" class="pt" onerror="this.style.display='none'">`:r.photoLocal?`<img src="${r.photoLocal}" class="pt">`:'‚Äî'}</td>
      <td><span class="store-tag">${r.store||'‚Äî'}</span></td>
      <td class="imei-c">${r.imei1}</td>
      <td style="font-size:12px">${r.brand||'‚Äî'}</td>
      <td style="font-size:12px;max-width:90px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${r.model||''}">${r.model||'‚Äî'}</td>
      <td style="font-size:11px">${r.color||'‚Äî'}</td>
      <td style="font-family:'JetBrains Mono',monospace;font-size:11px">${r.storage||'‚Äî'}</td>
      <td style="font-family:'JetBrains Mono',monospace;font-size:11px">${r.price?'$'+parseFloat(r.price).toFixed(2):'‚Äî'}</td>
      <td>${stBadge(r.status)}</td>
      <td><span class="${(String(r.stock)==='1'||r.stock===1)?'s1':'s0'}">${(String(r.stock)==='1'||r.stock===1)?'‚úì Disp':'‚úó Baja'}</span></td>
      <td>${si(r.syncStatus)}</td>
      ${isAdmin?`<td><button class="del-btn" onclick="openDeleteModal('${r.imei1}')">üóë Eliminar</button></td>`:''}
    </tr>`).join('');
    filteredInv.forEach(r=>r.fresh=false);
  }

  // ‚îÄ‚îÄ Tabla Movimientos ‚îÄ‚îÄ con b√∫squeda
  const tbm=document.getElementById('tb-mov');
  const fStore=document.getElementById('f-store')?.value||'';
  const fType=document.getElementById('f-type')?.value||'';
  const qMov=(document.getElementById('search-mov')?.value||'').toLowerCase().trim();
  let fm=mov;
  if(fStore) fm=fm.filter(r=>r.store===fStore);
  if(fType)  fm=fm.filter(r=>r.type&&r.type.includes(fType));
  if(qMov)   fm=fm.filter(r=>[r.imei1,r.brand,r.model,r.color,r.storage,r.store,r.notes]
               .some(v=>String(v||'').toLowerCase().includes(qMov)));
  const cntMovEl=document.getElementById('search-mov-count');
  if(cntMovEl) cntMovEl.textContent=qMov?`${fm.length} resultado${fm.length!==1?'s':''} de ${mov.length} movimientos`:'';
  if(!fm.length){
    tbm.innerHTML=qMov
      ?`<tr><td colspan="12"><div class="empty-state"><div class="big">üîç</div><p>Sin resultados para "<strong>${qMov}</strong>"</p></div></td></tr>`
      :`<tr><td colspan="12"><div class="empty-state"><div class="big">üìã</div><p>Sin movimientos</p></div></td></tr>`;
  } else {
    tbm.innerHTML=fm.map((r,i)=>`<tr>
      <td style="color:var(--muted);font-size:10px;font-family:'JetBrains Mono',monospace">${fm.length-i}</td>
      <td><span class="store-tag">${r.store||'‚Äî'}</span></td>
      <td><span class="${r.type&&r.type.includes('ENTRADA')?'badge-in':'badge-out'}">${r.type&&r.type.includes('ENTRADA')?'‚úÖ ENTRADA':'üî¥ SALIDA'}</span></td>
      <td class="imei-c">${r.imei1||'‚Äî'}</td>
      <td style="font-size:12px">${r.brand||'‚Äî'}</td>
      <td style="font-size:12px">${r.model||'‚Äî'}</td>
      <td>${stBadge(r.status)}</td>
      <td style="font-family:'JetBrains Mono',monospace;font-size:11px">${r.price?'$'+parseFloat(r.price).toFixed(2):'‚Äî'}</td>
      <td style="font-family:'JetBrains Mono',monospace;font-size:11px;color:${r.salePrice?'var(--success)':'var(--muted)'}">${r.salePrice?'$'+parseFloat(r.salePrice).toFixed(2):'‚Äî'}</td>
      <td style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--muted)">${r.date||'‚Äî'}</td>
      <td style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--muted)">${r.time||'‚Äî'}</td>
      <td style="font-size:11px;color:var(--muted)">${r.notes||'‚Äî'}</td>
      ${isAdmin?`<td><button class="del-btn" onclick="openDeleteMovModal(${mov.indexOf(r)})">üóë</button></td>`:''}
    </tr>`).join('');
  }
  updateQueueBar();
}
function showTab(t){
  curTab=t;
  ['inv','mov','rep'].forEach(x=>{
    document.getElementById('tab-'+x)?.classList.toggle('active',x===t);
    const el=document.getElementById('tw-'+x);if(el)el.style.display=x===t?'block':'none';
  });
  // Al cambiar a cualquier pesta√±a: renderizar con datos en memoria PRIMERO
  // luego recargar desde Sheets para tener info fresca
  if(t==='rep'){
    renderReports();
    loadFromSheets().then(()=>renderReports());
  } else if(t==='inv'||t==='mov'){
    renderTables();
    loadFromSheets();
  }
}

// ‚îÄ‚îÄ‚îÄ REPORTS ‚îÄ‚îÄ‚îÄ (con valor en dinero por tienda)
function fmt$(val){
  const n=parseFloat(val)||0;
  return '$'+n.toLocaleString('es-MX',{minimumFractionDigits:2,maximumFractionDigits:2});
}
function renderReports(){
  // Nombres reales desde USERS (respeta los cambios del m√≥dulo de usuarios)
  const storeNames=Object.values(USERS)
    .filter(u=>u.role==='store'&&u.store)
    .map(u=>u.store);
  // Completar con tiendas que aparezcan en datos pero no est√©n en USERS
  const allFromData=[...inv.map(r=>r.store),...mov.map(r=>r.store)].filter(s=>s&&s!=='null'&&s!=='undefined'&&s!=='Admin');
  const stores=[...new Set([...storeNames,...allFromData])].sort();

  // Fuente unica de verdad: tabla mov para entradas/salidas; inv para stock real
  const ts=inv.filter(r=>String(r.stock)==='1'||r.stock===1).length;
  const gEntradas=mov.filter(r=>r.type&&r.type.includes('ENTRADA')).length;
  const gSalidas=mov.filter(r=>r.type&&r.type.includes('SALIDA')).length;
  const gTotal=gEntradas+gSalidas; // mov.length puede tener otros tipos; sumamos explicitamente

  // Total global en dinero (stock activo)
  const globalMoney=inv
    .filter(r=>String(r.stock)==='1'||r.stock===1)
    .reduce((sum,r)=>sum+(parseFloat(r.price)||0),0);

  let html=`
  <div class="rep-section-title">Resumen Global</div>
  <div class="rep-grid">
    <div class="stat-card"><div class="sc-val" style="color:var(--success)">${ts}</div><div class="sc-lbl">üì¶ En Stock</div></div>
    <div class="stat-card"><div class="sc-val" style="color:var(--rose2)">${gSalidas}</div><div class="sc-lbl">üî¥ Salidas</div></div>
    <div class="stat-card"><div class="sc-val" style="color:var(--purple3)">${gEntradas}</div><div class="sc-lbl">‚úÖ Entradas</div></div>
    <div class="stat-card"><div class="sc-val" style="color:var(--warning)">${gTotal}</div><div class="sc-lbl">üìã Movimientos</div></div>
  </div>
  <div class="global-money-card">
    <div class="global-money-val">${fmt$(globalMoney)}</div>
    <div class="global-money-lbl">üí∞ Valor total del stock en todas las tiendas</div>
  </div>
  <div class="rep-section-title">Por Tienda</div>
  <div class="store-grid">`;

  stores.forEach(store=>{
    const si=inv.filter(r=>r.store===store);
    const ss=si.filter(r=>String(r.stock)==='1'||r.stock===1);
    const se=mov.filter(r=>r.store===store&&r.type&&r.type.includes('ENTRADA')).length;
    const sx=mov.filter(r=>r.store===store&&r.type&&r.type.includes('SALIDA')).length;
    const so=sx; // salidas = movimientos de tipo SALIDA (no stock=0 del inventario)
    // Valor en dinero del stock activo de esta tienda
    const storeMoney=ss.reduce((sum,r)=>sum+(parseFloat(r.price)||0),0);

    // Desglose por estado del stock activo
    const byStatus={};
    ss.forEach(r=>{
      const st=String(r.status||'Sin estado').trim()||'Sin estado';
      byStatus[st]=(byStatus[st]||0)+1;
    });
    const statusRows=Object.entries(byStatus)
      .sort((a,b)=>b[1]-a[1])
      .map(([st,cnt])=>{
        const cls=st.toLowerCase().includes('nuevo')?'st-nuevo':st.toLowerCase().includes('semi')?'st-semi':st.toLowerCase().includes('reac')?'st-reac':st.toLowerCase().includes('repar')?'st-rep':'st-otro';
        return `<div style="display:flex;align-items:center;justify-content:space-between;padding:3px 0"><span class="${cls}">${st}</span><span style="font-weight:700;font-size:12px">${cnt}</span></div>`;
      }).join('');

    html+=`<div class="store-card">
      <div class="store-card-name"><span>üè™</span><span style="background:var(--grad-mix);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-size:15px">${store}</span></div>
      <div class="store-stats">
        <div class="ss-item" style="background:rgba(42,122,74,.08)"><div class="ss-n" style="color:var(--success)">${ss.length}</div><div class="ss-l">En Stock</div></div>
        <div class="ss-item" style="background:rgba(212,92,92,.08)"><div class="ss-n" style="color:var(--rose2)">${sx}</div><div class="ss-l">Salidas</div></div>
        <div class="ss-item" style="background:rgba(124,92,191,.08)"><div class="ss-n" style="color:var(--purple3)">${se}</div><div class="ss-l">Entradas</div></div>
        <div class="ss-item" style="background:rgba(154,104,0,.08)"><div class="ss-n" style="color:var(--warning)">${se+sx}</div><div class="ss-l">Movim.</div></div>
      </div>
      ${statusRows?`<div style="border-top:1px solid var(--border);margin-top:10px;padding-top:10px">
        <div style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">Estado del stock</div>
        ${statusRows}
      </div>`:''}
      <div class="store-money-row">
        <span class="store-money-lbl">üí∞ Valor stock</span>
        <span class="store-money-val">${fmt$(storeMoney)}</span>
      </div>
    </div>`;
  });
  html+='</div>';
  document.getElementById('rep-content').innerHTML=html;
  // Actualizar timestamp de √∫ltima sincronizaci√≥n
  const repSyncEl=document.getElementById('rep-sync-info');
  if(repSyncEl){
    const now=new Date();
    const hm=now.toLocaleTimeString('es-MX',{hour:'2-digit',minute:'2-digit'});
    repSyncEl.textContent='√öltima actualizaci√≥n: '+hm+' ¬∑ '+inv.length+' equipos ¬∑ '+mov.length+' movimientos';
  }
}

function resetAll(){
  sv={imei1:'',imei2:'',serial:''};currentStep=1;updateStepUI();selColor='';photoData=null;
  ['f-imei1','f-imei2','f-serial','f-price','f-notes'].forEach(id=>{const el=document.getElementById(id);if(el){el.value='';el.classList.remove('fc-ok');}});
  document.getElementById('f-brand').value='';
  document.getElementById('f-model').innerHTML='<option value="">‚Äî Selecciona marca ‚Äî</option><option value="__m__">‚úèÔ∏è Escribir manualmente...</option>';
  document.getElementById('f-model').disabled=true;
  document.getElementById('f-model-m').style.display='none';document.getElementById('f-model-m').value='';
  document.getElementById('f-color').innerHTML='<option value="">‚Äî</option>';
  document.getElementById('color-sw').innerHTML='';
  document.getElementById('f-storage').value='';document.getElementById('f-status').value='Nuevo';
  document.getElementById('photo-img').style.display='none';document.getElementById('photo-img').src='';
  document.getElementById('no-photo').style.display='flex';
  document.getElementById('photo-input').value='';document.getElementById('gallery-input').value='';

}
function showFb(msg,type,duration){
  const el=document.getElementById('feedback');
  if(el){el.className='feedback '+type;el.textContent=msg;clearTimeout(el._t);if(msg)el._t=setTimeout(()=>el.className='feedback',6000);}
  showToast(msg,type,duration||4000);
}
function showToast(msg,type,ms){
  if(!msg)return;
  const con=document.getElementById('toast-container');
  const t=document.createElement('div');
  t.className='toast t-'+(type||'info');
  const icon={success:'‚úÖ',error:'‚ùå',pending:'‚è≥',info:'‚ÑπÔ∏è',notif:'üîî'}[type]||'üì¢';
  t.innerHTML=icon+' <span>'+msg+'</span>';
  con.appendChild(t);
  const dur=ms||4000;
  const rm=()=>{t.style.animation='none';t.style.opacity='0';t.style.transform='scale(.85)';t.style.transition='all .25s ease';setTimeout(()=>t.remove(),260);};
  t._to=setTimeout(rm,dur);
  t.onclick=()=>{clearTimeout(t._to);rm();};
}
function setSP(state,text){
  const p=document.getElementById('sync-pill');
  const cls={ok:'sp-ok',send:'sp-send',err:'sp-err',idle:'sp-idle'};
  p.className='sync-pill '+(cls[state]||'sp-idle');
  p.innerHTML=state==='send'?`<span class="spin">‚ü≥</span> ${text}`:text;
}
function exportCSV(){
  const isInv=curTab==='inv';const data=isInv?inv:mov;
  if(!data.length){showFb('No hay datos','error');return;}
  let h,b;
  if(isInv){h=['#','Tienda','IMEI1','IMEI2','Serial','Marca','Modelo','Color','GB','Precio','Estado','Fecha','Stock','FotoURL'];b=data.map((r,i)=>[data.length-i,r.store||'',r.imei1,r.imei2||'',r.serial||'',r.brand||'',`"${r.model||''}"`,r.color||'',r.storage||'',r.price||'',r.status||'',r.date,r.stock,r.photoUrl||''].join(','));}
  else{h=['#','Tienda','Tipo','IMEI1','Marca','Modelo','GB','Precio','Estado','Fecha','Hora','Notas'];b=data.map((r,i)=>[data.length-i,r.store||'',r.type,r.imei1,r.brand||'',`"${r.model||''}"`,r.storage||'',r.price||'',r.status||'',r.date,r.time,`"${r.notes||''}"`].join(','));}
  const blob=new Blob([[h.join(','),...b].join('\n')],{type:'text/csv;charset=utf-8;'});
  Object.assign(document.createElement('a'),{href:URL.createObjectURL(blob),download:`${isInv?'inventario':'movimientos'}_${new Date().toISOString().slice(0,10)}.csv`}).click();
}
function openClearModal(){document.getElementById('modal-clear').classList.add('open');}
function closeModal(id){document.getElementById(id).classList.remove('open');}
function clearAll(){inv=[];mov=[];saveData();renderTables();closeModal('modal-clear');}

// ‚îÄ‚îÄ‚îÄ ELIMINAR IMEI ‚îÄ‚îÄ‚îÄ
let pendingDeleteImei='';
function openDeleteModal(imei1){
  pendingDeleteImei=imei1;
  document.getElementById('modal-del-txt').textContent='Se eliminar√° el IMEI '+imei1+' del inventario.';
  document.getElementById('modal-del').classList.add('open');
}
async function confirmDelete(){
  closeModal('modal-del');
  if(!pendingDeleteImei)return;
  const imei1=pendingDeleteImei;
  const idx=inv.findIndex(r=>String(r.imei1).trim()===imei1);
  if(idx>-1)inv.splice(idx,1);
  saveData();renderTables();updateStats();
  showFb('üóë Eliminando de Sheets...','pending');
  if(isValidUrl(scriptUrl)){
    try{
      const res=await fetch(scriptUrl,{method:'POST',body:JSON.stringify({action:'delete_imei',imei1,role:currentUser.role}),headers:{'Content-Type':'text/plain'}});
      const text=await res.text();
      let d;try{d=JSON.parse(text);}catch(e){d={success:false,error:'Respuesta inv√°lida'};}
      showFb(d.success?'‚úÖ IMEI eliminado':'‚ö† Eliminado local, error Sheets: '+d.error,d.success?'success':'error');
    }catch(e){showFb('‚ö† Eliminado localmente. Sin conexi√≥n.','error');}
  }else showFb('‚úÖ Eliminado localmente','success');
}

// ‚îÄ‚îÄ‚îÄ ELIMINAR MOVIMIENTO ‚îÄ‚îÄ‚îÄ
let pendingDeleteMovIdx=-1;
function openDeleteMovModal(globalIdx){
  pendingDeleteMovIdx=globalIdx;
  const r=mov[globalIdx];
  if(!r)return;
  const tipo=r.type&&r.type.includes('ENTRADA')?'ENTRADA':'SALIDA';
  document.getElementById('modal-del-mov-txt').textContent='Eliminar movimiento '+tipo+' del IMEI '+r.imei1+' ('+r.date+' '+r.time+').';
  document.getElementById('modal-del-mov').classList.add('open');
}
async function confirmDeleteMov(){
  closeModal('modal-del-mov');
  if(pendingDeleteMovIdx<0)return;
  const r=mov[pendingDeleteMovIdx];
  if(!r)return;
  mov.splice(pendingDeleteMovIdx,1);
  pendingDeleteMovIdx=-1;
  saveData();renderTables();
  showFb('üóë Eliminando movimiento de Sheets...','pending');
  if(isValidUrl(scriptUrl)){
    try{
      const res=await fetch(scriptUrl,{method:'POST',body:JSON.stringify({action:'delete_mov',imei1:r.imei1,date:r.date,time:r.time,type:r.type,role:currentUser.role}),headers:{'Content-Type':'text/plain'}});
      const text=await res.text();
      let d;try{d=JSON.parse(text);}catch(e){d={success:false,error:'Respuesta inv√°lida'};}
      showFb(d.success?'‚úÖ Movimiento eliminado':'‚ö† Eliminado local, error Sheets: '+d.error,d.success?'success':'error');
    }catch(e){showFb('‚ö† Eliminado localmente. Sin conexi√≥n.','error');}
  }else showFb('‚úÖ Movimiento eliminado localmente','success');
}

// ‚îÄ‚îÄ‚îÄ BULK IMPORT ‚îÄ‚îÄ‚îÄ
let bulkRows=[];
let bulkImporting=false;

function openBulkModal(){
  // Reset estado del modal
  bulkRows=[];
  document.getElementById('bulk-file').value='';
  document.getElementById('bulk-file-name').textContent='';
  document.getElementById('bulk-preview').style.display='none';
  document.getElementById('bulk-status').textContent='';
  document.getElementById('bulk-progress-wrap').style.display='none';
  document.getElementById('bulk-result').style.display='none';
  document.getElementById('bulk-import-btn').disabled=true;
  document.getElementById('bulk-import-btn').style.display='';
  document.getElementById('bulk-cancel-btn').textContent='Cancelar';
  document.getElementById('bulk-drop').style.display='';
  document.getElementById('modal-bulk').classList.add('open');
}

function downloadTemplate(){
  // Crear plantilla Excel con columnas correctas y 3 filas de ejemplo
  const ws_data = [
    ['IMEI1','IMEI2','Serial','Marca','Modelo','Color','GB','Precio','Estado','Tienda','Notas'],
    ['351234567890123','351234567890124','SN123456','Apple','iPhone 13','Negro','128GB','15000','Seminuevo','Tienda 1','Buen estado'],
    ['352345678901234','','SN234567','Samsung','Galaxy S23','Blanco','256GB','12000','Nuevo','Tienda 2',''],
    ['353456789012345','','SN345678','Xiaomi','Redmi Note 13','Azul','128GB','6500','Reacondicionado','Tienda 1','Bater√≠a al 90%'],
  ];
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(ws_data);
  // Ancho de columnas
  ws['!cols'] = [{wch:18},{wch:18},{wch:14},{wch:12},{wch:20},{wch:12},{wch:8},{wch:10},{wch:15},{wch:12},{wch:25}];
  XLSX.utils.book_append_sheet(wb, ws, 'Inventario');
  XLSX.writeFile(wb, 'plantilla_anicode_pro.xlsx');
}

function onBulkDrop(e){
  e.preventDefault();
  e.currentTarget.style.borderColor='var(--border)';
  e.currentTarget.style.background='';
  const f=e.dataTransfer.files[0];
  if(f)processBulkFile(f);
}
function onBulkFile(e){const f=e.target.files[0];if(f)processBulkFile(f);}

function processBulkFile(file){
  document.getElementById('bulk-file-name').textContent='‚è≥ Leyendo '+file.name+'...';
  document.getElementById('bulk-status').textContent='';
  document.getElementById('bulk-result').style.display='none';
  const reader=new FileReader();
  reader.onload=function(ev){
    const data=new Uint8Array(ev.target.result);
    let rows=[];
    if(file.name.toLowerCase().endsWith('.csv')){
      const text=new TextDecoder('utf-8').decode(data);
      rows=parseCSV(text);
    } else {
      try{
        const wb=XLSX.read(data,{type:'array',cellText:false,cellDates:true});
        const ws=wb.Sheets[wb.SheetNames[0]];
        // raw:true preserva los n√∫meros exactos (evita notaci√≥n cient√≠fica en IMEI)
        rows=XLSX.utils.sheet_to_json(ws,{defval:'',raw:true});
      }catch(ex){
        document.getElementById('bulk-status').textContent='‚ùå Error leyendo archivo: '+ex.message;
        document.getElementById('bulk-file-name').textContent='';
        return;
      }
    }
    if(!rows.length){
      document.getElementById('bulk-status').textContent='‚ùå No se encontraron filas en el archivo';
      document.getElementById('bulk-file-name').textContent='';
      return;
    }
    const allRows=rows.map(r=>normalizeBulkRow(r));
    const validRows=allRows.filter(r=>r.imei1&&r.imei1.length>=14);
    const invalidCount=allRows.length-validRows.length;
    bulkRows=validRows;
    document.getElementById('bulk-file-name').textContent='‚úÖ '+file.name;
    renderBulkPreview(invalidCount);
  };
  reader.readAsArrayBuffer(file);
}

function normalizeBulkRow(r){
  // Convierte un valor a string limpio, manejando floats de Excel (ej: 359439060626008.0)
  const cleanVal=(v)=>{
    if(v===null||v===undefined||v==='')return '';
    // Si es n√∫mero (IMEI guardado como n√∫mero en Excel)
    if(typeof v==='number'){
      // Evitar notaci√≥n cient√≠fica y quitar decimales .0
      // Usar toFixed(0) para enteros, luego convertir
      const s=Number.isInteger(v)?String(v):String(Math.round(v));
      return s.trim();
    }
    return String(v).trim();
  };

  const g=(keys)=>{
    for(const k of keys){
      for(const rk of Object.keys(r)){
        if(rk.toLowerCase().replace(/[_\s]/g,'')===k.toLowerCase().replace(/[_\s]/g,'')){
          return cleanVal(r[rk]);
        }
      }
    }
    return '';
  };
  return {
    imei1:   g(['imei1','imei','imei_1','imei 1']),
    imei2:   g(['imei2','imei_2','imei 2']),
    serial:  g(['serial','serialnumber','numero_serie','no serie']),
    brand:   g(['marca','brand']),
    model:   g(['modelo','model']),
    color:   g(['color']),
    storage: g(['gb','storage','almacenamiento','capacidad']),
    price:   g(['precio','price','costo']),
    status:  g(['estado','status','condicion'])||'Nuevo',
    store:   g(['tienda','store','sucursal']),
    notes:   g(['notas','notes','observaciones','comentarios']),
  };
}

function parseCSV(text){
  const lines=text.split(/\r?\n/).filter(l=>l.trim());
  if(lines.length<2)return [];
  const sep=lines[0].includes(';')?';':',';
  const headers=lines[0].split(sep).map(h=>h.replace(/"/g,'').trim());
  return lines.slice(1).map(line=>{
    const vals=line.split(sep).map(v=>v.replace(/"/g,'').trim());
    const obj={};
    headers.forEach((h,i)=>obj[h]=vals[i]||'');
    return obj;
  });
}

function renderBulkPreview(invalidCount){
  if(!bulkRows.length){
    document.getElementById('bulk-status').textContent='‚ùå No se encontraron filas con IMEI v√°lido (m√≠nimo 14 d√≠gitos)';
    document.getElementById('bulk-import-btn').disabled=true;
    return;
  }
  const cols=['imei1','brand','model','color','storage','price','status','store'];
  const colLabels={'imei1':'IMEI1','brand':'Marca','model':'Modelo','color':'Color','storage':'GB','price':'Precio','status':'Estado','store':'Tienda'};
  document.getElementById('bulk-thead').innerHTML='<tr>'+cols.map(c=>`<th style="padding:6px 8px;background:var(--surface2);color:var(--muted);font-size:10px;white-space:nowrap">${colLabels[c]||c}</th>`).join('')+'</tr>';
  document.getElementById('bulk-tbody').innerHTML=bulkRows.slice(0,8).map(r=>
    '<tr>'+cols.map(c=>`<td style="padding:5px 8px;font-size:11px;border-bottom:1px solid var(--border)">${r[c]||'<span style=color:var(--muted)>‚Äî</span>'}</td>`).join('')+'</tr>'
  ).join('');
  document.getElementById('bulk-preview').style.display='block';

  // Contar duplicados para info
  const dupCount=bulkRows.filter(r=>{
    const ex=inv.find(x=>String(x.imei1).trim()===r.imei1);
    return ex&&(String(ex.stock)==='1'||ex.stock===1);
  }).length;
  const newCount=bulkRows.length-dupCount;

  let statusHtml=`<span style="color:var(--success);font-weight:700">‚úÖ ${bulkRows.length} equipos detectados</span>`;
  if(newCount>0) statusHtml+=` ¬∑ <span style="color:var(--purple3)">${newCount} nuevos</span>`;
  if(dupCount>0) statusHtml+=` ¬∑ <span style="color:var(--warning)">${dupCount} ya en stock (se omitir√°n)</span>`;
  if(invalidCount>0) statusHtml+=` ¬∑ <span style="color:var(--rose2)">${invalidCount} filas inv√°lidas ignoradas</span>`;
  document.getElementById('bulk-status').innerHTML=statusHtml;
  document.getElementById('bulk-import-btn').disabled=newCount===0;
}

async function doBulkImport(){
  if(!bulkRows.length||bulkImporting)return;
  bulkImporting=true;

  // Preparar UI para importaci√≥n
  document.getElementById('bulk-import-btn').style.display='none';
  document.getElementById('bulk-cancel-btn').textContent='Cerrar';
  document.getElementById('bulk-drop').style.display='none';
  document.getElementById('bulk-preview').style.display='none';
  document.getElementById('bulk-progress-wrap').style.display='block';
  document.getElementById('bulk-result').style.display='none';

  const rowsToImport=bulkRows.filter(r=>{
    const ex=inv.find(x=>String(x.imei1).trim()===r.imei1);
    return !(ex&&(String(ex.stock)==='1'||ex.stock===1));
  });
  const total=rowsToImport.length;
  const dup=bulkRows.length-total;
  let ok=0,err=0;

  const now=new Date();
  const date=now.toLocaleDateString('es-MX');
  const time=now.toLocaleTimeString('es-MX',{hour:'2-digit',minute:'2-digit'});

  for(let i=0;i<rowsToImport.length;i++){
    const r=rowsToImport[i];
    const pct=Math.round(((i+1)/total)*100);
    document.getElementById('bulk-progress-bar').style.width=pct+'%';
    document.getElementById('bulk-progress-txt').textContent=pct+'%';
    document.getElementById('bulk-progress-detail').textContent=`(${i+1}/${total}) ${r.brand||''} ${r.model||''} ¬∑ ${r.imei1}`;

    // Determinar tienda: usar la del excel si existe, sino la del usuario actual
    const rowStore=r.store||currentUser.store||'Admin';
    const row={
      imei1:r.imei1,imei2:r.imei2||'',serial:r.serial||'',
      brand:r.brand||'',model:r.model||'',
      color:r.color||'',storage:r.storage||'',price:r.price||'',
      status:r.status||'Nuevo',notes:r.notes||'Carga masiva',
      date,time,store:rowStore,
      photoLocal:null,photoUrl:'',stock:'1',
      syncStatus:'pending',fresh:true
    };
    inv.unshift(row);
    const m={type:'ENTRADA',store:rowStore,imei1:row.imei1,brand:row.brand,model:row.model,
             color:row.color,storage:row.storage,price:row.price,status:row.status,
             date,time,notes:'Carga masiva Excel'};
    mov.unshift(m);

    if(isValidUrl(scriptUrl)){
      try{
        const res=await fetch(scriptUrl,{method:'POST',
          body:JSON.stringify({action:'entry',...row}),
          headers:{'Content-Type':'text/plain'}});
        const txt=await res.text();
        let d;try{d=JSON.parse(txt);}catch(ex){d={success:false};}
        row.syncStatus=d.success?'synced':'error';
        if(d.success)ok++;else{err++;row.syncStatus='error';}
      }catch(ex){row.syncStatus='error';err++;}
    } else {
      row.syncStatus='pending';ok++;
    }

    if(i%3===0){saveData();renderTables();updateStats();}
    await new Promise(resolve=>setTimeout(resolve,80));
  }

  saveData();renderTables();updateStats();
  initSeenMovs(); // actualizar snapshot para no re-notificar estos movimientos

  // Mostrar resultado
  const resultEl=document.getElementById('bulk-result');
  resultEl.style.display='block';
  if(err===0){
    resultEl.style.background='var(--success-bg)';
    resultEl.style.border='1px solid rgba(42,122,74,.25)';
    resultEl.style.color='var(--success)';
    resultEl.innerHTML=`‚úÖ Importaci√≥n completada<br><span style="font-weight:400;font-size:12px">${ok} equipos registrados${dup?' ¬∑ '+dup+' duplicados omitidos':''}</span>`;
  } else {
    resultEl.style.background='var(--warning-bg)';
    resultEl.style.border='1px solid rgba(154,104,0,.25)';
    resultEl.style.color='var(--warning)';
    resultEl.innerHTML=`‚ö†Ô∏è Importaci√≥n con errores<br><span style="font-weight:400;font-size:12px">${ok} guardados en Sheets ¬∑ ${err} errores de red${dup?' ¬∑ '+dup+' omitidos':''}</span>`;
  }
  document.getElementById('bulk-progress-detail').textContent='';
  document.getElementById('bulk-progress-bar').style.width='100%';

  bulkImporting=false;
  bulkRows=[];
  document.getElementById('bulk-file').value='';
}

// ‚îÄ‚îÄ‚îÄ GESTI√ìN DE USUARIOS ‚îÄ‚îÄ‚îÄ
// Los usuarios se almacenan en USERS (en memoria) y en Sheets (hoja Usuarios)
// Al abrir el modal se cargan desde Sheets; al guardar se actualiza Sheets y USERS

function openUsersModal(){
  document.getElementById('modal-users').classList.add('open');
  renderUsersTable();
  loadUserLog();
}

function renderUsersTable(){
  const tbody = document.getElementById('users-tbody');
  const rows = Object.entries(USERS).map(([username, u]) => {
    const roleBadge = `<span class="role-badge ${u.role}">${u.role==='admin'?'üëë Admin':u.role==='leader'?'üëÅ L√≠der':'üè™ Tienda'}</span>`;
    const nameField = u.role==='admin'
      ? `<span style="color:var(--muted);font-size:12px">${u.name}</span>`
      : `<input class="edit-field" id="uname-${username}" value="${u.name||u.store||''}" placeholder="Nombre de tienda" style="max-width:160px">`;
    return `<tr>
      <td style="font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--purple3);font-weight:700">${username}</td>
      <td>${roleBadge}</td>
      <td>${nameField}</td>
      <td><input class="edit-field" id="upass-${username}" type="password" placeholder="Nueva contrase√±a" style="max-width:160px" ${u.role==='admin'?'':''}></td>
      <td>${u.role!=='admin'?`<button class="save-user-btn" onclick="saveUser('${username}')">üíæ Guardar</button>`:
        `<button class="save-user-btn" onclick="saveUser('${username}')">üíæ Guardar</button>`}</td>
    </tr>`;
  });
  tbody.innerHTML = rows.join('');
}

async function saveUser(username){
  const u = USERS[username];
  if(!u){ showFb('‚ö† Usuario no encontrado','error'); return; }

  const passEl  = document.getElementById('upass-'+username);
  const nameEl  = document.getElementById('uname-'+username);
  const newPass = passEl ? passEl.value.trim() : '';
  const newName = nameEl ? nameEl.value.trim() : '';

  // Obtener valores anteriores reales para comparar
  const oldPass  = u.password;
  const oldName  = u.name || u.store || '';

  // Detectar cambios reales
  const changes = [];
  const passChanged = newPass && newPass !== oldPass;
  const nameChanged = newName && u.role!=='admin' && newName !== oldName;

  if(!passChanged && !nameChanged){
    showFb('‚Ñπ Sin cambios ‚Äî escribe una nueva contrase√±a o modifica el nombre','pending');
    return;
  }

  const btn = document.querySelector(`button[onclick="saveUser('${username}')"]`);
  if(btn){ btn.disabled=true; btn.textContent='‚ü≥ Guardando...'; }

  // Aplicar cambios en memoria
  if(passChanged){
    changes.push({field:'password', old:'***', new:'***'});
    USERS[username].password = newPass;
  }
  if(nameChanged){
    changes.push({field:'name', old:oldName, new:newName});
    USERS[username].name  = newName;
    USERS[username].store = newName;
    // Si est√° logueado como esta tienda, actualizar sesi√≥n activa
    if(currentUser && currentUser.username===username){
      currentUser.name  = newName;
      currentUser.store = newName;
      try{ LS.setItem('imei_user', JSON.stringify(currentUser)); }catch(e){}
    }
  }
  // Guardar en cach√© local inmediatamente (persiste aunque Sheets falle)
  saveUsersCache();

  // Guardar en Sheets
  if(isValidUrl(scriptUrl)){
    try{
      const payload = {
        action:    'save_user',
        username,
        password:  USERS[username].password,
        name:      USERS[username].name,
        store:     USERS[username].store,
        role:      u.role,
        changedBy: currentUser.username,
        changes:   JSON.stringify(changes)
      };
      // Usar GET con params para evitar redirecci√≥n POST‚ÜíGET de Apps Script
      const params = new URLSearchParams({
        action:    'save_user',
        username,
        password:  payload.password,
        name:      payload.name   ||'',
        store:     payload.store  ||'',
        role:      payload.role,
        changedBy: payload.changedBy,
        changes:   payload.changes
      });
      const res  = await fetch(scriptUrl+'?'+params.toString(),{
        method:'GET',
        cache:'no-store'
      });
      const text = await res.text();
      let d;
      try{ d=JSON.parse(text); }catch(e){ d={success:false,error:'Respuesta no JSON: '+text.substring(0,120)}; }
      if(d.success){
        showFb('‚úÖ '+username+' actualizado correctamente','success',4000);
        if(passEl) passEl.value='';
        updateStoreSelects(); // refrescar selects con nuevo nombre
        if(curTab==='rep') renderReports(); // refrescar reportes
        loadUserLog();
      } else {
        // Revertir cambios en memoria y cach√© si Sheets fall√≥
        USERS[username].password = oldPass;
        if(nameChanged){ USERS[username].name=oldName; USERS[username].store=oldName; }
        saveUsersCache();
        showFb('‚ö† Error Sheets: '+(d.error||'sin detalle'),'error',6000);
      }
    }catch(e){
      USERS[username].password = oldPass;
      if(nameChanged){ USERS[username].name=oldName; USERS[username].store=oldName; }
      saveUsersCache();
      showFb('‚ö† Error de red al guardar','error');
    }
  } else {
    showFb('‚úÖ Cambio aplicado localmente (configura Sheets para persistir)','success');
    if(passEl) passEl.value='';
  }

  if(btn){ btn.disabled=false; btn.textContent='üíæ Guardar'; }
}

async function loadUserLog(){
  const wrap = document.getElementById('user-log-wrap');
  if(!wrap) return;
  if(!isValidUrl(scriptUrl)){
    wrap.innerHTML='<div style="padding:14px;text-align:center;color:var(--muted);font-size:12px">Configura la URL de Sheets para ver el historial</div>';
    return;
  }
  wrap.innerHTML='<div style="padding:14px;text-align:center;color:var(--muted);font-size:12px">‚ü≥ Cargando...</div>';
  try{
    const url = scriptUrl+'?action=get_user_log&role=admin';
    const res  = await fetch(url,{cache:'no-store'});
    const text = await res.text();
    let d; try{ d=JSON.parse(text); }catch(e){ d={success:false}; }
    if(d.success && d.log && d.log.length){
      wrap.innerHTML = d.log.map(l=>`
        <div class="log-row">
          <span class="log-ts">${l.ts}</span>
          <span class="log-msg">${l.msg}</span>
          <span class="log-who">${l.by}</span>
        </div>`).join('');
    } else {
      wrap.innerHTML='<div style="padding:14px;text-align:center;color:var(--muted);font-size:12px">Sin cambios registrados a√∫n</div>';
    }
  }catch(e){
    wrap.innerHTML='<div style="padding:14px;text-align:center;color:var(--muted);font-size:12px">Error cargando historial</div>';
  }
}

// Cargar usuarios desde Sheets al iniciar (para tener la versi√≥n m√°s reciente)
async function loadUsersFromSheets(){
  if(!isValidUrl(scriptUrl)) return;
  try{
    // pre_login=1 indica que la petici√≥n viene antes de autenticarse
    const url = scriptUrl+'?action=get_users&role=admin&pre_login=1';
    const res  = await fetch(url,{cache:'no-store'});
    const text = await res.text();
    let d; try{ d=JSON.parse(text); }catch(e){ return; }
    if(d.success && d.users && d.users.length){
      let changed=false;
      d.users.forEach(u=>{
        if(!u.username) return;
        // Forzar todo a string (Sheets puede devolver n√∫meros)
        const pwd   = String(u.password||'').trim();
        const name  = String(u.name||'').trim();
        const store = String(u.store||'').trim();
        const role  = String(u.role||'store').trim();
        if(USERS[u.username]){
          if(pwd)   { USERS[u.username].password=pwd;           changed=true; }
          if(name)  { USERS[u.username].name=name;              changed=true; }
          if(store) { USERS[u.username].store=store;            changed=true; }
          if(role)  { USERS[u.username].role=role;              changed=true; }
        } else {
          USERS[u.username]={password:pwd,role,store:store||null,name:name||u.username};
          changed=true;
        }
      });
      if(changed){
        saveUsersCache();
        if(typeof updateStoreSelects==='function') updateStoreSelects();
        if(curTab==='rep' && typeof renderReports==='function') renderReports();
      }
    }
  }catch(e){
    // Silenciar ‚Äî fallo de red es esperado en modo offline
  }
}

// ‚îÄ‚îÄ‚îÄ POLLING NOTIFICACIONES ‚îÄ‚îÄ‚îÄ
// Usamos un Set de IDs para detectar movimientos NUEVOS sin importar el orden
let seenMovIds=new Set();
let notifInterval=null;

function buildMovId(m){
  // ID unico por movimiento: tienda+tipo+imei+fecha+hora
  return [m.store,m.type,m.imei1,m.date,m.time].join('|');
}

function initSeenMovs(){
  // Inicializar con los movimientos que ya existen al cargar
  seenMovIds=new Set(mov.map(m=>buildMovId(m)));
}

function startNotifPolling(){
  if(notifInterval)return;
  initSeenMovs();
  notifInterval=setInterval(async()=>{
    if(!isValidUrl(scriptUrl)||!currentUser)return;
    try{
      const isAdmin   = currentUser.role==='admin';
      const isLeader  = currentUser.role==='leader';
      const isStore   = currentUser.role==='store';

      // Admin y lider obtienen TODOS los movimientos para detectar novedades
      // Tienda solo obtiene los suyos
      const pollRole  = (isAdmin||isLeader) ? 'admin' : 'store';
      const pollStore = isStore ? (currentUser.store||'') : '';
      const url = scriptUrl+'?action=get_data&role='+encodeURIComponent(pollRole)+'&store='+encodeURIComponent(pollStore);
      const res = await fetch(url,{cache:'no-store'});
      const data = await res.json();
      if(!data.success)return;

      const freshMov = data.movements.map((r,i)=>({...r,id:i}));

      // Detectar movimientos nuevos (no vistos antes)
      const newMov = freshMov.filter(m=>!seenMovIds.has(buildMovId(m)));

      if(newMov.length>0){
        newMov.forEach(m=>{
          const tienda = String(m.store||'').trim()||'Sin tienda';
          const tipo   = String(m.type||'').trim();
          const brand  = String(m.brand||'').trim();
          const model  = String(m.model||'').trim();

          if(isAdmin){
            // Admin: campana con TODOS los movimientos de todas las tiendas
            addNotification(tienda,tipo,brand,model);

          } else if(isLeader){
            // Lider: campana con todos los movimientos (igual que admin)
            addNotification(tienda,tipo,brand,model);

          } else if(isStore){
            // Tienda: SOLO toast de sus PROPIOS movimientos registrados en otro dispositivo
            if(tienda===currentUser.store){
              showMovNotif(tienda,tipo,brand,model);
            }
            // Movimientos de otras tiendas: silencio total
          }
          seenMovIds.add(buildMovId(m));
        });

        // Actualizar datos locales
        const freshInv = data.inventory.map(r=>({...r,syncStatus:'synced',fresh:false}));

        if(isStore){
          // Tienda solo ve su propio inventario y movimientos
          inv = freshInv.filter(r=>r.store===currentUser.store);
          mov = freshMov.filter(r=>r.store===currentUser.store);
        } else {
          // Admin y lider ven todo
          inv = freshInv;
          mov = freshMov;
        }
        saveData();
        renderTables();
        updateStats();
        if(curTab==='rep') renderReports();
      }
    }catch(e){
      // Silenciar errores de red
    }
  },30000);
}
function stopNotifPolling(){
  if(notifInterval){clearInterval(notifInterval);notifInterval=null;}
  seenMovIds=new Set();
}
function showMovNotif(store,type,brand,model){
  const con=document.getElementById('toast-container');
  const t=document.createElement('div');
  t.className='toast t-notif';
  const ico=(type||'').includes('ENTRADA')?'üì¶':'üì§';
  t.innerHTML=ico+' <span><strong>'+store+'</strong> registr√≥ '+(type||'').toLowerCase()+': '+brand+' '+model+'</span>';
  con.appendChild(t);
  setTimeout(()=>{t.style.opacity='0';t.style.transition='all .3s';setTimeout(()=>t.remove(),300);},5000);
}

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ
if(scriptUrl)document.getElementById('url-inp').value=scriptUrl;
try{if(LS.getItem('inv_v5')){LS.removeItem('inv_v5');LS.removeItem('mov_v5');}}catch(e){}
if(currentUser&&scriptUrl&&scriptUrl.includes('/exec')){
  showApp();
  renderTables(); // render inmediato con lo que hay en localStorage
  updateStats();
  // Cargar usuarios PRIMERO para tener nombres y contrase√±as actualizadas
  loadUsersFromSheets().then(()=>{
    updateStoreSelects();
    loadFromSheets().then(()=>{
      renderTables();
      updateStats();
      if(curTab==='rep') renderReports();
      initSeenMovs();
      startNotifPolling();
    });
  });
}
else{currentUser=null;try{LS.removeItem('imei_user');}catch(e){}}
</script>
</body>
</html>
