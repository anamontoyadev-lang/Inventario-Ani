<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>IMEI Scanner Pro</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#1a1a1f; --bg2:#222228; --surface:#2a2a32; --surface2:#32323c;
  --border:#3a3a46; --text:#ede8f5; --muted:#8a84a0;
  --rose1:#bb7a7a; --rose2:#e39191; --rose3:#f2a2a2;
  --purple1:#351c75; --purple2:#6a329f; --purple3:#b4a7d6; --purple4:#d3bce8;
  --grad-rose:linear-gradient(135deg,#bb7a7a,#f2a2a2);
  --grad-purple:linear-gradient(135deg,#351c75,#6a329f,#b4a7d6);
  --grad-mix:linear-gradient(135deg,#6a329f,#e39191);
  --grad-soft:linear-gradient(135deg,#b4a7d6,#f2a2a2);
  --success:#a8d5b5; --warning:#e8c882; --danger:#e39191;
  --fs-xs:11px; --fs-sm:13px; --fs-md:15px; --fs-lg:17px;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html{height:100%;}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;font-size:var(--fs-sm);}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 80% 50% at 20% 0%,rgba(106,50,159,.12),transparent 60%),radial-gradient(ellipse 60% 40% at 80% 100%,rgba(187,122,122,.08),transparent 50%);pointer-events:none;z-index:0;}
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:var(--bg);}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}

/* Reportes: oculto por defecto, visible solo para admin y leader */
#tab-rep { display: none; }
body[data-role="admin"] #tab-rep,
body[data-role="leader"] #tab-rep { display: block; }
/* L√≠der: sin acceso a entrada/salida */
body[data-role="leader"] #mode-row { display: none !important; }
body[data-role="leader"] #step-bar { display: none !important; }
.login-screen{position:fixed;inset:0;z-index:200;display:flex;align-items:center;justify-content:center;background:var(--bg);padding:16px;}
.login-screen.hidden{display:none;}
.login-box{background:var(--surface);border:1px solid var(--border);border-radius:24px;padding:36px 28px;width:100%;max-width:400px;box-shadow:0 24px 80px rgba(53,28,117,.25);}
.login-logo{display:flex;align-items:center;gap:14px;margin-bottom:30px;}
.login-icon{width:56px;height:56px;background:var(--grad-purple);border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:28px;flex-shrink:0;box-shadow:0 8px 24px rgba(106,50,159,.4);}
.login-logo h1{font-size:22px;font-weight:700;background:var(--grad-soft);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.login-logo span{font-size:12px;color:var(--muted);display:block;margin-top:2px;}
.lf{margin-bottom:16px;}
.ll{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.7px;font-weight:600;display:block;margin-bottom:6px;}
.li{width:100%;background:var(--bg2);border:1.5px solid var(--border);border-radius:10px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:14px;padding:13px 14px;outline:none;transition:all .2s;}
.li:focus{border-color:var(--purple2);box-shadow:0 0 0 3px rgba(106,50,159,.15);}
.login-btn{width:100%;padding:15px;background:var(--grad-purple);border:none;border-radius:10px;color:#fff;font-family:'DM Sans',sans-serif;font-size:15px;font-weight:700;cursor:pointer;margin-top:8px;transition:all .2s;}
.login-btn:hover{transform:translateY(-1px);box-shadow:0 8px 24px rgba(106,50,159,.4);}
.login-err{background:rgba(227,145,145,.1);border:1px solid rgba(227,145,145,.3);color:var(--rose2);border-radius:8px;padding:11px 14px;font-size:13px;margin-top:12px;display:none;}
.login-err.vis{display:block;}
.url-sec{margin-top:20px;padding-top:16px;border-top:1px solid var(--border);}
.url-lbl{font-size:12px;color:var(--muted);margin-bottom:7px;display:block;}
.url-row{display:flex;gap:7px;}
.url-inp{flex:1;background:var(--bg2);border:1.5px solid var(--border);border-radius:8px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:11px;padding:9px 11px;outline:none;transition:border-color .2s;}
.url-inp:focus{border-color:var(--purple2);}
.url-inp.ok{border-color:var(--success);}
.url-btn{background:var(--surface2);border:1.5px solid var(--border);border-radius:8px;color:var(--text);font-size:12px;font-weight:600;padding:9px 14px;cursor:pointer;white-space:nowrap;transition:all .2s;}
.url-btn:hover{border-color:var(--purple3);color:var(--purple3);}

/* ‚îÄ‚îÄ‚îÄ APP ‚îÄ‚îÄ‚îÄ */
.app{position:relative;z-index:1;max-width:1100px;margin:0 auto;padding:14px;}
.app.hidden{display:none;}

/* TOPBAR */
.topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:12px 16px;gap:10px;flex-wrap:wrap;}
.tb-left{display:flex;align-items:center;gap:11px;}
.tb-icon{width:40px;height:40px;background:var(--grad-purple);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;}
.tb-title{font-size:15px;font-weight:700;background:var(--grad-soft);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.tb-sub{font-size:12px;color:var(--muted);}
.tb-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
.stats-row{display:flex;gap:14px;}
.stat-i{text-align:center;}
.stat-n{font-family:'JetBrains Mono',monospace;font-size:18px;font-weight:700;}
.stat-n.gn{color:var(--success);}
.stat-n.rd{color:var(--rose2);}
.stat-n.pu{color:var(--purple3);}
.stat-l{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;}
.user-chip{display:flex;align-items:center;gap:6px;padding:6px 12px;border-radius:20px;font-size:12px;font-weight:600;border:1.5px solid var(--border);background:var(--surface2);}
.user-chip.admin{border-color:rgba(180,167,214,.4);color:var(--purple3);}
.user-chip.store{border-color:rgba(242,162,162,.3);color:var(--rose2);}
.btn-logout{background:none;border:1.5px solid var(--border);border-radius:8px;color:var(--muted);font-size:12px;font-weight:600;padding:6px 12px;cursor:pointer;transition:all .2s;}
.btn-logout:hover{border-color:var(--rose2);color:var(--rose2);}

/* MODE TOGGLE */
.mode-toggle{display:grid;grid-template-columns:1fr 1fr;margin-bottom:12px;border-radius:14px;overflow:hidden;border:1.5px solid var(--border);background:var(--surface);}
.mode-btn{padding:15px;text-align:center;cursor:pointer;font-size:15px;font-weight:700;transition:all .3s;border:none;background:transparent;color:var(--muted);display:flex;align-items:center;justify-content:center;gap:8px;}
.mode-btn.ae{background:linear-gradient(135deg,rgba(168,213,181,.15),rgba(180,167,214,.08));color:var(--success);border-bottom:3px solid var(--success);}
.mode-btn.ax{background:linear-gradient(135deg,rgba(227,145,145,.18),rgba(187,122,122,.1));color:var(--rose2);border-bottom:3px solid var(--rose2);}

/* STEP BAR */
.step-bar{display:flex;align-items:center;margin-bottom:12px;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:12px 14px;gap:4px;}
.step-bar.hidden{display:none;}
.stp{display:flex;align-items:center;gap:8px;flex:1;min-width:0;}
.stp-num{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;border:2px solid var(--border);color:var(--muted);transition:all .3s;flex-shrink:0;}
.stp.active .stp-num{border-color:var(--purple3);color:var(--purple3);background:rgba(180,167,214,.12);}
.stp.done .stp-num{border-color:var(--success);color:#0a1a10;background:var(--success);}
.stp-lbl{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;}
.stp-val{font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:600;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.stp.done .stp-val{color:var(--success);}
.stp.active .stp-val{color:var(--purple3);}
.stp-div{width:12px;height:2px;background:var(--border);flex-shrink:0;border-radius:1px;}
.stp-div.done{background:var(--success);}

/* MAIN GRID */
.main-grid{display:grid;grid-template-columns:320px 1fr;gap:12px;align-items:start;}
@media(max-width:760px){.main-grid{grid-template-columns:1fr;}}

/* PANEL */
.panel{background:var(--surface);border:1px solid var(--border);border-radius:16px;overflow:hidden;margin-bottom:12px;}
.panel:last-child{margin-bottom:0;}
.ph{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:var(--surface2);}
.ph-title{font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.7px;color:var(--muted);display:flex;align-items:center;gap:8px;}
.led{width:8px;height:8px;border-radius:50%;background:var(--muted);}
.led.on{background:var(--success);box-shadow:0 0 8px var(--success);animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

/* SCANNER */
.sc-body{padding:14px;}
#scanner-container{position:relative;width:100%;aspect-ratio:4/3;border-radius:10px;overflow:hidden;background:#000;border:2px solid var(--border);transition:all .3s;}
#scanner-container.fe{border-color:var(--success);box-shadow:0 0 28px rgba(168,213,181,.4);}
#scanner-container.fx{border-color:var(--rose2);box-shadow:0 0 28px rgba(227,145,145,.4);}
#scanner-container video,#scanner-container canvas.drawingBuffer{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;}
#scanner-container canvas.drawingBuffer{opacity:0;}
.sc-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none;}
.sc-frame{width:90%;height:24%;border-radius:6px;box-shadow:0 0 0 9999px rgba(0,0,0,.52);position:relative;}
.sc-frame.fe{border:2px solid var(--success);}
.sc-frame.fx{border:2px solid var(--rose2);}
.sc-line{position:absolute;left:0;right:0;height:2px;animation:sl 1.4s ease-in-out infinite;}
.sc-line.fe{background:linear-gradient(90deg,transparent,var(--success),transparent);}
.sc-line.fx{background:linear-gradient(90deg,transparent,var(--rose2),transparent);}
@keyframes sl{0%{top:0;opacity:1}100%{top:100%;opacity:.1}}
.corner{position:absolute;width:12px;height:12px;}
.tl{top:-2px;left:-2px;}.tr{top:-2px;right:-2px;}.bl{bottom:-2px;left:-2px;}.br{bottom:-2px;right:-2px;}
.ce.tl{border-top:3px solid var(--success);border-left:3px solid var(--success);border-radius:3px 0 0 0;}
.ce.tr{border-top:3px solid var(--success);border-right:3px solid var(--success);border-radius:0 3px 0 0;}
.ce.bl{border-bottom:3px solid var(--success);border-left:3px solid var(--success);border-radius:0 0 0 3px;}
.ce.br{border-bottom:3px solid var(--success);border-right:3px solid var(--success);border-radius:0 0 3px 0;}
.cx.tl{border-top:3px solid var(--rose2);border-left:3px solid var(--rose2);border-radius:3px 0 0 0;}
.cx.tr{border-top:3px solid var(--rose2);border-right:3px solid var(--rose2);border-radius:0 3px 0 0;}
.cx.bl{border-bottom:3px solid var(--rose2);border-left:3px solid var(--rose2);border-radius:0 0 0 3px;}
.cx.br{border-bottom:3px solid var(--rose2);border-right:3px solid var(--rose2);border-radius:0 0 3px 0;}
.sc-hint{position:absolute;bottom:-22px;left:0;right:0;text-align:center;font-size:11px;}
.sc-hint.fe{color:var(--success);}
.sc-hint.fx{color:var(--rose2);}
.sc-badge{position:absolute;top:9px;left:9px;z-index:10;padding:5px 11px;border-radius:20px;font-size:11px;font-weight:700;font-family:'JetBrains Mono',monospace;backdrop-filter:blur(8px);}
.bi1{background:rgba(180,167,214,.25);color:var(--purple3);border:1px solid rgba(180,167,214,.4);}
.bi2{background:rgba(211,188,232,.2);color:var(--purple4);border:1px solid rgba(211,188,232,.35);}
.bi3{background:rgba(168,213,181,.2);color:var(--success);border:1px solid rgba(168,213,181,.35);}
.bix{background:rgba(227,145,145,.2);color:var(--rose2);border:1px solid rgba(227,145,145,.35);}
.ph-placeholder{text-align:center;padding:32px 12px;color:var(--muted);}
.ph-placeholder .big{font-size:36px;margin-bottom:10px;opacity:.3;}
.ph-placeholder p{font-size:13px;line-height:1.6;}
.conf-wrap{margin-top:10px;}
.conf-lbl{display:flex;justify-content:space-between;font-size:11px;color:var(--muted);margin-bottom:4px;}
.conf-bar{height:4px;background:var(--border);border-radius:2px;overflow:hidden;}
.conf-fill{height:100%;border-radius:2px;transition:width .1s,background .2s;}
.cur-read{margin-top:10px;padding:9px 12px;border-radius:9px;background:var(--surface2);border:1px solid var(--border);display:none;align-items:center;justify-content:space-between;gap:8px;}
.cr-l{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.4px;flex-shrink:0;}
.cr-v{font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:700;text-align:right;overflow:hidden;text-overflow:ellipsis;}
.cr-v.vld{color:var(--warning);animation:blink .5s infinite;}
.cr-v.oke{color:var(--success);}
.cr-v.okx{color:var(--rose2);}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}

/* EXIT RESULT CARD */
.exit-result{margin-top:12px;padding:14px;border-radius:12px;background:var(--surface2);border:1px solid var(--border);display:none;}
.exit-result.vis{display:block;animation:fu .3s ease;}
@keyframes fu{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}
.exit-result img{width:100%;height:90px;object-fit:cover;border-radius:8px;margin-bottom:9px;}
.er-name{font-size:15px;font-weight:700;margin-bottom:4px;}
.er-imei{font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--purple3);margin-bottom:5px;}
.er-detail{font-size:12px;color:var(--muted);}
.exit-result.nf{border-color:rgba(227,145,145,.35);background:rgba(227,145,145,.07);}
.exit-result.nf .er-name{color:var(--rose2);}
.exit-result.ao{border-color:rgba(232,200,130,.35);background:rgba(232,200,130,.07);}
.exit-result.ao .er-name{color:var(--warning);}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;gap:7px;padding:11px 16px;border-radius:10px;border:none;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:700;transition:all .2s;white-space:nowrap;}
.btn-entry{background:linear-gradient(135deg,#4a8c5c,var(--success));color:#0a1a10;}
.btn-entry:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(168,213,181,.3);}
.btn-exit-c{background:var(--grad-rose);color:#fff;}
.btn-exit-c:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(227,145,145,.3);}
.btn-primary{background:var(--grad-purple);color:#fff;}
.btn-primary:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(106,50,159,.3);}
.btn-outline{background:transparent;border:1.5px solid var(--border);color:var(--text);}
.btn-outline:hover{border-color:var(--purple3);color:var(--purple3);}
.btn-danger{background:rgba(227,145,145,.12);border:1.5px solid rgba(227,145,145,.3);color:var(--rose2);}
.btn-success{background:rgba(168,213,181,.12);border:1.5px solid rgba(168,213,181,.3);color:var(--success);}
.btn-warn{background:rgba(232,200,130,.12);border:1.5px solid rgba(232,200,130,.3);color:var(--warning);}
.btn:disabled{opacity:.35;cursor:not-allowed;transform:none!important;}
.sc-ctrls{display:flex;gap:8px;margin-top:12px;}
.sc-ctrls .btn{flex:1;justify-content:center;}

/* PLATFORM */
.plat-row{display:flex;margin-bottom:12px;border-radius:10px;overflow:hidden;border:1.5px solid var(--border);}
.plat-btn{flex:1;padding:11px;text-align:center;cursor:pointer;font-size:14px;font-weight:700;transition:all .2s;border:none;background:transparent;color:var(--muted);}
.plat-btn.ai{background:linear-gradient(135deg,rgba(180,167,214,.2),rgba(106,50,159,.12));color:var(--purple3);}
.plat-btn.aa{background:linear-gradient(135deg,rgba(168,213,181,.15),rgba(168,213,181,.06));color:var(--success);}

/* FORM */
.fsec{padding:14px 16px;border-top:1px solid var(--border);}
.fg{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px;}
.fg .full{grid-column:1/-1;}
.fl{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;font-weight:600;display:block;margin-bottom:5px;}
.fc-ok{border-color:rgba(168,213,181,.5)!important;background:rgba(168,213,181,.04)!important;}
input[type=text],input[type=number],select,textarea{
  background:var(--bg2);border:1.5px solid var(--border);border-radius:9px;
  color:var(--text);font-family:'JetBrains Mono',monospace;font-size:13px;
  padding:10px 12px;width:100%;outline:none;transition:all .2s;
}
textarea{resize:none;height:52px;font-family:'DM Sans',sans-serif;font-size:13px;}
input:focus,select:focus,textarea:focus{border-color:var(--purple2);box-shadow:0 0 0 3px rgba(106,50,159,.1);}
select option{background:var(--surface2);color:var(--text);}
select:disabled{opacity:.4;}
.color-row{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px;}
.csw{width:22px;height:22px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:all .2s;flex-shrink:0;}
.csw:hover{transform:scale(1.15);}
.csw.sel{border-color:var(--purple3);box-shadow:0 0 0 2px var(--bg),0 0 0 4px var(--purple3);}
.photo-prev{width:100%;height:100px;border-radius:10px;background:var(--bg2);border:2px dashed var(--border);display:flex;align-items:center;justify-content:center;overflow:hidden;position:relative;cursor:pointer;transition:border-color .2s;}
.photo-prev:hover{border-color:var(--purple3);}
.photo-prev img{width:100%;height:100%;object-fit:cover;}
.no-photo{text-align:center;color:var(--muted);font-size:12px;pointer-events:none;}
.no-photo .ic{font-size:26px;margin-bottom:4px;opacity:.4;}
.photo-rm{position:absolute;top:6px;right:6px;background:rgba(227,145,145,.9);border:none;border-radius:50%;width:22px;height:22px;color:#fff;cursor:pointer;font-size:12px;align-items:center;justify-content:center;z-index:5;display:none;}
.photo-prev:hover .photo-rm.hp{display:flex;}
.photo-ctrls{display:flex;gap:8px;margin-top:8px;}
input[type=file]{display:none;}
.feedback{margin-top:10px;padding:10px 12px;border-radius:9px;font-size:12px;display:none;align-items:center;gap:8px;font-weight:500;}
.feedback.success{background:rgba(168,213,181,.1);border:1px solid rgba(168,213,181,.3);color:var(--success);display:flex;}
.feedback.error{background:rgba(227,145,145,.1);border:1px solid rgba(227,145,145,.3);color:var(--rose2);display:flex;}
.feedback.pending{background:rgba(232,200,130,.1);border:1px solid rgba(232,200,130,.3);color:var(--warning);display:flex;}
/* ‚îÄ‚îÄ‚îÄ TOAST CENTRO PANTALLA ‚îÄ‚îÄ‚îÄ */
#toast-container{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:9999;display:flex;flex-direction:column;align-items:center;gap:10px;pointer-events:none;width:90%;max-width:420px;}
.toast{width:100%;padding:18px 24px;border-radius:18px;font-size:15px;font-weight:700;text-align:center;display:flex;align-items:center;justify-content:center;gap:10px;letter-spacing:.2px;pointer-events:auto;backdrop-filter:blur(16px);box-shadow:0 16px 50px rgba(0,0,0,.55);animation:toastIn .3s cubic-bezier(.34,1.56,.64,1) forwards;}
@keyframes toastIn{from{opacity:0;transform:scale(.82)}to{opacity:1;transform:scale(1)}}
.toast.t-success{background:linear-gradient(135deg,rgba(18,42,28,.97),rgba(28,62,42,.97));border:1.5px solid rgba(168,213,181,.55);color:#a8d5b5;}
.toast.t-error{background:linear-gradient(135deg,rgba(62,12,12,.97),rgba(82,22,22,.97));border:1.5px solid rgba(242,162,162,.55);color:#f2a2a2;}
.toast.t-pending{background:linear-gradient(135deg,rgba(52,38,8,.97),rgba(72,52,12,.97));border:1.5px solid rgba(232,200,130,.55);color:#e8c882;}
.toast.t-info{background:linear-gradient(135deg,rgba(22,12,62,.97),rgba(42,22,92,.97));border:1.5px solid rgba(180,167,214,.55);color:#d3bce8;}
.toast.t-notif{background:linear-gradient(135deg,rgba(18,8,56,.97),rgba(56,22,96,.97));border:2px solid rgba(180,167,214,.75);color:#d3bce8;font-size:14px;}
.sync-pill{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:20px;font-size:11px;font-weight:600;}
.sp-idle{background:rgba(74,82,112,.2);color:var(--muted);border:1px solid var(--border);}
.sp-send{background:rgba(232,200,130,.12);color:var(--warning);border:1px solid rgba(232,200,130,.3);}
.sp-ok{background:rgba(168,213,181,.1);color:var(--success);border:1px solid rgba(168,213,181,.3);}
.sp-err{background:rgba(227,145,145,.1);color:var(--rose2);border:1px solid rgba(227,145,145,.3);}
.spin{display:inline-block;animation:spin 1s linear infinite;}
@keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}

/* TABLE */
.table-tabs{display:flex;gap:0;overflow-x:auto;-ms-overflow-style:none;scrollbar-width:none;}
.table-tabs::-webkit-scrollbar{display:none;}
.tab-btn{padding:11px 14px;font-size:12px;font-weight:700;cursor:pointer;border:none;background:transparent;color:var(--muted);transition:all .2s;border-bottom:2.5px solid transparent;white-space:nowrap;letter-spacing:.3px;}
.tab-btn.active{color:var(--purple3);border-bottom-color:var(--purple3);background:rgba(180,167,214,.06);}
.tbl-wrap{overflow-x:auto;max-height:460px;overflow-y:auto;}
table{width:100%;border-collapse:collapse;}
thead{background:var(--surface2);position:sticky;top:0;z-index:2;}
th{padding:9px 10px;text-align:left;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.7px;color:var(--muted);white-space:nowrap;border-bottom:1px solid var(--border);}
td{padding:9px 10px;border-bottom:1px solid rgba(58,58,70,.4);font-size:12px;vertical-align:middle;}
tr:hover td{background:rgba(180,167,214,.03);}
tr.nr td{animation:rowIn .5s ease;}
@keyframes rowIn{from{background:rgba(180,167,214,.12)}to{background:transparent}}
.imei-c{font-family:'JetBrains Mono',monospace;color:var(--purple3);font-size:11px;}
.badge-in{background:rgba(168,213,181,.12);color:var(--success);border:1px solid rgba(168,213,181,.3);padding:3px 8px;border-radius:5px;font-size:10px;font-weight:700;white-space:nowrap;}
.badge-out{background:rgba(227,145,145,.12);color:var(--rose2);border:1px solid rgba(227,145,145,.3);padding:3px 8px;border-radius:5px;font-size:10px;font-weight:700;white-space:nowrap;}
.s1{color:var(--success);font-weight:700;font-size:12px;}
.s0{color:var(--rose2);font-weight:700;font-size:12px;}
.pt{width:32px;height:32px;border-radius:6px;object-fit:cover;border:1px solid var(--border);}
.store-tag{display:inline-block;padding:3px 8px;border-radius:5px;font-size:10px;font-weight:700;background:rgba(106,50,159,.15);color:var(--purple3);border:1px solid rgba(106,50,159,.25);}
.del-btn{background:rgba(227,145,145,.1);border:1px solid rgba(227,145,145,.25);border-radius:6px;color:var(--rose2);cursor:pointer;padding:4px 8px;font-size:11px;font-weight:600;transition:all .2s;}
.del-btn:hover{background:rgba(227,145,145,.25);}
.empty-state{padding:36px;text-align:center;color:var(--muted);}
.empty-state .big{font-size:32px;margin-bottom:8px;opacity:.25;}
.empty-state p{font-size:13px;}
.tbl-actions{display:flex;gap:7px;flex-shrink:0;}
.queue-bar{background:rgba(232,200,130,.07);border-top:1px solid rgba(232,200,130,.2);padding:9px 16px;display:flex;align-items:center;justify-content:space-between;font-size:12px;color:var(--warning);}
.queue-bar.hidden{display:none;}
.filter-row{padding:10px 14px;border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:center;flex-wrap:wrap;background:var(--surface2);}
.filter-row select{width:auto;flex:1;min-width:110px;padding:7px 10px;font-size:12px;}

/* REPORTS */
.rep-wrap{padding:16px;}
.rep-section-title{font-size:12px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.6px;margin-bottom:12px;display:flex;align-items:center;gap:8px;}
.rep-section-title::after{content:'';flex:1;height:1px;background:var(--border);}
.rep-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px;margin-bottom:20px;}
.stat-card{background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:16px;text-align:center;transition:border-color .2s;}
.stat-card:hover{border-color:var(--purple3);}
.sc-val{font-size:30px;font-weight:700;font-family:'JetBrains Mono',monospace;margin-bottom:5px;}
.sc-lbl{font-size:12px;color:var(--muted);}
.store-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px;}
.store-card{background:var(--surface2);border:1px solid var(--border);border-radius:14px;padding:16px;transition:border-color .2s;}
.store-card:hover{border-color:var(--purple2);}
.store-card-name{font-size:14px;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:7px;}
.store-stats{display:grid;grid-template-columns:1fr 1fr;gap:7px;}
.ss-item{text-align:center;padding:10px 6px;border-radius:9px;}
.ss-n{font-size:22px;font-weight:700;font-family:'JetBrains Mono',monospace;}
.ss-l{font-size:10px;color:var(--muted);margin-top:3px;text-transform:uppercase;letter-spacing:.4px;}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.78);z-index:100;display:none;align-items:center;justify-content:center;backdrop-filter:blur(4px);padding:16px;}
.modal-overlay.open{display:flex;}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:18px;padding:24px;max-width:380px;width:100%;}
.modal h3{font-size:16px;font-weight:700;margin-bottom:8px;}
.modal p{font-size:13px;color:var(--muted);margin-bottom:18px;line-height:1.6;}
.modal-btns{display:flex;gap:9px;justify-content:flex-end;}

/* MOBILE */
@media(max-width:500px){
  .app{padding:10px;}
  .topbar{padding:10px 12px;}
  .stats-row{gap:10px;}
  .stat-n{font-size:16px;}
  .mode-btn{font-size:14px;padding:13px 8px;}
  .btn{font-size:13px;padding:11px 14px;}
  .fsec{padding:12px 14px;}
  .fg{gap:7px;}
  th{padding:8px 8px;font-size:10px;}
  td{padding:8px 8px;font-size:12px;}
  .rep-grid{grid-template-columns:repeat(2,1fr);}
  .store-grid{grid-template-columns:1fr;}
  .sc-val{font-size:26px;}
  .ss-n{font-size:20px;}
}
</style>
</head>
<body>
<div id="toast-container"></div>

<!-- LOGIN -->
<div class="login-screen" id="login-screen">
  <div class="login-box">
    <div class="login-logo">
      <div class="login-icon">üì±</div>
      <div><h1>IMEI Scanner Pro</h1><span>Sistema multi-tienda</span></div>
    </div>
    <div class="lf"><label class="ll">Usuario</label><input type="text" class="li" id="login-user" placeholder="admin / tienda1..." autocomplete="username"></div>
    <div class="lf"><label class="ll">Contrase√±a</label><input type="password" class="li" id="login-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" onkeydown="if(event.key==='Enter')doLogin()"></div>
    <button class="login-btn" onclick="doLogin()">Ingresar ‚Üí</button>
    <div class="login-err" id="login-err"></div>
    <div class="url-sec">
      <span class="url-lbl">URL Apps Script (guardar una sola vez)</span>
      <div class="url-row">
        <input type="text" class="url-inp" id="url-inp" placeholder="https://script.google.com/macros/s/.../exec" oninput="onUrlInput()">
        <button class="url-btn" onclick="saveUrl()">Guardar</button>
      </div>
    </div>
  </div>
</div>

<!-- APP -->
<div class="app hidden" id="app">
  <div class="topbar">
    <div class="tb-left">
      <div class="tb-icon">üì±</div>
      <div><div class="tb-title">IMEI Scanner Pro</div><div class="tb-sub" id="tb-sub">‚Äî</div></div>
    </div>
    <div class="tb-right">
      <div class="stats-row">
        <div class="stat-i"><div class="stat-n gn" id="cnt-stock">0</div><div class="stat-l">Stock</div></div>
        <div class="stat-i"><div class="stat-n rd" id="cnt-out">0</div><div class="stat-l">Salidas</div></div>
        <div class="stat-i"><div class="stat-n pu" id="cnt-total">0</div><div class="stat-l">Total</div></div>
      </div>
      <div class="user-chip" id="user-chip">‚Äî</div>
      <button class="btn-logout" onclick="logout()">Salir</button>
    </div>
  </div>

  <div class="mode-toggle" id="mode-row">
    <button class="mode-btn" id="btn-entry" onclick="setMode('entry')">‚úÖ Entrada</button>
    <button class="mode-btn" id="btn-exit" onclick="setMode('exit')">üî¥ Salida</button>
  </div>

  <div class="step-bar" id="step-bar">
    <div class="stp active" id="stp-1"><div class="stp-num">1</div><div><div class="stp-lbl">IMEI 1</div><div class="stp-val" id="sv1">Esperando...</div></div></div>
    <div class="stp-div" id="sd1"></div>
    <div class="stp" id="stp-2"><div class="stp-num">2</div><div><div class="stp-lbl">IMEI 2</div><div class="stp-val" id="sv2">Esperando...</div></div></div>
    <div class="stp-div" id="sd2"></div>
    <div class="stp" id="stp-3"><div class="stp-num">3</div><div><div class="stp-lbl">Serial</div><div class="stp-val" id="sv3">Esperando...</div></div></div>
  </div>

  <div class="main-grid">
    <div>
      <!-- SCANNER PANEL -->
      <div class="panel">
        <div class="ph">
          <span class="ph-title"><span class="led" id="led"></span>Esc√°ner</span>
          <span class="sync-pill sp-idle" id="sync-pill">‚óè Inactivo</span>
        </div>
        <div class="sc-body">
          <div id="scanner-container">
            <div class="ph-placeholder" id="sc-ph"><div class="big" id="ph-icon">üì∑</div><p id="ph-txt">Activa la c√°mara para escanear</p></div>
          </div>
          <div class="conf-wrap" id="conf-wrap" style="display:none">
            <div class="conf-lbl"><span id="conf-lbl">Confianza</span><span id="conf-pct">0%</span></div>
            <div class="conf-bar"><div class="conf-fill" id="conf-fill" style="width:0%"></div></div>
          </div>
          <div class="cur-read" id="cur-read"><span class="cr-l" id="cr-l">Leyendo</span><span class="cr-v" id="cr-v">‚Äî</span></div>
          <div class="exit-result" id="exit-result">
            <img id="er-photo" style="display:none">
            <div class="er-name" id="er-name">‚Äî</div>
            <div class="er-imei" id="er-imei">‚Äî</div>
            <div class="er-detail" id="er-detail">‚Äî</div>
          </div>
          <div class="sc-ctrls">
            <button class="btn btn-primary" id="start-btn" onclick="startScanner()">‚ñ∂ Activar</button>
            <button class="btn btn-warn" id="skip-btn" onclick="skipStep()" disabled style="display:none">‚Ü∑ Saltar</button>
            <button class="btn btn-outline" id="stop-btn" onclick="stopScanner()" disabled style="flex:0;padding:10px 13px">‚ñ†</button>
          </div>
          <div class="feedback" id="feedback"></div>
        </div>
      </div>

      <!-- ENTRY FORM -->
      <div class="panel" id="entry-panel">
        <div class="ph"><span class="ph-title">üì± Datos del equipo</span></div>
        <div class="fsec">
          <div class="plat-row">
            <button class="plat-btn" id="btn-ios" onclick="setPlatform('iOS')">üçé iPhone</button>
            <button class="plat-btn" id="btn-android" onclick="setPlatform('Android')">ü§ñ Android</button>
          </div>
          <div class="fg">
            <div class="full"><label class="fl">IMEI 1 *</label><input type="text" id="f-imei1" placeholder="15 d√≠gitos" maxlength="16"></div>
            <div class="full"><label class="fl">IMEI 2</label><input type="text" id="f-imei2" placeholder="15 d√≠gitos"></div>
            <div class="full"><label class="fl">Serial</label><input type="text" id="f-serial" placeholder="N√∫mero de serie"></div>
            <div class="full"><label class="fl">Marca</label><select id="f-brand" onchange="onBrand()"><option value="">‚Äî Selecciona plataforma ‚Äî</option></select></div>
            <div class="full">
              <label class="fl">Modelo</label>
              <select id="f-model" disabled onchange="onModelSel()"><option value="">‚Äî Selecciona marca ‚Äî</option><option value="__m__">‚úèÔ∏è Escribir manualmente...</option></select>
              <input type="text" id="f-model-m" placeholder="Escribe el modelo..." style="margin-top:6px;display:none">
            </div>
            <div><label class="fl">GB</label><select id="f-storage"><option value="">‚Äî</option><option>64GB</option><option>128GB</option><option>256GB</option><option>512GB</option><option>1TB</option></select></div>
            <div><label class="fl">Precio</label><input type="number" id="f-price" placeholder="0.00" step="0.01"></div>
            <div class="full"><label class="fl">Estado</label><select id="f-status"><option>Nuevo</option><option>Seminuevo</option><option>Reacondicionado</option><option>Para reparar</option></select></div>
            <div class="full"><label class="fl">Color</label><select id="f-color"><option value="">‚Äî</option></select><div class="color-row" id="color-sw"></div></div>
            <div class="full"><label class="fl">Notas</label><textarea id="f-notes" placeholder="Observaciones..."></textarea></div>
          </div>
          <label class="fl">Foto del equipo</label>
          <div class="photo-prev" id="photo-prev" onclick="triggerPhoto()">
            <div class="no-photo" id="no-photo"><div class="ic">üì∏</div><div>Toca para agregar foto</div></div>
            <img id="photo-img" style="display:none">
            <button class="photo-rm" id="photo-rm" onclick="removePhoto(event)">‚úï</button>
          </div>
          <div class="photo-ctrls">
            <button class="btn btn-outline" onclick="triggerPhoto()" style="flex:1;justify-content:center">üì∑ C√°mara</button>
            <button class="btn btn-outline" onclick="triggerGallery()" style="flex:1;justify-content:center">üñº Galer√≠a</button>
          </div>
          <input type="file" id="photo-input" accept="image/*" onchange="onPhoto(event)">
          <input type="file" id="gallery-input" accept="image/*" onchange="onPhoto(event)">
          <div style="display:flex;gap:9px;margin-top:14px">
            <button class="btn btn-entry" onclick="saveEntry()" style="flex:1;justify-content:center;font-size:14px;padding:13px 16px">‚úÖ Registrar Entrada</button>
            <button class="btn btn-outline" onclick="resetAll()" style="padding:13px 16px">‚Ü∫</button>
          </div>
        </div>
      </div>

      <!-- EXIT FORM -->
      <div class="panel" id="exit-panel" style="display:none">
        <div class="ph"><span class="ph-title">üî¥ Registrar Salida</span></div>
        <div class="fsec">
          <div class="fg">
            <div class="full"><label class="fl">IMEI a dar de baja</label><input type="text" id="exit-imei" placeholder="Escanea o escribe IMEI..."></div>
            <div class="full"><label class="fl">üí∞ Precio de venta *</label><input type="number" id="exit-price" placeholder="0.00" step="0.01" style="border-color:var(--warning)"></div>
            <div class="full"><label class="fl">Notas de salida</label><textarea id="exit-notes" placeholder="Motivo, cliente, etc..."></textarea></div>
          </div>
          <button class="btn btn-exit-c" onclick="confirmExit()" style="width:100%;justify-content:center;font-size:14px;padding:13px 16px">üî¥ Confirmar Salida</button>
        </div>
      </div>
    </div>

    <!-- TABLE PANEL -->
    <div class="panel" style="margin-bottom:0">
      <div class="ph">
        <div class="table-tabs">
          <button class="tab-btn active" id="tab-inv" onclick="showTab('inv')">üì¶ Inventario</button>
          <button class="tab-btn" id="tab-mov" onclick="showTab('mov')">üìã Movimientos</button>
          <button class="tab-btn" id="tab-rep" onclick="showTab('rep')">üìä Reportes</button>
        </div>
        <div class="tbl-actions">
          <button class="btn btn-outline" onclick="loadFromSheets()" style="padding:7px 11px;font-size:12px" title="Sincronizar con Sheets">‚Üª Sync</button>
          <button class="btn btn-success" onclick="exportCSV()" style="padding:7px 11px;font-size:12px">‚¨á CSV</button>
          <button class="btn btn-danger" onclick="openClearModal()" style="padding:7px 11px;font-size:12px">üóë</button>
        </div>
      </div>
      <div class="queue-bar hidden" id="queue-bar">
        <span>‚è≥ <span id="q-count">0</span> pendientes de sync</span>
        <button class="btn btn-outline" style="padding:4px 10px;font-size:11px" onclick="retrySyncAll()">‚Üª Reintentar</button>
      </div>

      <!-- INV -->
      <div class="tbl-wrap" id="tw-inv">
        <table><thead><tr><th>#</th><th>Foto</th><th>Tienda</th><th>IMEI 1</th><th>Marca</th><th>Modelo</th><th>Color</th><th>GB</th><th>Precio</th><th>Stock</th><th>Sync</th><th id="th-del" style="display:none">Eliminar</th></tr></thead><tbody id="tb-inv"></tbody></table>
      </div>

      <!-- MOV -->
      <div id="tw-mov" style="display:none">
        <div class="filter-row">
          <select id="f-store" onchange="renderTables()" style="font-size:12px"><option value="">Todas las tiendas</option><option>Tienda 1</option><option>Tienda 2</option><option>Tienda 3</option><option>Tienda 4</option><option>Tienda 5</option><option>Tienda 6</option><option>Tienda 7</option></select>
          <select id="f-type" onchange="renderTables()" style="font-size:12px"><option value="">Entradas y Salidas</option><option value="ENTRADA">Solo Entradas ‚úÖ</option><option value="SALIDA">Solo Salidas üî¥</option></select>
        </div>
        <div class="tbl-wrap"><table><thead><tr><th>#</th><th>Tienda</th><th>Tipo</th><th>IMEI 1</th><th>Marca</th><th>Modelo</th><th>Costo</th><th style="color:var(--success)">Venta</th><th>Fecha</th><th>Hora</th><th>Notas</th><th id="th-del-mov" style="display:none">Eliminar</th></tr></thead><tbody id="tb-mov"></tbody></table></div>
      </div>

      <!-- REPORTS -->
      <div id="tw-rep" style="display:none"><div class="rep-wrap" id="rep-content"></div></div>
    </div>
  </div>
</div>

<!-- MODAL CLEAR -->
<div class="modal-overlay" id="modal-clear">
  <div class="modal">
    <h3>¬øLimpiar datos locales?</h3>
    <p>Los datos en Google Sheets se conservan. Solo limpia la vista local del navegador.</p>
    <div class="modal-btns">
      <button class="btn btn-outline" onclick="closeModal('modal-clear')">Cancelar</button>
      <button class="btn btn-danger" onclick="clearAll()">Limpiar</button>
    </div>
  </div>
</div>

<!-- MODAL INGRESO MASIVO EXCEL -->
<div class="modal-overlay" id="modal-bulk">
  <div class="modal" style="max-width:480px">
    <h3>üìä Ingreso Masivo desde Excel</h3>
    <p style="font-size:12px;margin-bottom:6px">Selecciona un archivo <strong>.xlsx</strong> o <strong>.csv</strong> con columnas:<br>
    <code style="font-size:10px;background:var(--bg2);padding:2px 6px;border-radius:4px">IMEI1, IMEI2, Serial, Marca, Modelo, Color, GB, Precio, Estado, Notas</code></p>
    <div id="bulk-drop" style="border:2px dashed var(--border);border-radius:12px;padding:28px;text-align:center;cursor:pointer;margin:12px 0;transition:border-color .2s" onclick="document.getElementById('bulk-file').click()" ondragover="event.preventDefault();this.style.borderColor='var(--purple2)'" ondragleave="this.style.borderColor='var(--border)'" ondrop="onBulkDrop(event)">
      <div style="font-size:28px;margin-bottom:8px">üìÇ</div>
      <div style="font-size:13px;color:var(--muted)">Arrastra tu Excel aqu√≠ o toca para seleccionar</div>
      <div id="bulk-file-name" style="font-size:11px;color:var(--purple3);margin-top:6px"></div>
    </div>
    <input type="file" id="bulk-file" accept=".xlsx,.csv,.xls" onchange="onBulkFile(event)" style="display:none">
    <div id="bulk-preview" style="display:none;max-height:160px;overflow-y:auto;margin:8px 0;border-radius:8px;border:1px solid var(--border)">
      <table style="width:100%;font-size:11px"><thead id="bulk-thead"></thead><tbody id="bulk-tbody"></tbody></table>
    </div>
    <div id="bulk-status" style="font-size:12px;color:var(--muted);min-height:20px;margin-bottom:8px"></div>
    <div class="modal-btns">
      <button class="btn btn-outline" onclick="closeModal('modal-bulk')">Cancelar</button>
      <button class="btn btn-primary" id="bulk-import-btn" onclick="doBulkImport()" disabled>‚úÖ Importar registros</button>
    </div>
  </div>
</div>

<!-- MODAL CONFIRM DELETE IMEI -->
<div class="modal-overlay" id="modal-del">
  <div class="modal">
    <h3>¬øEliminar este IMEI?</h3>
    <p id="modal-del-txt">Se eliminar√° del inventario. Los movimientos hist√≥ricos se conservan.</p>
    <div class="modal-btns">
      <button class="btn btn-outline" onclick="closeModal('modal-del')">Cancelar</button>
      <button class="btn btn-danger" onclick="confirmDelete()">Eliminar</button>
    </div>
  </div>
</div>

<!-- MODAL CONFIRM DELETE MOVIMIENTO -->
<div class="modal-overlay" id="modal-del-mov">
  <div class="modal">
    <h3>¬øEliminar este movimiento?</h3>
    <p id="modal-del-mov-txt">Este movimiento se eliminar√° del historial local y de Google Sheets.</p>
    <div class="modal-btns">
      <button class="btn btn-outline" onclick="closeModal('modal-del-mov')">Cancelar</button>
      <button class="btn btn-danger" onclick="confirmDeleteMov()">Eliminar</button>
    </div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ CATALOG ‚îÄ‚îÄ‚îÄ
const CAT={
  iOS:{'Apple':{m:['iPhone 16e','iPhone 16','iPhone 16 Plus','iPhone 16 Pro','iPhone 16 Pro Max','iPhone 15','iPhone 15 Plus','iPhone 15 Pro','iPhone 15 Pro Max','iPhone 14','iPhone 14 Plus','iPhone 14 Pro','iPhone 14 Pro Max','iPhone 13','iPhone 13 Mini','iPhone 13 Pro','iPhone 13 Pro Max','iPhone 12','iPhone 12 Mini','iPhone 12 Pro','iPhone 12 Pro Max','iPhone 11','iPhone 11 Pro','iPhone 11 Pro Max','iPhone SE (3rd)','iPhone SE (2nd)','iPhone XS Max','iPhone XS','iPhone XR','iPhone X'],c:[{n:'Negro',h:'#1a1a1a'},{n:'Blanco',h:'#f5f5f0'},{n:'Azul',h:'#4a90d9'},{n:'Azul Titanio',h:'#6b7d8f'},{n:'Verde',h:'#4caf7d'},{n:'Amarillo',h:'#f5c842'},{n:'Rosa',h:'#f4a0b5'},{n:'Morado',h:'#9b7ec8'},{n:'Rojo PRODUCT',h:'#c0392b'},{n:'Starlight',h:'#e8e3d8'},{n:'Midnight',h:'#2c2c2e'},{n:'Titanio Natural',h:'#b8a898'},{n:'Titanio Blanco',h:'#e8e0d8'},{n:'Titanio Negro',h:'#3a3a3c'},{n:'Titanio Desierto',h:'#c8a882'}]}},
  Android:{
    'Samsung':{m:['Galaxy S25 Ultra','Galaxy S25+','Galaxy S25','Galaxy S24 Ultra','Galaxy S24+','Galaxy S24','Galaxy S24 FE','Galaxy S23 Ultra','Galaxy S23+','Galaxy S23','Galaxy A56','Galaxy A55','Galaxy A35','Galaxy A25','Galaxy A15','Galaxy A06','Galaxy Z Fold 6','Galaxy Z Fold 5','Galaxy Z Flip 6','Galaxy Z Flip 5','Galaxy Note 20 Ultra','Galaxy Note 20'],c:[{n:'Negro Fantasma',h:'#1a1a2e'},{n:'Gris Fantasma',h:'#5a5a6e'},{n:'Blanco Crema',h:'#f0ede4'},{n:'Violeta',h:'#7b5ea7'},{n:'Verde Jade',h:'#4a7c59'},{n:'Azul Marino',h:'#1e3a5f'},{n:'Amarillo',h:'#f5c842'},{n:'Rosa',h:'#e8a0b0'},{n:'Grafito',h:'#3d3d3d'},{n:'Plateado',h:'#c0c0c0'},{n:'Dorado',h:'#d4af37'}]},
    'Xiaomi':{m:['Xiaomi 15 Ultra','Xiaomi 15 Pro','Xiaomi 15','Xiaomi 14 Ultra','Xiaomi 14 Pro','Xiaomi 14','Redmi Note 14 Pro+','Redmi Note 14 Pro','Redmi Note 14','Redmi Note 13 Pro+','Redmi Note 13 Pro','Redmi Note 13','Redmi 14C','Redmi 13C','Redmi 12','POCO X7 Pro','POCO X6 Pro','POCO X6','POCO F6 Pro','POCO F6'],c:[{n:'Negro',h:'#1a1a1a'},{n:'Blanco',h:'#f5f5f5'},{n:'Azul',h:'#3a7bd5'},{n:'Verde',h:'#4caf7d'},{n:'Dorado',h:'#d4af37'},{n:'Plata',h:'#c0c0c0'},{n:'Rosa',h:'#f4a0b5'},{n:'Morado',h:'#9b7ec8'},{n:'Naranja',h:'#e87040'}]},
    'Motorola':{m:['Edge 50 Ultra','Edge 50 Pro','Edge 50','Edge 50 Fusion','Edge 40 Pro','Edge 40 Neo','Moto G85','Moto G75','Moto G55','Moto G45','Moto G35','Moto G15','Razr 50 Ultra','Razr 50','Razr 40 Ultra'],c:[{n:'Negro Medianoche',h:'#1a1a2e'},{n:'Blanco',h:'#f5f5f5'},{n:'Verde',h:'#4caf7d'},{n:'Gris',h:'#808080'},{n:'Azul Zafiro',h:'#1e3a5f'},{n:'Beige',h:'#d4b896'},{n:'Lila',h:'#c8a2c8'},{n:'Coral',h:'#e87060'}]},
    'Huawei':{m:['Pura 70 Ultra','Pura 70 Pro','Pura 70','Mate 60 Pro+','Mate 60 Pro','Mate 60','Nova 12 Pro','Nova 12','P60 Pro','P60','Y9s','Y7a','Y6p'],c:[{n:'Negro',h:'#1a1a1a'},{n:'Blanco',h:'#f5f5f5'},{n:'Dorado',h:'#d4af37'},{n:'Verde',h:'#4caf7d'},{n:'Azul',h:'#3a7bd5'},{n:'Rosa Perlado',h:'#f4c2c2'},{n:'Plata',h:'#c0c0c0'},{n:'Rojo',h:'#c0392b'}]},
    'Realme':{m:['Realme GT 7 Pro','Realme GT 6','Realme 13 Pro+','Realme 13 Pro','Realme 13','Realme C75','Realme C65','Realme C55'],c:[{n:'Negro',h:'#1a1a1a'},{n:'Blanco',h:'#f5f5f5'},{n:'Naranja',h:'#e87040'},{n:'Verde',h:'#4caf7d'},{n:'Azul',h:'#3a7bd5'},{n:'Dorado',h:'#d4af37'}]},
    'OnePlus':{m:['OnePlus 13','OnePlus 12','OnePlus Nord 4','OnePlus Nord CE4','OnePlus Nord CE 3 Lite'],c:[{n:'Negro',h:'#1a1a1a'},{n:'Verde Marino',h:'#2d6a4f'},{n:'Gris',h:'#808080'},{n:'Naranja',h:'#e87040'},{n:'Azul',h:'#3a7bd5'}]}
  }
};

// ‚îÄ‚îÄ‚îÄ STORAGE HELPER (fallback en memoria si LS no disponible) ‚îÄ‚îÄ‚îÄ
const _mem={};
const LS={
  getItem:k=>{try{return localStorage.getItem(k);}catch(e){return _mem[k]??null;}},
  setItem:(k,v)=>{try{localStorage.setItem(k,v);}catch(e){_mem[k]=v;}},
  removeItem:k=>{try{localStorage.removeItem(k);}catch(e){delete _mem[k];}}
};
// ‚îÄ‚îÄ‚îÄ USERS ‚îÄ‚îÄ‚îÄ
const USERS={
  'admin':  {password:'Admin2024!',role:'admin', store:null,      name:'Administrador'},
  'tienda1':{password:'Tienda1#',  role:'store', store:'Tienda 1',name:'Tienda 1'},
  'tienda2':{password:'Tienda2#',  role:'store', store:'Tienda 2',name:'Tienda 2'},
  'tienda3':{password:'Tienda3#',  role:'store', store:'Tienda 3',name:'Tienda 3'},
  'tienda4':{password:'Tienda4#',  role:'store', store:'Tienda 4',name:'Tienda 4'},
  'tienda5':{password:'Tienda5#',  role:'store', store:'Tienda 5',name:'Tienda 5'},
  'tienda6':{password:'Tienda6#',  role:'store', store:'Tienda 6',name:'Tienda 6'},
  'tienda7':{password:'Tienda7#',  role:'store', store:'Tienda 7',name:'Tienda 7'},
  'lider1': {password:'Lider1#2024', role:'leader', store:null, name:'L√≠der Zona 1'},
  'lider2': {password:'Lider2#2024', role:'leader', store:null, name:'L√≠der Zona 2'},
};

// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ
let inv=(()=>{try{return JSON.parse(LS.getItem('inv_v6')||'[]');}catch(e){return [];}})();
let mov=(()=>{try{return JSON.parse(LS.getItem('mov_v6')||'[]');}catch(e){return [];}})();
let scriptUrl=(()=>{try{return LS.getItem('imei_url_v6')||'';}catch(e){return '';}})();
let currentUser=(()=>{try{return JSON.parse(LS.getItem('imei_user')||'null');}catch(e){return null;}})();
let mode='entry',scannerRunning=false,currentStep=1,scanLocked=false,detBuf=[];
let sv={imei1:'',imei2:'',serial:''};
let selPlat='',selColor='',photoData=null,curTab='inv';

const isIMEI=c=>/^\d{14,15}$/.test(c.trim());
const isSerial=c=>/^[A-Z0-9]{8,20}$/i.test(c.trim())&&!/^\d{14,15}$/.test(c.trim());
const STEPS={1:{l:'IMEI 1',b:'bi1',v:isIMEI,f:'imei1'},2:{l:'IMEI 2',b:'bi2',v:isIMEI,f:'imei2'},3:{l:'Serial',b:'bi3',v:isSerial,f:'serial'}};
const EXIT_S={l:'IMEI',b:'bix',v:isIMEI};
const REQ=7,MIN_C=0.88;   // 7 lecturas id√©nticas, 88% confianza m√≠nima por lectura

// Algoritmo de Luhn ‚Äî valida que un IMEI de 15 d√≠gitos sea matem√°ticamente correcto
function luhnCheck(num){
  let s=0,alt=false;
  for(let i=num.length-1;i>=0;i--){
    let n=parseInt(num[i],10);
    if(alt){n*=2;if(n>9)n-=9;}
    s+=n;alt=!alt;
  }
  return s%10===0;
}

// ‚îÄ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ‚îÄ
function onUrlInput(){
  const v=document.getElementById('url-inp').value.trim();
  if(v.includes('script.google.com')&&v.includes('/exec')){
    scriptUrl=v;try{LS.setItem('imei_url_v6',v);}catch(e){}
    document.getElementById('url-inp').classList.add('ok');
  }
}
function saveUrl(){
  onUrlInput();
  const el=document.getElementById('url-inp');
  el.style.borderColor='var(--success)';
  setTimeout(()=>el.style.borderColor='',2000);
}
function doLogin(){
  const user=document.getElementById('login-user').value.trim().toLowerCase();
  const pass=document.getElementById('login-pass').value;
  const err=document.getElementById('login-err');
  err.classList.remove('vis');
  if(!user||!pass){err.textContent='Ingresa usuario y contrase√±a';err.classList.add('vis');return;}
  // URL es opcional al login; se puede usar en modo offline sin sync
  const u=USERS[user];
  if(!u||u.password!==pass){err.textContent='Usuario o contrase√±a incorrectos';err.classList.add('vis');return;}
  currentUser={username:user,role:u.role,store:u.store,name:u.name};
  try{LS.setItem('imei_user',JSON.stringify(currentUser));}catch(e){}
  showApp();loadFromSheets().then(()=>{startNotifPolling();});
}
function showApp(){
  document.getElementById('login-screen').classList.add('hidden');
  document.getElementById('app').classList.remove('hidden');
  document.body.setAttribute('data-role', currentUser.role); // activa CSS de rol
  const uc=document.getElementById('user-chip');
  const roleIco=currentUser.role==='admin'?'üëë ':currentUser.role==='leader'?'üëÅ ':'üè™ ';
  uc.textContent=roleIco+currentUser.name;
  uc.className='user-chip '+(currentUser.role==='admin'?'admin':currentUser.role==='leader'?'leader':'store');
  document.getElementById('tb-sub').textContent=currentUser.role==='admin'?'Vista global ‚Äî todas las tiendas':currentUser.role==='leader'?'Vista de l√≠der ‚Äî todas las tiendas (solo lectura)':currentUser.store;
  // L√≠der: ocultar modo entry/exit, solo ver tablas y reportes
  const isLeader=currentUser.role==='leader';
  const isAdmin=currentUser.role==='admin';
  const modeRow=document.getElementById('mode-row');
  if(modeRow) modeRow.style.display=(isLeader)?'none':'';
  document.getElementById('entry-panel').style.display='none';
  document.getElementById('exit-panel').style.display='none';
  if(isLeader){
    document.getElementById('step-bar').classList.add('hidden');
  }
  // tab-rep: visible para admin y leader via CSS (body[data-role])
  // Show delete columns for admin
  const thDel=document.getElementById('th-del');
  if(thDel) thDel.style.display=currentUser.role==='admin'?'':'none';
  const thDelMov=document.getElementById('th-del-mov');
  if(thDelMov) thDelMov.style.display=currentUser.role==='admin'?'':'none';
  if(!isLeader) setMode('entry');
  // Mostrar bot√≥n importaci√≥n masiva solo para admin y tienda
  const btnBulk=document.getElementById('btn-bulk');
  if(btnBulk) btnBulk.style.display=(isAdmin||currentUser.role==='store')?'':'none';
}
function logout(){
  currentUser=null;try{LS.removeItem('imei_user');}catch(e){}stopNotifPolling();
  document.getElementById('login-screen').classList.remove('hidden');
  document.getElementById('app').classList.add('hidden');
  stopScanner();
}

// ‚îÄ‚îÄ‚îÄ LOAD FROM SHEETS ‚îÄ‚îÄ‚îÄ
async function loadFromSheets(){
  if(!scriptUrl||!currentUser)return;
  setSP('send','‚ü≥ Cargando...');
  try{
    const url=scriptUrl+'?action=get_data&role='+encodeURIComponent(currentUser.role==='leader'?'admin':currentUser.role)+'&store='+encodeURIComponent((currentUser.store&&currentUser.store!=='null')?currentUser.store:'');
    const res=await fetch(url);
    const data=await res.json();
    if(data.success){
      inv=data.inventory.map(r=>({...r,syncStatus:'synced',fresh:false}));
      mov=data.movements.map((r,i)=>({...r,id:i}));
      saveData();renderTables();updateStats();
      setSP('ok','‚úì Sincronizado');
    } else setSP('err','‚úó '+data.error);
  }catch(e){setSP('err','‚úó Error de red');console.error(e);}
}

// ‚îÄ‚îÄ‚îÄ MODE ‚îÄ‚îÄ‚îÄ
function setMode(m){
  mode=m;stopScanner();
  document.getElementById('btn-entry').className='mode-btn'+(m==='entry'?' ae':'');
  document.getElementById('btn-exit').className='mode-btn'+(m==='exit'?' ax':'');
  document.getElementById('step-bar').classList.toggle('hidden',m==='exit');
  document.getElementById('entry-panel').style.display=m==='entry'?'block':'none';
  document.getElementById('exit-panel').style.display=m==='exit'?'block':'none';
  document.getElementById('skip-btn').style.display=m==='entry'?'inline-flex':'none';
  document.getElementById('exit-result').className='exit-result';
  document.getElementById('ph-icon').textContent=m==='entry'?'üì∑':'üîç';
  document.getElementById('ph-txt').textContent=m==='entry'?'Activa la c√°mara para escanear':'Activa para escanear IMEI de salida';
  if(m==='entry'){currentStep=1;sv={imei1:'',imei2:'',serial:''};updateStepUI();}
}

// ‚îÄ‚îÄ‚îÄ CATALOG ‚îÄ‚îÄ‚îÄ
function setPlatform(p){
  selPlat=p;
  document.getElementById('btn-ios').className='plat-btn'+(p==='iOS'?' ai':'');
  document.getElementById('btn-android').className='plat-btn'+(p==='Android'?' aa':'');
  const bs=document.getElementById('f-brand');
  bs.innerHTML='<option value="">‚Äî Selecciona marca ‚Äî</option>';
  Object.keys(CAT[p]||{}).forEach(b=>bs.innerHTML+=`<option value="${b}">${b}</option>`);
  document.getElementById('f-model').innerHTML='<option value="">‚Äî Selecciona marca ‚Äî</option><option value="__m__">‚úèÔ∏è Escribir manualmente...</option>';
  document.getElementById('f-model').disabled=true;
  document.getElementById('f-model-m').style.display='none';
  document.getElementById('f-color').innerHTML='<option value="">‚Äî</option>';
  document.getElementById('color-sw').innerHTML='';selColor='';
}
function onModelSel(){
  const v=document.getElementById('f-model').value;
  document.getElementById('f-model-m').style.display=v==='__m__'?'block':'none';
  if(v!=='__m__')document.getElementById('f-model-m').value='';
}
function getModel(){
  const s=document.getElementById('f-model').value;
  return s==='__m__'?document.getElementById('f-model-m').value.trim():s;
}
function onBrand(){
  const br=document.getElementById('f-brand').value;
  if(!br||!selPlat)return;
  const d=CAT[selPlat][br];if(!d)return;
  const ms=document.getElementById('f-model');
  ms.innerHTML='<option value="">‚Äî Selecciona modelo ‚Äî</option>';
  d.m.forEach(m=>ms.innerHTML+=`<option value="${m}">${m}</option>`);
  ms.innerHTML+='<option value="__m__">‚úèÔ∏è Escribir manualmente...</option>';
  ms.disabled=false;
  document.getElementById('f-model-m').style.display='none';
  const cs=document.getElementById('f-color');
  cs.innerHTML='<option value="">‚Äî Selecciona color ‚Äî</option>';
  d.c.forEach(c=>cs.innerHTML+=`<option value="${c.n}">${c.n}</option>`);
  const sw=document.getElementById('color-sw');sw.innerHTML='';
  d.c.forEach(c=>{const el=document.createElement('div');el.className='csw';el.style.background=c.h;el.title=c.n;el.onclick=()=>{selColor=c.n;document.getElementById('f-color').value=c.n;document.querySelectorAll('.csw').forEach(s=>s.classList.remove('sel'));el.classList.add('sel');};sw.appendChild(el);});
  selColor='';
}
document.getElementById('f-color').addEventListener('change',function(){selColor=this.value;document.querySelectorAll('.csw').forEach(s=>s.classList.toggle('sel',s.title===this.value));});

// ‚îÄ‚îÄ‚îÄ PHOTO ‚îÄ‚îÄ‚îÄ
function triggerPhoto(){const i=document.getElementById('photo-input');i.setAttribute('capture','environment');i.click();}
function triggerGallery(){document.getElementById('gallery-input').click();}
function onPhoto(e){
  const file=e.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=ev=>{
    const img=new Image();
    img.onload=()=>{
      const c=document.createElement('canvas');
      // Max 600px para mantener base64 bajo 200KB
      const MAX=600;
      let w=img.width,h=img.height;
      if(w>h){if(w>MAX){h=Math.round(h*MAX/w);w=MAX;}}
      else{if(h>MAX){w=Math.round(w*MAX/h);h=MAX;}}
      c.width=w;c.height=h;
      c.getContext('2d').drawImage(img,0,0,w,h);
      // Calidad 0.65 para reducir tama√±o
      photoData=c.toDataURL('image/jpeg',0.65);
      // Log del tama√±o para debugging
      const sizeKB=Math.round(photoData.length*0.75/1024);
      console.log('Foto comprimida: '+w+'x'+h+'px, ~'+sizeKB+'KB base64');
      document.getElementById('photo-img').src=photoData;
      document.getElementById('photo-img').style.display='block';
      document.getElementById('no-photo').style.display='none';
      document.getElementById('photo-rm').classList.add('hp');
    };img.src=ev.target.result;
  };reader.readAsDataURL(file);
}
function removePhoto(e){
  e.stopPropagation();photoData=null;
  document.getElementById('photo-img').style.display='none';
  document.getElementById('photo-img').src='';
  document.getElementById('no-photo').style.display='flex';
  document.getElementById('photo-rm').classList.remove('hp');
  document.getElementById('photo-input').value='';
  document.getElementById('gallery-input').value='';
}

// ‚îÄ‚îÄ‚îÄ STEPS ‚îÄ‚îÄ‚îÄ
function updateStepUI(){
  for(let i=1;i<=3;i++){
    const el=document.getElementById('stp-'+i);
    el.classList.remove('active','done');
    if(i<currentStep){el.classList.add('done');if(i<3)document.getElementById('sd'+i).classList.add('done');}
    else if(i===currentStep)el.classList.add('active');
  }
  document.getElementById('sv1').textContent=sv.imei1||'Esperando...';
  document.getElementById('sv2').textContent=sv.imei2||'Esperando...';
  document.getElementById('sv3').textContent=sv.serial||'Esperando...';
}
function skipStep(){
  if(currentStep>=3)return;
  sv[STEPS[currentStep].f]='';currentStep++;
  scanLocked=false;detBuf=[];updateStepUI();
  showFb('‚Ü∑ Saltado ‚Üí '+STEPS[currentStep].l,'pending');
}

// ‚îÄ‚îÄ‚îÄ SCANNER ‚îÄ‚îÄ‚îÄ
function startScanner(){
  if(scannerRunning)return;
  const con=document.getElementById('scanner-container');
  document.getElementById('sc-ph').style.display='none';
  const cfg=mode==='exit'?EXIT_S:STEPS[currentStep];
  const cc=mode==='exit'?'x':'e';
  con.insertAdjacentHTML('beforeend',`
    <div class="sc-badge ${cfg.b}" id="sc-badge">‚óè ${cfg.l}</div>
    <div class="sc-overlay" id="sc-overlay">
      <div class="sc-frame f${cc}">
        <div class="sc-line f${cc}"></div>
        <div class="corner tl c${cc}"></div><div class="corner tr c${cc}"></div>
        <div class="corner bl c${cc}"></div><div class="corner br c${cc}"></div>
        <div class="sc-hint f${cc}">Centra el c√≥digo en el marco</div>
      </div>
    </div>`);
  Quagga.init({
    inputStream:{
      name:"Live",type:"LiveStream",target:con,
      constraints:{facingMode:"environment",width:{min:1280,ideal:1920,max:1920},height:{min:720,ideal:1080,max:1080}},
      area:{top:"30%",right:"5%",left:"5%",bottom:"30%"} // solo procesa la franja del marco
    },
    locator:{patchSize:"medium",halfSample:true},
    numOfWorkers:navigator.hardwareConcurrency>2?2:1,
    frequency:25,
    decoder:{
      readers:[
        {format:"code_128_reader",config:{}}  // Code128 primero y solo ‚Äî IMEIs siempre son Code128
      ],
      multiple:false
    },
    locate:true
  },err=>{
    if(err){showFb('‚úó Error c√°mara: '+(err.message||err),'error');document.getElementById('sc-ph').style.display='flex';con.querySelector('#sc-overlay')?.remove();con.querySelector('#sc-badge')?.remove();return;}
    Quagga.start();scannerRunning=true;scanLocked=false;detBuf=[];
    document.getElementById('start-btn').disabled=true;
    document.getElementById('stop-btn').disabled=false;
    if(mode==='entry')document.getElementById('skip-btn').disabled=false;
    document.getElementById('led').classList.add('on');
    document.getElementById('conf-wrap').style.display='block';
    document.getElementById('cur-read').style.display='flex';
    setSP('ok','‚úì Activo');
  });
  Quagga.onProcessed(r=>{
    if(!r?.codeResult?.code)return;
    const codes=r.codeResult.decodedCodes.filter(x=>x.error!==undefined);
    if(!codes.length)return;
    const conf=1-codes.reduce((a,x)=>a+x.error,0)/codes.length;
    updateConf(conf);
    const code=r.codeResult.code;
    document.getElementById('cr-l').textContent=mode==='exit'?'IMEI':(STEPS[currentStep]?.l||'Leyendo');
    document.getElementById('cr-v').className='cr-v vld';
    document.getElementById('cr-v').textContent=code.length>20?code.substring(0,20)+'‚Ä¶':code;
  });
  Quagga.onDetected(r=>{
    if(scanLocked)return;
    const code=r.codeResult.code.trim();

    // Calidad de la lectura actual
    const codes=r.codeResult.decodedCodes.filter(x=>x.error!==undefined);
    if(!codes.length)return;
    const conf=1-codes.reduce((a,x)=>a+x.error,0)/codes.length;
    if(conf<MIN_C)return;

    // Validar formato seg√∫n paso actual
    const cfg=mode==='exit'?EXIT_S:STEPS[currentStep];
    if(!cfg.v(code))return;

    // Validaci√≥n Luhn para IMEIs (paso 1 y 2, y salida)
    if((mode==='exit'||currentStep<=2)&&/^\d{15}$/.test(code)){
      if(!luhnCheck(code))return; // descarta lecturas que no pasan el checksum
    }

    // Buffer de coincidencias: acumular y exigir mayor√≠a calificada
    detBuf.push(code);
    if(detBuf.length>REQ*4)detBuf.shift();
    const counts={};detBuf.forEach(c=>counts[c]=(counts[c]||0)+1);
    const[bc,bn]=Object.entries(counts).sort((a,b)=>b[1]-a[1])[0];

    // Actualizar barra de progreso hacia confirmaci√≥n
    updateConf(Math.min(bn/REQ,0.99));

    if(bn>=REQ){
      scanLocked=true;detBuf=[];
      updateConf(1);
      onConfirmed(bc);
    }
  });
}
function onConfirmed(code){mode==='exit'?onExitScan(code):onEntryStep(code);}
function flash(t){const c=document.getElementById('scanner-container');c.classList.add(t==='e'?'fe':'fx');setTimeout(()=>c.classList.remove('fe','fx'),800);}
function onEntryStep(code){
  const cfg=STEPS[currentStep];flash('e');
  sv[cfg.f]=code;
  const fm={imei1:'f-imei1',imei2:'f-imei2',serial:'f-serial'};
  const inp=document.getElementById(fm[cfg.f]);
  if(inp){inp.value=code;inp.classList.add('fc-ok');}
  document.getElementById('cr-v').className='cr-v oke';
  document.getElementById('cr-v').textContent=code;
  showFb('‚úì '+cfg.l+': '+code,'success');
  updateStepUI();
  if(currentStep<3){
    currentStep++;updateStepUI();
    setTimeout(()=>{
      scanLocked=false;detBuf=[];
      showFb('‚ñ∂ Ahora: '+STEPS[currentStep].l,'pending');
      const badge=document.getElementById('sc-badge');
      if(badge){badge.className='sc-badge '+STEPS[currentStep].b;badge.textContent='‚óè '+STEPS[currentStep].l;}
    },1200);
  } else {
    stopScanner();showFb('‚úÖ Datos capturados. Completa el formulario.','success');
    document.getElementById('skip-btn').disabled=true;
  }
}
async function onExitScan(code){
  flash('x');
  document.getElementById('exit-imei').value=code;
  document.getElementById('cr-v').className='cr-v okx';
  document.getElementById('cr-v').textContent=code;
  stopScanner();showFb('üîç Buscando IMEI...','pending');
  let found=inv.find(r=>String(r.imei1).trim()===code);
  if(!found){
    showFb('‚ü≥ No encontrado local, sincronizando...','pending');
    await loadFromSheets();
    found=inv.find(r=>String(r.imei1).trim()===code);
  }
  const er=document.getElementById('exit-result');
  er.className='exit-result vis';
  if(!found){
    er.classList.add('nf');
    document.getElementById('er-name').textContent='‚ùå IMEI no encontrado';
    document.getElementById('er-imei').textContent=code;
    document.getElementById('er-detail').textContent='No registrado en inventario. Verifica el IMEI o reg√≠stralo como entrada primero.';
    document.getElementById('er-photo').style.display='none';
    showFb('‚úó IMEI no encontrado','error');return;
  }
  if(String(found.stock)==='0'||found.stock===0){
    er.classList.add('ao');
    document.getElementById('er-name').textContent='‚ö† Ya fue dado de baja';
    document.getElementById('er-imei').textContent=code;
    document.getElementById('er-detail').textContent=found.brand+' '+found.model+' ‚Äî ya tiene salida registrada.';
    document.getElementById('er-photo').style.display='none';
    showFb('‚ö† Este IMEI ya tiene salida registrada','error');return;
  }
  document.getElementById('er-name').textContent=found.brand+' '+found.model;
  document.getElementById('er-imei').textContent=code;
  document.getElementById('er-detail').textContent=(found.color||'‚Äî')+' ¬∑ '+(found.storage||'‚Äî')+' ¬∑ Entrada: '+found.date+(found.store?' ¬∑ '+found.store:'');
  if(found.photoUrl){document.getElementById('er-photo').src=found.photoUrl;document.getElementById('er-photo').style.display='block';}
  else document.getElementById('er-photo').style.display='none';
  showFb('‚úì Equipo encontrado ‚Äî confirma la salida abajo','success');
}
function stopScanner(){
  if(!scannerRunning)return;
  Quagga.stop();scannerRunning=false;scanLocked=false;detBuf=[];
  document.getElementById('start-btn').disabled=false;
  document.getElementById('stop-btn').disabled=true;
  document.getElementById('skip-btn').disabled=true;
  document.getElementById('led').classList.remove('on');
  document.getElementById('conf-wrap').style.display='none';
  document.getElementById('cur-read').style.display='none';
  const c=document.getElementById('scanner-container');
  c.querySelector('#sc-overlay')?.remove();c.querySelector('#sc-badge')?.remove();
  c.querySelectorAll('video,canvas').forEach(el=>el.remove());
  document.getElementById('sc-ph').style.display='flex';
}
function updateConf(conf){
  const p=Math.round(conf*100);
  document.getElementById('conf-fill').style.width=p+'%';
  document.getElementById('conf-fill').style.background=conf>.88?'var(--success)':conf>.70?'var(--warning)':'var(--rose2)';
  document.getElementById('conf-pct').textContent=p+'%';
}

// ‚îÄ‚îÄ‚îÄ SAVE ENTRY ‚îÄ‚îÄ‚îÄ
async function saveEntry(){
  if(currentUser&&currentUser.role==='leader'){showFb('‚ö† Los l√≠deres no pueden registrar entradas','error');return;}
  const imei1=document.getElementById('f-imei1').value.trim();
  if(!imei1){showFb('‚ö† IMEI 1 es obligatorio','error');return;}

  // Bloquear si IMEI ya est√° en stock activo
  const existing=inv.find(r=>String(r.imei1).trim()===imei1);
  if(existing&&(String(existing.stock)==='1'||existing.stock===1)){
    showFb('‚ö† Este IMEI ya est√° en stock activo. Reg√≠stralo como salida primero.','error');return;
  }

  const color=document.getElementById('f-color').value||selColor;
  const now=new Date();
  const date=now.toLocaleDateString('es-MX');
  const time=now.toLocaleTimeString('es-MX',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  const row={
    imei1,imei2:document.getElementById('f-imei2').value.trim(),
    serial:document.getElementById('f-serial').value.trim(),
    platform:selPlat,brand:document.getElementById('f-brand').value,
    model:getModel(),color,storage:document.getElementById('f-storage').value,
    price:document.getElementById('f-price').value.trim(),
    status:document.getElementById('f-status').value,
    notes:document.getElementById('f-notes').value.trim(),
    date,time,store:currentUser.store||'Admin',
    photoLocal:photoData||null,photoUrl:'',stock:'1',
    syncStatus:'pending',fresh:true
  };
  const m={type:'ENTRADA',store:row.store,imei1,brand:row.brand,model:row.model,
    color,storage:row.storage,price:row.price,status:row.status,date,time,notes:row.notes};

  // Update or insert locally
  const idx=inv.findIndex(r=>String(r.imei1).trim()===imei1);
  if(idx>-1)inv[idx]={...row,fresh:true};
  else inv.unshift(row);
  mov.unshift(m);
  saveData();renderTables();updateStats();
  showFb('üì§ Guardando en Sheets...','pending');

  const targetRow=inv.find(r=>String(r.imei1).trim()===imei1)||row;
  await syncEntry(targetRow);
  if(photoData&&scriptUrl){
    showFb('üñº Subiendo foto a Drive...','pending');
    await uploadPhoto(targetRow);
  }
  showFb('‚úÖ Entrada registrada correctamente','success');
  resetAll();
}

// ‚îÄ‚îÄ‚îÄ CONFIRM EXIT ‚îÄ‚îÄ‚îÄ
async function confirmExit(){
  if(currentUser&&currentUser.role==='leader'){showFb('‚ö† Los l√≠deres no pueden registrar salidas','error');return;}
  const imei1=document.getElementById('exit-imei').value.trim();
  if(!imei1){showFb('‚ö† Escanea o escribe el IMEI','error');return;}
  let item=inv.find(r=>String(r.imei1).trim()===imei1);
  if(!item){
    showFb('‚ü≥ Sincronizando con Sheets...','pending');
    await loadFromSheets();
    item=inv.find(r=>String(r.imei1).trim()===imei1);
  }
  if(!item){showFb('‚úó IMEI no encontrado en inventario','error');return;}
  if(String(item.stock)==='0'||item.stock===0){showFb('‚ö† Ya tiene salida registrada','error');return;}

  const salePrice=document.getElementById('exit-price').value.trim();
  if(!salePrice||parseFloat(salePrice)<=0){showFb('‚ö† Ingresa el precio de venta','error');return;}
  const notes=document.getElementById('exit-notes').value.trim();
  const now=new Date();
  const date=now.toLocaleDateString('es-MX');
  const time=now.toLocaleTimeString('es-MX',{hour:'2-digit',minute:'2-digit',second:'2-digit'});

  item.stock='0';
  const m={type:'SALIDA',store:currentUser.store||'Admin',imei1,
    brand:item.brand,model:item.model,color:item.color,
    storage:item.storage,price:item.price,salePrice,status:item.status,date,time,notes};
  mov.unshift(m);saveData();renderTables();updateStats();
  showFb('üì§ Registrando salida en Sheets...','pending');

  if(scriptUrl){
    try{
      const res=await fetch(scriptUrl,{method:'POST',
        body:JSON.stringify({action:'exit',imei1,store:currentUser.store||'Admin',role:currentUser.role,date,time,notes,salePrice}),
        headers:{'Content-Type':'text/plain'}});
      const text=await res.text();
      let d;try{d=JSON.parse(text);}catch(e){d={success:false,error:'Respuesta inv√°lida'};}
      showFb(d.success?'‚úÖ Salida registrada en Sheets y Movimientos':'‚ö† Local OK ‚Äî error Sheets: '+d.error,d.success?'success':'error');
      if(!d.success)console.error('Exit:',d.error,text);
    }catch(e){showFb('‚ö† Salida guardada localmente. Sin conexi√≥n.','error');console.error(e);}
  }else showFb('‚úÖ Salida guardada localmente','success');

  document.getElementById('exit-imei').value='';
  document.getElementById('exit-price').value='';
  document.getElementById('exit-notes').value='';
  document.getElementById('exit-result').className='exit-result';
  showTab('mov');
}

// ‚îÄ‚îÄ‚îÄ SYNC ‚îÄ‚îÄ‚îÄ
function saveData(){
  try{LS.setItem('inv_v6',JSON.stringify(inv.map(r=>({...r,photoLocal:null}))));LS.setItem('mov_v6',JSON.stringify(mov));}catch(e){}
}
async function syncEntry(row){
  if(!scriptUrl){row.syncStatus='pending';saveData();updateQueueBar();return;}
  row.syncStatus='sending';renderTables();
  try{
    const p={action:'entry',...row,photoLocal:undefined,photoUrl:row.photoUrl||''};
    const res=await fetch(scriptUrl,{method:'POST',body:JSON.stringify(p),headers:{'Content-Type':'text/plain'}});
    const text=await res.text();
    let d;try{d=JSON.parse(text);}catch(e){d={success:false,error:'No JSON: '+text.substring(0,60)};}
    row.syncStatus=d.success?'synced':'error';
    setSP(d.success?'ok':'err',d.success?'‚úì Guardado':'‚úó Error');
    if(!d.success)console.error('syncEntry:',d.error,text);
  }catch(e){row.syncStatus='pending';setSP('err','‚úó Sin red');console.error(e);}
  saveData();renderTables();updateQueueBar();
}
async function uploadPhoto(row){
  if(!row.photoLocal||!scriptUrl)return;
  if(!row.photoLocal.startsWith('data:image')){
    showFb('‚ö† Foto inv√°lida ‚Äî no tiene formato correcto','error');
    console.error('Photo invalid format, starts with:',row.photoLocal.substring(0,30));
    return;
  }
  const sizeKB=Math.round(row.photoLocal.length*0.75/1024);
  console.log('Enviando foto al Drive, tama√±o ~'+sizeKB+'KB');
  if(sizeKB>1500){
    showFb('‚ö† Foto muy grande ('+sizeKB+'KB). Intenta con una imagen m√°s peque√±a.','error');
    return;
  }
  showFb('üñº Subiendo foto ('+sizeKB+'KB)...','pending');
  try{
    const payload={
      action:'save_photo',
      imei1:String(row.imei1),
      photoBase64:row.photoLocal,
      store:String(row.store||'Admin'),
      filename:String(row.imei1)+'_'+Date.now()+'.jpg'
    };
    const bodyStr=JSON.stringify(payload);
    console.log('Payload size:',Math.round(bodyStr.length/1024),'KB');
    const res=await fetch(scriptUrl,{
      method:'POST',
      body:bodyStr,
      headers:{'Content-Type':'text/plain'}
    });
    const text=await res.text();
    console.log('Drive response:',text.substring(0,200));
    let d;
    try{d=JSON.parse(text);}
    catch(e){
      showFb('‚ö† Error foto: respuesta no v√°lida del servidor','error');
      console.error('Photo response parse error. Raw:',text);
      return;
    }
    if(d.success){
      row.photoUrl=d.photoUrl;
      row.photoLocal=null;
      saveData();renderTables();
      showFb('üì∏ Foto guardada en Drive ‚úì','success');
      console.log('Photo URL:',d.photoUrl);
    } else {
      showFb('‚ö† Error Drive: '+d.error,'error');
      console.error('Drive error:',d.error);
    }
  }catch(e){
    showFb('‚ö† Error de red al subir foto','error');
    console.error('uploadPhoto network error:',e);
  }
}
async function retrySyncAll(){
  const p=inv.filter(r=>r.syncStatus==='pending'||r.syncStatus==='error');
  for(const r of p)await syncEntry(r);
  const np=inv.filter(r=>r.photoLocal&&!r.photoUrl);
  for(const r of np)await uploadPhoto(r);
}
function updateQueueBar(){
  const n=inv.filter(r=>r.syncStatus==='pending'||r.syncStatus==='error').length;
  document.getElementById('q-count').textContent=n;
  document.getElementById('queue-bar').classList.toggle('hidden',n===0);
}

// ‚îÄ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ
function updateStats(){
  const s=inv.filter(r=>String(r.stock)==='1'||r.stock===1).length;
  const o=inv.filter(r=>String(r.stock)==='0'||r.stock===0).length;
  document.getElementById('cnt-stock').textContent=s;
  document.getElementById('cnt-out').textContent=o;
  document.getElementById('cnt-total').textContent=inv.length;
}
function renderTables(){
  updateStats();
  const si=s=>s==='synced'?'<span style="color:var(--success)">‚úì</span>':s==='sending'?'<span class="spin">‚ü≥</span>':s==='error'?'<span style="color:var(--rose2)">‚úó</span>':'<span style="color:var(--warning)">‚è≥</span>';
  const isAdmin=currentUser&&currentUser.role==='admin';
  // INV
  const tbi=document.getElementById('tb-inv');
  if(!inv.length){tbi.innerHTML=`<tr><td colspan="12"><div class="empty-state"><div class="big">üì±</div><p>Sin equipos registrados</p></div></td></tr>`;return;}
  tbi.innerHTML=inv.map((r,i)=>`<tr class="${r.fresh?'nr':''}">
    <td style="color:var(--muted);font-size:10px;font-family:'JetBrains Mono',monospace">${inv.length-i}</td>
    <td>${r.photoUrl?`<img src="${r.photoUrl}" class="pt" onerror="this.style.display='none'">`:r.photoLocal?`<img src="${r.photoLocal}" class="pt">`:'‚Äî'}</td>
    <td><span class="store-tag">${r.store||'‚Äî'}</span></td>
    <td class="imei-c">${r.imei1}</td>
    <td style="font-size:12px">${r.brand||'‚Äî'}</td>
    <td style="font-size:12px;max-width:90px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${r.model||''}">${r.model||'‚Äî'}</td>
    <td style="font-size:11px">${r.color||'‚Äî'}</td>
    <td style="font-family:'JetBrains Mono',monospace;font-size:11px">${r.storage||'‚Äî'}</td>
    <td style="font-family:'JetBrains Mono',monospace;font-size:11px">${r.price?'$'+parseFloat(r.price).toFixed(2):'‚Äî'}</td>
    <td><span class="${(String(r.stock)==='1'||r.stock===1)?'s1':'s0'}">${(String(r.stock)==='1'||r.stock===1)?'‚úì Disp':'‚úó Baja'}</span></td>
    <td>${si(r.syncStatus)}</td>
    ${isAdmin?`<td><button class="del-btn" onclick="openDeleteModal('${r.imei1}')">üóë Eliminar</button></td>`:''}
  </tr>`).join('');
  inv.forEach(r=>r.fresh=false);
  // MOV
  const tbm=document.getElementById('tb-mov');
  const fStore=document.getElementById('f-store')?.value||'';
  const fType=document.getElementById('f-type')?.value||'';
  let fm=mov;
  if(fStore)fm=fm.filter(r=>r.store===fStore);
  if(fType)fm=fm.filter(r=>r.type&&r.type.includes(fType));
  if(!fm.length){tbm.innerHTML=`<tr><td colspan="12"><div class="empty-state"><div class="big">üìã</div><p>Sin movimientos</p></div></td></tr>`;updateQueueBar();return;}
  tbm.innerHTML=fm.map((r,i)=>`<tr>
    <td style="color:var(--muted);font-size:10px;font-family:'JetBrains Mono',monospace">${fm.length-i}</td>
    <td><span class="store-tag">${r.store||'‚Äî'}</span></td>
    <td><span class="${r.type&&r.type.includes('ENTRADA')?'badge-in':'badge-out'}">${r.type&&r.type.includes('ENTRADA')?'‚úÖ ENTRADA':'üî¥ SALIDA'}</span></td>
    <td class="imei-c">${r.imei1||'‚Äî'}</td>
    <td style="font-size:12px">${r.brand||'‚Äî'}</td>
    <td style="font-size:12px">${r.model||'‚Äî'}</td>
    <td style="font-family:'JetBrains Mono',monospace;font-size:11px">${r.price?'$'+parseFloat(r.price).toFixed(2):'‚Äî'}</td>
    <td style="font-family:'JetBrains Mono',monospace;font-size:11px;color:${r.salePrice?'var(--success)':'var(--muted)'}">${r.salePrice?'$'+parseFloat(r.salePrice).toFixed(2):'‚Äî'}</td>
    <td style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--muted)">${r.date||'‚Äî'}</td>
    <td style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--muted)">${r.time||'‚Äî'}</td>
    <td style="font-size:11px;color:var(--muted)">${r.notes||'‚Äî'}</td>
    ${isAdmin?`<td><button class="del-btn" onclick="openDeleteMovModal(${mov.indexOf(r)})">üóë</button></td>`:''}
  </tr>`).join('');
  updateQueueBar();
}
function showTab(t){
  curTab=t;
  ['inv','mov','rep'].forEach(x=>{
    // Solo toggle clase active en el bot√≥n, sin tocar su display (lo controla showApp)
    document.getElementById('tab-'+x)?.classList.toggle('active',x===t);
    // Solo ocultar/mostrar el panel de contenido (tw-*), no el bot√≥n (tab-*)
    const el=document.getElementById('tw-'+x);if(el)el.style.display=x===t?'block':'none';
  });
  if(t==='rep')loadFromSheets().then(()=>renderReports());
}
function showTabBtn(id,visible){
  const el=document.getElementById(id);if(el)el.style.display=visible?'block':'none';
}
function renderReports(){
  // Obtener tiendas din√°micamente de los datos reales + lista base
  const baseStores=['Tienda 1','Tienda 2','Tienda 3','Tienda 4','Tienda 5','Tienda 6','Tienda 7'];
  const dynStores=[...new Set([...baseStores,...inv.map(r=>r.store),...mov.map(r=>r.store)].filter(s=>s&&s!=='null'&&s!=='undefined'))].sort();
  const stores=dynStores.length?dynStores:baseStores;
  const ts=inv.filter(r=>String(r.stock)==='1'||r.stock===1).length;
  const to=inv.filter(r=>String(r.stock)==='0'||r.stock===0).length;
  const te=mov.filter(r=>r.type&&r.type.includes('ENTRADA')).length;
  const tx=mov.filter(r=>r.type&&r.type.includes('SALIDA')).length;
  let html=`
  <div class="rep-section-title">Resumen Global</div>
  <div class="rep-grid">
    <div class="stat-card"><div class="sc-val" style="color:var(--success)">${ts}</div><div class="sc-lbl">üì¶ En Stock</div></div>
    <div class="stat-card"><div class="sc-val" style="color:var(--rose2)">${to}</div><div class="sc-lbl">üî¥ Salidas</div></div>
    <div class="stat-card"><div class="sc-val" style="color:var(--purple3)">${te}</div><div class="sc-lbl">‚úÖ Entradas</div></div>
    <div class="stat-card"><div class="sc-val" style="color:var(--warning)">${mov.length}</div><div class="sc-lbl">üìã Movimientos</div></div>
  </div>
  <div class="rep-section-title">Por Tienda</div>
  <div class="store-grid">`;
  stores.forEach(store=>{
    const si=inv.filter(r=>r.store===store);
    const ss=si.filter(r=>String(r.stock)==='1'||r.stock===1).length;
    const so=si.filter(r=>String(r.stock)==='0'||r.stock===0).length;
    const se=mov.filter(r=>r.store===store&&r.type&&r.type.includes('ENTRADA')).length;
    const sx=mov.filter(r=>r.store===store&&r.type&&r.type.includes('SALIDA')).length;
    html+=`<div class="store-card">
      <div class="store-card-name"><span>üè™</span><span style="background:var(--grad-mix);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-size:15px">${store}</span></div>
      <div class="store-stats">
        <div class="ss-item" style="background:rgba(168,213,181,.08)"><div class="ss-n" style="color:var(--success)">${ss}</div><div class="ss-l">En Stock</div></div>
        <div class="ss-item" style="background:rgba(227,145,145,.08)"><div class="ss-n" style="color:var(--rose2)">${so}</div><div class="ss-l">Salidas</div></div>
        <div class="ss-item" style="background:rgba(180,167,214,.08)"><div class="ss-n" style="color:var(--purple3)">${se}</div><div class="ss-l">Entradas</div></div>
        <div class="ss-item" style="background:rgba(232,200,130,.08)"><div class="ss-n" style="color:var(--warning)">${sx}</div><div class="ss-l">Movim.</div></div>
      </div>
    </div>`;
  });
  html+='</div>';
  document.getElementById('rep-content').innerHTML=html;
}
function resetAll(){
  sv={imei1:'',imei2:'',serial:''};currentStep=1;updateStepUI();selColor='';photoData=null;selPlat='';
  ['f-imei1','f-imei2','f-serial','f-price','f-notes'].forEach(id=>{const el=document.getElementById(id);if(el){el.value='';el.classList.remove('fc-ok');}});
  document.getElementById('f-brand').value='';
  document.getElementById('f-model').innerHTML='<option value="">‚Äî Selecciona marca ‚Äî</option><option value="__m__">‚úèÔ∏è Escribir manualmente...</option>';
  document.getElementById('f-model').disabled=true;
  document.getElementById('f-model-m').style.display='none';document.getElementById('f-model-m').value='';
  document.getElementById('f-color').innerHTML='<option value="">‚Äî</option>';
  document.getElementById('color-sw').innerHTML='';
  document.getElementById('f-storage').value='';document.getElementById('f-status').value='Nuevo';
  document.getElementById('photo-img').style.display='none';document.getElementById('photo-img').src='';
  document.getElementById('no-photo').style.display='flex';
  document.getElementById('photo-input').value='';document.getElementById('gallery-input').value='';
  document.getElementById('btn-ios').className='plat-btn';document.getElementById('btn-android').className='plat-btn';
}
function showFb(msg,type,duration){
  // Old inline feedback
  const el=document.getElementById('feedback');
  if(el){el.className='feedback '+type;el.textContent=msg;clearTimeout(el._t);if(msg)el._t=setTimeout(()=>el.className='feedback',6000);}
  // Center toast
  showToast(msg,type,duration||4000);
}
function showToast(msg,type,ms){
  if(!msg)return;
  const con=document.getElementById('toast-container');
  const t=document.createElement('div');
  t.className='toast t-'+(type||'info');
  const icon={success:'‚úÖ',error:'‚ùå',pending:'‚è≥',info:'‚ÑπÔ∏è',notif:'üîî'}[type]||'üì¢';
  t.innerHTML=icon+' <span>'+msg+'</span>';
  con.appendChild(t);
  const dur=ms||4000;
  const rm=()=>{t.style.animation='none';t.style.opacity='0';t.style.transform='scale(.85)';t.style.transition='all .25s ease';setTimeout(()=>t.remove(),260);};
  t._to=setTimeout(rm,dur);
  t.onclick=()=>{clearTimeout(t._to);rm();};
}
// Notificacion destacada para movimientos de otras tiendas
function showMovNotif(store,type,brand,model){
  const con=document.getElementById('toast-container');
  const t=document.createElement('div');
  t.className='toast t-notif';
  const ico=type.includes('ENTRADA')?'üì¶':'üì§';
  t.innerHTML=ico+' <span><strong>'+store+'</strong> registr√≥ '+type.toLowerCase()+': '+brand+' '+model+'</span>';
  con.appendChild(t);
  setTimeout(()=>{t.style.opacity='0';t.style.transition='all .3s';setTimeout(()=>t.remove(),300);},5000);
}
function setSP(state,text){
  const p=document.getElementById('sync-pill');
  const cls={ok:'sp-ok',send:'sp-send',err:'sp-err',idle:'sp-idle'};
  p.className='sync-pill '+(cls[state]||'sp-idle');
  p.innerHTML=state==='send'?`<span class="spin">‚ü≥</span> ${text}`:text;
}
function exportCSV(){
  const isInv=curTab==='inv';const data=isInv?inv:mov;
  if(!data.length){showFb('No hay datos','error');return;}
  let h,b;
  if(isInv){h=['#','Tienda','IMEI1','IMEI2','Serial','Plataforma','Marca','Modelo','Color','GB','Precio','Estado','Fecha','Stock','FotoURL'];b=data.map((r,i)=>[data.length-i,r.store||'',r.imei1,r.imei2||'',r.serial||'',r.platform||'',r.brand||'',`"${r.model||''}"`,r.color||'',r.storage||'',r.price||'',r.status||'',r.date,r.stock,r.photoUrl||''].join(','));}
  else{h=['#','Tienda','Tipo','IMEI1','Marca','Modelo','GB','Precio','Estado','Fecha','Hora','Notas'];b=data.map((r,i)=>[data.length-i,r.store||'',r.type,r.imei1,r.brand||'',`"${r.model||''}"`,r.storage||'',r.price||'',r.status||'',r.date,r.time,`"${r.notes||''}"`].join(','));}
  const blob=new Blob([[h.join(','),...b].join('\n')],{type:'text/csv;charset=utf-8;'});
  Object.assign(document.createElement('a'),{href:URL.createObjectURL(blob),download:`${isInv?'inventario':'movimientos'}_${new Date().toISOString().slice(0,10)}.csv`}).click();
}
function openClearModal(){document.getElementById('modal-clear').classList.add('open');}
function closeModal(id){document.getElementById(id).classList.remove('open');}
function clearAll(){inv=[];mov=[];saveData();renderTables();closeModal('modal-clear');}

// ‚îÄ‚îÄ‚îÄ ELIMINAR IMEI (admin) ‚îÄ‚îÄ‚îÄ
let pendingDeleteImei='';
function openDeleteModal(imei1){
  pendingDeleteImei=imei1;
  document.getElementById('modal-del-txt').textContent='Se eliminar√° el IMEI '+imei1+' del inventario. Los movimientos en Sheets se conservan.';
  document.getElementById('modal-del').classList.add('open');
}
async function confirmDelete(){
  closeModal('modal-del');
  if(!pendingDeleteImei)return;
  const imei1=pendingDeleteImei;
  const idx=inv.findIndex(r=>String(r.imei1).trim()===imei1);
  if(idx>-1)inv.splice(idx,1);
  saveData();renderTables();updateStats();
  showFb('üóë Eliminando de Sheets...','pending');
  if(scriptUrl){
    try{
      const res=await fetch(scriptUrl,{method:'POST',body:JSON.stringify({action:'delete_imei',imei1,role:currentUser.role}),headers:{'Content-Type':'text/plain'}});
      const text=await res.text();
      let d;try{d=JSON.parse(text);}catch(e){d={success:false,error:'Respuesta inv√°lida'};}
      showFb(d.success?'‚úÖ IMEI eliminado. Puede re-ingresarse.':'‚ö† Eliminado local, error Sheets: '+d.error,d.success?'success':'error');
    }catch(e){showFb('‚ö† Eliminado localmente. Sin conexi√≥n.','error');}
  }else showFb('‚úÖ Eliminado localmente','success');
}

// ‚îÄ‚îÄ‚îÄ ELIMINAR MOVIMIENTO (admin) ‚îÄ‚îÄ‚îÄ
let pendingDeleteMovIdx=-1;
function openDeleteMovModal(globalIdx){
  pendingDeleteMovIdx=globalIdx;
  const r=mov[globalIdx];
  if(!r)return;
  const tipo=r.type&&r.type.includes('ENTRADA')?'ENTRADA':'SALIDA';
  document.getElementById('modal-del-mov-txt').textContent=
    'Eliminar movimiento '+tipo+' del IMEI '+r.imei1+' ('+r.date+' '+r.time+'). Se borrar√° de Sheets tambi√©n.';
  document.getElementById('modal-del-mov').classList.add('open');
}
async function confirmDeleteMov(){
  closeModal('modal-del-mov');
  if(pendingDeleteMovIdx<0)return;
  const r=mov[pendingDeleteMovIdx];
  if(!r)return;
  mov.splice(pendingDeleteMovIdx,1);
  pendingDeleteMovIdx=-1;
  saveData();renderTables();
  showFb('üóë Eliminando movimiento de Sheets...','pending');
  if(scriptUrl){
    try{
      const res=await fetch(scriptUrl,{method:'POST',body:JSON.stringify({action:'delete_mov',imei1:r.imei1,date:r.date,time:r.time,type:r.type,role:currentUser.role}),headers:{'Content-Type':'text/plain'}});
      const text=await res.text();
      let d;try{d=JSON.parse(text);}catch(e){d={success:false,error:'Respuesta inv√°lida'};}
      showFb(d.success?'‚úÖ Movimiento eliminado correctamente':'‚ö† Eliminado local, error Sheets: '+d.error,d.success?'success':'error');
    }catch(e){showFb('‚ö† Eliminado localmente. Sin conexi√≥n.','error');}
  }else showFb('‚úÖ Movimiento eliminado localmente','success');
}


// ‚îÄ‚îÄ‚îÄ BULK IMPORT (Excel / CSV) ‚îÄ‚îÄ‚îÄ
let bulkRows=[];
function openBulkModal(){document.getElementById('modal-bulk').classList.add('open');}
function onBulkDrop(e){e.preventDefault();e.currentTarget.style.borderColor='var(--border)';const f=e.dataTransfer.files[0];if(f)processBulkFile(f);}
function onBulkFile(e){const f=e.target.files[0];if(f)processBulkFile(f);}
function processBulkFile(file){
  document.getElementById('bulk-file-name').textContent=file.name;
  const reader=new FileReader();
  reader.onload=function(e){
    const data=new Uint8Array(e.target.result);
    let rows=[];
    if(file.name.toLowerCase().endsWith('.csv')){
      const text=new TextDecoder('utf-8').decode(data);
      rows=parseCSV(text);
    } else {
      // XLSX via SheetJS
      try{
        const wb=XLSX.read(data,{type:'array'});
        const ws=wb.Sheets[wb.SheetNames[0]];
        rows=XLSX.utils.sheet_to_json(ws,{defval:''});
      }catch(ex){
        showFb('‚ö† Error leyendo Excel: '+ex.message,'error');return;
      }
    }
    if(!rows.length){showFb('‚ö† No se encontraron filas en el archivo','error');return;}
    bulkRows=rows.map(r=>normalizeBulkRow(r)).filter(r=>r.imei1&&r.imei1.length>=14);
    renderBulkPreview();
  };
  reader.readAsArrayBuffer(file);
}
function normalizeBulkRow(r){
  // Acepta columnas en espa√±ol o ingl√©s, case-insensitive
  const g=(keys)=>{for(const k of keys){for(const rk of Object.keys(r)){if(rk.toLowerCase().replace(/[_ ]/g,'')===k.toLowerCase().replace(/[_ ]/g,'')){return String(r[rk]||'').trim();}}}return '';};
  return {
    imei1:g(['imei1','imei','imei_1']),
    imei2:g(['imei2','imei_2']),
    serial:g(['serial','serialnumber','numero_serie']),
    brand:g(['marca','brand']),
    model:g(['modelo','model']),
    color:g(['color']),
    storage:g(['gb','storage','almacenamiento','capacidad']),
    price:g(['precio','price']),
    status:g(['estado','status'])||'Nuevo',
    notes:g(['notas','notes','observaciones']),
  };
}
function parseCSV(text){
  const lines=text.split(/\r?\n/).filter(l=>l.trim());
  if(lines.length<2)return [];
  const headers=lines[0].split(',').map(h=>h.replace(/"/g,'').trim());
  return lines.slice(1).map(line=>{
    const vals=line.split(',').map(v=>v.replace(/"/g,'').trim());
    const obj={};headers.forEach((h,i)=>obj[h]=vals[i]||'');
    return obj;
  });
}
function renderBulkPreview(){
  if(!bulkRows.length){document.getElementById('bulk-status').textContent='No se encontraron filas con IMEI v√°lido';document.getElementById('bulk-import-btn').disabled=true;return;}
  const cols=['imei1','imei2','brand','model','color','storage','price'];
  document.getElementById('bulk-thead').innerHTML='<tr>'+cols.map(c=>'<th style="padding:6px 8px;background:var(--surface2);color:var(--muted);font-size:10px">'+c+'</th>').join('')+'</tr>';
  document.getElementById('bulk-tbody').innerHTML=bulkRows.slice(0,8).map(r=>'<tr>'+cols.map(c=>'<td style="padding:5px 8px;font-size:11px">'+escape(String(r[c]||'‚Äî'))+'</td>').join('')+'</tr>').join('');
  document.getElementById('bulk-preview').style.display='block';
  document.getElementById('bulk-status').textContent='‚úÖ '+bulkRows.length+' equipos listos para importar'+(bulkRows.length>8?' (mostrando 8)':'');
  document.getElementById('bulk-import-btn').disabled=false;
}
async function doBulkImport(){
  if(!bulkRows.length)return;
  closeModal('modal-bulk');
  const total=bulkRows.length;
  let ok=0,dup=0,err=0;
  const now=new Date();
  const date=now.toLocaleDateString('es-MX');
  const time=now.toLocaleTimeString('es-MX',{hour:'2-digit',minute:'2-digit'});
  for(let i=0;i<bulkRows.length;i++){
    const r=bulkRows[i];
    showFb('üìä Importando '+(i+1)+'/'+total+': '+r.imei1,'pending');
    const existing=inv.find(ex=>String(ex.imei1).trim()===r.imei1);
    if(existing&&(String(existing.stock)==='1'||existing.stock===1)){dup++;continue;}
    const platform=r.brand&&(r.brand.toLowerCase().includes('apple')||r.brand.toLowerCase().includes('iphone'))?'iOS':'Android';
    const row={
      imei1:r.imei1,imei2:r.imei2||'',serial:r.serial||'',
      platform,brand:r.brand||'',model:r.model||'',color:r.color||'',
      storage:r.storage||'',price:r.price||'',status:r.status||'Nuevo',
      notes:r.notes||'',date,time,
      store:currentUser.store||'Admin',
      photoLocal:null,photoUrl:'',stock:'1',
      syncStatus:'pending',fresh:true
    };
    inv.unshift(row);
    const m={type:'ENTRADA',store:row.store,imei1:row.imei1,brand:row.brand,model:row.model,color:row.color,storage:row.storage,price:row.price,status:row.status,date,time,notes:'Ingreso masivo'};
    mov.unshift(m);
    ok++;
    if(scriptUrl){
      try{
        const res=await fetch(scriptUrl,{method:'POST',body:JSON.stringify({action:'entry',...row}),headers:{'Content-Type':'text/plain'}});
        const txt=await res.text();
        let d;try{d=JSON.parse(txt);}catch(ex){d={success:false};}
        row.syncStatus=d.success?'synced':'error';
        if(d.success)ok++;
      }catch(ex){row.syncStatus='error';err++;}
    }
    saveData();
    if(i%5===0)renderTables();
    await new Promise(r2=>setTimeout(r2,120)); // peque√±a pausa para no saturar
  }
  renderTables();
  showFb('üìä Importaci√≥n completa: '+ok+' guardados, '+dup+' duplicados omitidos'+(err?' '+err+' errores':''),'success',7000);
  bulkRows=[];
  document.getElementById('bulk-file').value='';
  document.getElementById('bulk-file-name').textContent='';
  document.getElementById('bulk-preview').style.display='none';
  document.getElementById('bulk-import-btn').disabled=true;
}

// ‚îÄ‚îÄ‚îÄ POLLING NOTIFICACIONES ‚îÄ‚îÄ‚îÄ
let lastMovCount=0;
let notifInterval=null;
function startNotifPolling(){
  if(notifInterval)return;
  lastMovCount=mov.length;
  notifInterval=setInterval(async()=>{
    if(!scriptUrl||!currentUser)return;
    try{
      const url=scriptUrl+'?action=get_data&role=admin&store=&ts='+Date.now();
      const res=await fetch(url);
      const data=await res.json();
      if(!data.success)return;
      const fresh=data.movements;
      if(fresh.length>lastMovCount){
        const newMov=fresh.slice(0,fresh.length-lastMovCount);
        newMov.forEach(m=>{
          // Solo notificar movimientos de otras tiendas
          if(m.store&&m.store!==(currentUser.store||'Admin')){
            showMovNotif(m.store,m.type||'MOVIMIENTO',m.brand||'',m.model||'');
          }
        });
        // Actualizar datos locales
        inv=data.inventory.map(r=>({...r,syncStatus:'synced',fresh:false}));
        mov=data.movements.map((r,i)=>({...r,id:i}));
        saveData();renderTables();
        lastMovCount=fresh.length;
      }
    }catch(e){}
  },30000); // cada 30 segundos
}
function stopNotifPolling(){
  if(notifInterval){clearInterval(notifInterval);notifInterval=null;}
}
// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ
if(scriptUrl)document.getElementById('url-inp').value=scriptUrl;
// Limpiar cach√© vieja de versiones anteriores
try{if(LS.getItem('inv_v5')){LS.removeItem('inv_v5');LS.removeItem('mov_v5');}}catch(e){}
if(currentUser&&scriptUrl&&scriptUrl.includes('/exec')){showApp();loadFromSheets().then(()=>{startNotifPolling();});}
else{currentUser=null;try{LS.removeItem('imei_user');}catch(e){}}
</script>
</body>
</html>
